<div class="drug-strength-rounding-container">
  <div class="header">
    <h3>
      Drug Strength Rounding Rules
      <button mat-icon-button color="primary" [matMenuTriggerFor]="infoMenu">
        <mat-icon>info</mat-icon>
      </button>
      <mat-menu #infoMenu="matMenu">
        <span mat-menu-item [disableRipple]="true" (click)="$event.stopPropagation()" class="long-tooltip">
          <h4>Drug Strength Rounding Rules</h4>
          <p>This demonstration shows how drug strength calculations are rounded based on significant figures and whether the fraction terminates.</p>
          <p>
            This demonstration is based on the SQL script implementation of drug strength rounding rules.
            The JavaScript implementation in this component is a translation of the original SQL functions.
          </p>
          <p>
            <strong>Author:</strong> Francois Lavoie, Canada
          </p>
          <p>
            <strong>Original SQL Script:</strong>
            <a 
              href="assets/drug-strength-rounding-rules/Function Rounding rules function.sql" 
              download="Function Rounding rules function.sql"
              class="download-link"
              (click)="$event.stopPropagation()">
              <mat-icon>download</mat-icon>
              Download SQL Script
            </a>
          </p>
        </span>
      </mat-menu>
    </h3>
  </div>

  <div class="content">
    <!-- Input Section -->
    <mat-card class="input-card">
      <mat-card-header>
        <mat-card-title>Calculate Rounding</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="input-section">
          <mat-form-field appearance="fill" class="input-field">
            <mat-label>Numerator</mat-label>
            <input matInput [(ngModel)]="numerator" (input)="calculate()" placeholder="Enter numerator">
          </mat-form-field>

          <div class="division-symbol">/</div>

          <mat-form-field appearance="fill" class="input-field">
            <mat-label>Denominator</mat-label>
            <input matInput [(ngModel)]="denominator" (input)="calculate()" placeholder="Enter denominator">
          </mat-form-field>

          <button mat-raised-button color="primary" (click)="calculate()" class="calculate-button">
            Calculate
          </button>
          <button mat-button (click)="clear()" class="clear-button">
            Clear
          </button>
        </div>

        @if (result) {
          <div class="result-section">
            <h4>Results</h4>
            <div class="result-grid">
              <div class="result-item">
                <span class="result-label">Raw Result:</span>
                <span class="result-value">{{ result.rawResult }}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Rounded Result:</span>
                <span class="result-value highlighted">{{ result.roundedResult }}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Sig Figs (Numerator):</span>
                <span class="result-value">{{ result.sigFigsNumerator }}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Sig Figs (Denominator):</span>
                <span class="result-value">{{ result.sigFigsDenominator }}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Min Sig Figs:</span>
                <span class="result-value">{{ result.sigFigsMin }}</span>
              </div>
              <div class="result-item">
                <span class="result-label">Is Terminating:</span>
                <span class="result-value">{{ result.isTerminating ? 'Yes' : 'No' }}</span>
              </div>
              <div class="result-item full-width">
                <span class="result-label">Rule Applied:</span>
                <span class="result-value rule-text">{{ result.rule }}</span>
              </div>
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Examples Section -->
    <mat-card class="examples-card">
      <mat-card-header>
        <mat-card-title>Pre-made Examples</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p class="examples-description">Click on any example to load it into the calculator:</p>
        <div class="examples-grid">
          @for (example of examples; track example) {
            <button 
              mat-stroked-button 
              class="example-button"
              [class.active]="numerator === example.numerator && denominator === example.denominator"
              (click)="loadExample(example)">
              <div class="example-fraction">{{ example.numerator }} / {{ example.denominator }}</div>
              <div class="example-description">{{ example.description }}</div>
            </button>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Explanation Section -->
    <mat-card class="explanation-card">
      <mat-card-header>
        <mat-card-title>Rounding Rules Explanation</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="explanation-content">
          <h4>Overview</h4>
          <p>
            Drug strength calculations require careful rounding to maintain precision while avoiding false precision.
            The rounding rules depend on whether the fraction terminates (has a finite decimal representation) or not.
          </p>

          <h4>Key Rules</h4>
          <div class="rules-list">
            <div class="rule-item">
              <strong>1. Terminating Fractions:</strong>
              <p>
                If the fraction terminates (denominator only has factors 2 and 5 after reduction), 
                use the exact result with the minimum number of significant figures from the numerator and denominator.
              </p>
              <div class="example-box">
                <strong>Example:</strong> 1/2 = 0.5 (exact, no rounding needed)
              </div>
            </div>

            <div class="rule-item">
              <strong>2. Non-Terminating Fractions:</strong>
              <p>
                If the fraction does not terminate, round to p+1 significant figures where p is the minimum 
                significant figures from the numerator and denominator. This includes a guard digit for precision.
              </p>
              <div class="example-box">
                <strong>Example:</strong> 1/3 = 0.333... â†’ rounded to p+1 sig figs with trailing zeros if needed
              </div>
            </div>

            <div class="rule-item">
              <strong>3. Significant Figures Counting:</strong>
              <p>
                All digits in a number are significant, including:
              </p>
              <ul>
                <li>All non-zero digits</li>
                <li>Zeros between non-zero digits</li>
                <li>Trailing zeros in numbers with decimal points</li>
                <li>All digits in scientific notation</li>
              </ul>
            </div>

            <div class="rule-item">
              <strong>4. Trailing Zero Padding:</strong>
              <p>
                For non-terminating fractions, if the result has fewer significant figures than desired (p+1), 
                pad with trailing zeros to reach the required precision.
              </p>
            </div>
          </div>

          <h4>Process Flow</h4>
          <div class="process-flow">
            <ol>
              <li>Parse input strings and count significant figures for both numerator and denominator</li>
              <li>Calculate the raw division result</li>
              <li>Determine if the fraction is terminating (check if denominator only has factors 2 and 5 after reduction)</li>
              <li>
                <strong>If terminating:</strong> Use exact result with minimum significant figures
              </li>
              <li>
                <strong>If non-terminating:</strong>
                <ul>
                  <li>Calculate digits before decimal point</li>
                  <li>Round to p+1 significant figures (where p = minimum sig figs)</li>
                  <li>Pad with trailing zeros if needed to reach desired precision</li>
                </ul>
              </li>
              <li>Format result string (trim trailing zeros, handle decimal point)</li>
            </ol>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Disclaimer Section -->
    <mat-card class="disclaimer-card">
      <mat-card-header>
        <mat-card-title>Disclaimer & Attribution</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="disclaimer-content">
          <p>
            This demonstration is based on the SQL script implementation of drug strength rounding rules.
            The JavaScript implementation in this component is a translation of the original SQL functions.
          </p>
          <p>
            <strong>Author:</strong> Francois Lavoie, Canada
          </p>
          <p>
            <strong>Original SQL Script:</strong>
            <a 
              href="assets/drug-strength-rounding-rules/Function Rounding rules function.sql" 
              download="Function Rounding rules function.sql"
              class="download-link">
              <mat-icon>download</mat-icon>
              Download SQL Script
            </a>
          </p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
