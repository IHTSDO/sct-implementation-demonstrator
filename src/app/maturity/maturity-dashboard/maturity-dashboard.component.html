<mat-sidenav-container class="module-container">
  <mat-sidenav #sidenav mode="side" [(opened)]="opened" class="custom-sidenav">
    Sidenav content
  </mat-sidenav>

  <mat-sidenav-content>
    <div class="mt-8 w-full max-w-full">
      <div class="header-container">
        <!-- <button mat-button (click)="sidenav.toggle()">sidenav.toggle()</button> -->
        <h1>SNOMED Implementation Maturity Dashboard</h1>
        @if (!expoMode) {
          <h2 class="italic">Results from the Maturity Assessment Tool</h2>
        }
        @if (expoMode) {
          <h2 class="italic">Expo 2025 Assessment Results</h2>
        }
        @if (uploadedData.length === 0 && !expoMode) {
          <div class="flex flex-row gap-4">
            <input #fileInput type="file" multiple accept=".json" (change)="onFilesSelected($event)" style="display: none"/>
            <input #folderInput type="file" multiple accept=".json" (change)="onFilesSelected($event)" style="display: none" webkitdirectory/>
            <button mat-raised-button color="primary" (click)="fileInput.click()">
              Load maturity assessment results (JSON Files)
            </button>
            <button mat-raised-button color="primary" (click)="folderInput.click()">
              Load maturity assessment results (Folder)
            </button>
            <button mat-raised-button color="primary" (click)="loadExamples()">
              Load example results
            </button>
          </div>
        }

        @if (expoMode && !loadingFirebaseData) {
          <div class="flex flex-row gap-4">
            <button mat-raised-button color="primary" (click)="loadFirebaseData()">
              Load Expo 2025 Data from Firebase
            </button>
          </div>
        }

        @if (loadingFirebaseData) {
          <div class="flex flex-row gap-4">
            <mat-spinner diameter="30"></mat-spinner>
            <span class="ml-2">Loading Expo 2025 data from Firebase...</span>
          </div>
        }
      </div>

      @if (uploadedData.length === 0) {
        <div class="w-full flex flex-row items-center justify-center mt-8">
          <img src="assets/img/dashboard-background.png" alt="Dashboard" class="snomed-logo" class="w-1/3">
        </div>
      }

      <!-- Expo Mode: Simplified full-screen map -->
      @if (expoMode && uploadedData.length > 0) {
        <div class="expo-map-container">
          <div id="map" class="expo-fullscreen-map"></div>
        </div>
      }

      <!-- Regular Mode: Full dashboard -->
      @if (!expoMode && uploadedData.length > 0) {
        <div>
          <div class="flex flex-row gap-4 w-full pl-8 pr-8 mt-8">
            <div class="chart-container flex-1 dashboard-card text-2xl p-4 font-bold">
              {{ uploadedData.length }} assessments loaded
            </div>
            <div class="chart-container flex-1 dashboard-card text-2xl p-4 font-bold">
              Stakeholders: {{ uploadedData[0].stakeHolderName }}
            </div>
            <div class="chart-container flex-1 dashboard-card text-2xl p-4 font-bold">
              Average Score: {{ overallScore }}
            </div>
            <div class="chart-container flex-1 dashboard-card text-2xl p-4 font-bold">
              Average Level: {{ level }}
            </div>
          </div>
          <div class="flex flex-row gap-4 w-full pl-8 pr-8 mt-4">
            <div class="w-8/12 dashboard-card">
              <div id="map" style="height: 500px;"></div>
            </div>
            <div class="w-4/12 flex flex-col items-center justify-center dashboard-card overflow-hidden">
              <ngx-gauge
                type="semi"
                [min]="1"
                [max]="5"
                [value]="overallScore"
                [cap]="'round'"
                [thick]="35"
                [size]="400"
                [markers]="markers"
                [foregroundColor]="getScoreColor(overallScore)"
                [backgroundColor]="'#eeeeee'"
                class="overflow-hidden"
                >
              </ngx-gauge>
              <h2>
                Overall Maturity Score
              </h2>
            </div>
          </div>
          <div class="flex flex-row gap-4 w-full pl-8 pr-8 mt-4">
            <div class="chart-container flex-1 dashboard-card">
              <canvas #overallScoreCanvas></canvas>
            </div>
            <div class="chart-container flex-1 dashboard-card">
              <canvas #radarCanvas></canvas>
            </div>
          </div>
          <div class="flex flex-row gap-4 w-full pl-8 pr-8 mt-4 items-center justify-center">
            <div class="dashboard-card flex flex-col items-center justify-center w-2/3 pt-8 pb-8">
              @if (uploadedData.length != 0) {
                <h2>Summary of Maturity Assessment Data</h2>
              }
              @if (uploadedData.length != 0) {
                <table class="bordered-table">
                  <thead>
                    <tr>
                      <th>Stakeholder Type</th>
                      <th>StakeHolder Name</th>
                      <th>Maturity Score</th>
                      <th>Location</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (stakeholder of uploadedData; track stakeholder) {
                      <tr (click)="openMaturityResultsDialog(stakeholder)" style="cursor: pointer;">
                        <td>{{ stakeholder.stakeHolderName }}</td>
                        <td>{{ stakeholder.name }}</td>
                        <td>{{ stakeholder.overallScore }} - {{ stakeholder.level }}</td>
                        <td>{{ (stakeholder.location?.label) ? stakeholder.location?.label : 'No location information'  }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              }
            </div>
          </div>
        </div>
      }
      <div class="flex flex-row gap-4 w-full p-8 mt-4 items-center justify-center">
        @if (uploadedData.length != 0) {
          <button mat-raised-button color="primary" (click)="reset()">
            @if (!expoMode) {
              <span>Reset dashboard</span>
            }
            @if (expoMode) {
              <span>Refresh Expo 2025 Data</span>
            }
          </button>
        }
      </div>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>