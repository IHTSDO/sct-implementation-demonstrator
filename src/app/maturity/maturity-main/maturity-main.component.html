<div class="flex flex-row gap-4 justify-end flex-wrap p-2" *ngIf="authorMode">
    <button mat-flat-button color="primary" (click)="downloadSpecification()">Download Maturiry Spec</button>
    <!-- Load Maturity Spec Button -->
    <input hidden (change)="uploadSpecification($event)" #fileInput type="file" id="file" />
    <button mat-flat-button color="primary" (click)="fileInput.click()">Upload Maturity Spec</button>
</div>
<div class="question-flow-container" *ngIf="currentQuestionIndex === -3">
    <div class="question-container">
        <div>
            <h1 class="text-center" *ngIf="!expoMode">Welcome to SNOMED International's Implementation Maturity Assessment Tool</h1>
            <h1 class="text-center" *ngIf="expoMode">Welcome to SNOMED International's Expo 2025 Quick Assessment</h1>
            
            <div *ngIf="!expoMode">
                <p class="mb-4">
                    The SNOMED International <b>Implementation Maturity Assessment Tool</b> is designed to help <b>Vendors</b>, <b>Members</b> (National Release Centers), 
                    and <b>User Organizations</b> evaluate their progress in adopting and integrating SNOMED CT. This tool provides structured insights 
                    into implementation maturity, highlighting strengths and areas for improvement.
                </p>
            </div>
            
            <div *ngIf="expoMode">
                <p class="mb-4">
                    This is a <b>quick assessment version</b> designed for Expo 2025. You'll complete a streamlined evaluation focusing on the most critical 
                    Key Process Area for your stakeholder type. This brief assessment provides immediate insights into your SNOMED CT implementation maturity 
                    and will be automatically saved to our Expo 2025 database for collective analysis.
                </p>
            </div>
            <hr>
            <div class="flip-card-container">
                <app-flip-card #myFlipCard>
                    <!-- FRONT CONTENT -->
                    <div flipFront>
                        <div class="text-2xl mb-4 font-bold">Why use this tool?</div>
                        <p>Identify gaps, gain insights, align with best practices, and advance SNOMED CT adoptionâ€”tailored for vendors, members, and user organizations.</p>
                        <button mat-raised-button color="accent" (click)="myFlipCard.toggleFlip()">
                            More...
                        </button>
                    </div>
                    <!-- BACK CONTENT -->
                    <div flipBack>
                        <div class="text-2xl mb-2 font-bold">Why use this tool?</div>
                        <div class="home-list">
                            <div class="home-list-item">
                                <div><b>Identify Gaps</b> â€“ Assess implementation challenges and pinpoint areas needing further development.</div>
                            </div>
                            <div class="home-list-item">
                                <div><b>Obtain actionable</b> Insights â€“ Supports continuous improvement and governance.</div>
                            </div>
                            <div class="home-list-item">
                                <div><b>Align with Best Practices</b> â€“ Benchmark your progress against internationally recognized standards.</div>
                            </div>
                            <div class="home-list-item">
                                <div><b>Tailored for Different Stakeholders</b> â€“ Designed to support key stakeholders in their SNOMED CT journey.</div>
                            </div>
                        </div>
                        <button mat-raised-button color="accent" (click)="myFlipCard.toggleFlip()">
                            Back
                        </button>
                    </div>
                </app-flip-card>
                <app-flip-card #myFlipCard2>
                    <!-- FRONT CONTENT -->
                    <div flipFront>
                        <div class="text-2xl mb-4 font-bold">How does it work?</div>
                        <p>Assess key areas, receive a maturity score, gain improvement insights, and generate a report to enhance SNOMED CT implementation and collaboration.</p>
                        <button mat-raised-button color="accent" (click)="myFlipCard2.toggleFlip()">
                            More...
                        </button>
                        </div>
                        <!-- BACK CONTENT -->
                        <div flipBack>
                            <div class="text-2xl mb-2 font-bold">How does it work?</div>
                            <div class="home-list">
                                <div class="home-list-item">
                                    <div><b>Select Key Process Areas</b> â€“ Choose the areas most relevant to your role and implementation needs.</div>
                                </div>
                                <div class="home-list-item">
                                    <div><b>Complete the Assessment</b> â€“ Answer structured questions across selected key process areas.</div>
                                </div>
                                <div class="home-list-item">
                                    <div><b>Receive a Maturity Score</b> â€“ Get a clear view of your current implementation maturity level.</div>
                                </div>
                                <div class="home-list-item">
                                    <div><b>Download and Share Your Report</b> â€“ Generate a detailed report which can be stored for internal use or shared.</div>
                                </div>
                            </div>
                        <button mat-raised-button color="accent" (click)="myFlipCard2.toggleFlip()">
                            Back
                        </button>
                    </div>
                </app-flip-card>
                <app-flip-card #myFlipCard3>
                    <!-- FRONT CONTENT -->
                    <div flipFront>
                        <div class="text-2xl mb-4 font-bold">Who should use it?</div>
                            <p>Tailored assessments for vendors, members, and user organizations to evaluate SNOMED CT integration, adoption, and clinical use.</p>
                            <button mat-raised-button color="accent" (click)="myFlipCard3.toggleFlip()">
                                More...
                            </button>
                        </div>
                        <!-- BACK CONTENT -->
                        <div flipBack>
                            <div class="text-2xl mb-2 font-bold">Who should use it?</div>
                            <div class="home-list">
                                <div class="home-list-item">
                                    <div><b>Vendors</b> â€“ Assess SNOMED CT integration within healthcare software and applications.</div>
                                </div>
                                <div class="home-list-item">
                                    <div><b>Members</b> (National Release Centers) â€“ Evaluate national or regional SNOMED CT adoption and management strategies.</div>
                                </div>
                                <div class="home-list-item">
                                    <div><b>User Organizations</b> â€“ Analyze SNOMED CT use within healthcare systems, EHRs, and clinical workflows.</div>
                                </div>
                            </div>
                            <button mat-raised-button color="accent" (click)="myFlipCard3.toggleFlip()">
                                Back
                            </button>
                        </div>
                </app-flip-card>
            </div>
            <div class="button-container-space-between">
                <button  mat-flat-button color="primary" (click)="openDashboard()">
                    <span *ngIf="!expoMode">MATURITY ANALYTICS DASHBOARD</span>
                    <span *ngIf="expoMode">EXPO 2025 ANALYTICS DASHBOARD</span>
                </button>
                <button class="start-button" mat-flat-button color="accent" (click)="startAssessment()">
                    START ASSESSMENT
                </button>
                <input hidden (change)="loadState($event)" #fileInputState1 type="file" id="fileState" />
                <button  mat-flat-button color="primary" (click)="fileInputState1.click()">
                    LOAD PREVIOUS ASSESSMENT
                </button>
            </div>
            <div class="button-container-space-between italic text-xs pl-4 pr-4 pt-1">
                <div *ngIf="!expoMode">Analyze a collection of assessment results</div>
                <div *ngIf="expoMode">View Expo 2025 assessment results from Firebase</div>
                <div>Upload an assessmen to edit or view results</div>
            </div>
        </div>
    </div>
</div>
<div class="question-flow-container" *ngIf="currentQuestionIndex === -2">
    <div class="question-container" [formGroup]="responseForm">
    <h2>SNOMED Implementation Maturity assessment</h2>
    <h3>Select Stakeholder Type</h3>
    <div class="flex flex-row gap-4 justify-end flex-wrap p-2">
        <div class="flex-1">
            <mat-radio-group [formControl]="currentControl" class="options-container" [@questionAnimation]="animationState">
            <mat-radio-button *ngFor="let stakeholder of maturityQuestions.stakeHolders" [value]="stakeholder.id" class="mb-5">
                {{ stakeholder.name }}
                <p class="stakeholder-description"> {{ stakeholder.description }}</p>
            </mat-radio-button>
            </mat-radio-group>
            <div class="error-message" *ngIf="responseForm.controls['selectedStakeholder']?.invalid && responseForm.controls['selectedStakeholder']?.touched">
            Please select a stakeholder.
            </div>
        </div>
        <div class="flex-1 mb-10">
            <div *ngIf="!responseForm.controls['selectedStakeholder'].invalid">
                <h2>Stakeholder Description</h2>
                <div *ngIf="expoMode" class="expo-required-fields-info mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-blue-800 text-sm">
                        <strong>Expo Mode:</strong> Stakeholder name, user name, and location are required fields for Expo 2025 assessments.
                        This information will be stored and showed on a map in the expo floor.
                        Do not enter any information that you would not be comfortable to share with the public.
                    </p>
                </div>
                <mat-form-field class="w-full">
                    <mat-label>{{ getStakeHolder(responseForm.controls['selectedStakeholder'].value)?.name | titlecase}} name </mat-label>
                    <input matInput placeholder="Enter stakeholder name..." [formControl]="nameControl">
                    <!-- <mat-icon matSuffix>sentiment_very_satisfied</mat-icon> -->
                    <mat-hint *ngIf="!expoMode">Stakeholder name to be included in the final assessment report. This information is not stored.</mat-hint>
                    <mat-hint *ngIf="expoMode">Stakeholder name to be included in the final assessment report and stored in Expo 2025 database.</mat-hint>
                    <mat-error *ngIf="expoMode && nameControl.invalid && nameControl.touched">
                        Stakeholder name is required in Expo mode.
                    </mat-error>
                </mat-form-field>
                <mat-form-field class="w-full mt-10" *ngIf="getStakeHolder(responseForm.controls['selectedStakeholder'].value)?.name === 'Vendor'">
                    <mat-label>System name </mat-label>
                    <input matInput placeholder="Enter the name of the software system being evaluated..." [formControl]="systemNameControl">
                    <!-- <mat-icon matSuffix>sentiment_very_satisfied</mat-icon> -->
                    <mat-hint *ngIf="!expoMode">Name of the software system being evaluated. This information is not stored.</mat-hint>
                    <mat-hint *ngIf="expoMode">Name of the software system being evaluated. This information is stored in Expo 2025 database.</mat-hint>
                </mat-form-field>
                <mat-form-field class="w-full mt-10">
                    <mat-label>User name </mat-label>
                    <input matInput placeholder="Enter the name of the user conducting the assessment..." [formControl]="authorControl">
                    <!-- <mat-icon matSuffix>sentiment_very_satisfied</mat-icon> -->
                    <mat-hint *ngIf="!expoMode">User name to be included in the final assessment report. This information is not stored.</mat-hint>
                    <mat-hint *ngIf="expoMode">User name to be included in the final assessment report and stored in Expo 2025 database.</mat-hint>
                    <mat-error *ngIf="expoMode && authorControl.invalid && authorControl.touched">
                        User name is required in Expo mode.
                    </mat-error>
                </mat-form-field>
                <mat-form-field class="w-full mt-10">
                    <mat-label>Location</mat-label>
                    <input matInput type="text" placeholder="Enter a Country, City or address..." [formControl]="locationControl" [matAutocomplete]="auto">
                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onLocationSelected($event.option.value)" [displayWith]="displayLocation">
                      <mat-option *ngFor="let loc of locationResults" [value]="loc">{{ loc.label }}</mat-option>
                    </mat-autocomplete>
                    <mat-progress-spinner *ngIf="loadingLocationResults" matSuffix mode="indeterminate" diameter="20"></mat-progress-spinner>
                    <mat-hint *ngIf="!loadingLocationResults && !expoMode">Country, city or address. This information is not stored and is useful for collating results in dashboards.</mat-hint>
                    <mat-hint *ngIf="!loadingLocationResults && expoMode">Country, city or address. This information is stored in Expo 2025 database used for the map in the expo floor.</mat-hint>
                    <mat-error *ngIf="expoMode && locationControl.invalid && locationControl.touched">
                        Location is required in Expo mode.
                    </mat-error>
                </mat-form-field>
            </div>
        </div>
    </div>
    <div class="button-container-first">
        <div class="start-button button-container">
            <button mat-flat-button color="primary" (click)="startOver()">
            Back
            </button>
            <button mat-flat-button color="primary" (click)="onStakeholderSelected()"
            [disabled]="responseForm.controls['selectedStakeholder'].invalid || (expoMode && (nameControl.invalid || authorControl.invalid || locationControl.invalid))">
            Select KPAs
            </button>
        </div>
    
        <!-- File input for loading saved state -->
        <input hidden (change)="loadState($event)" #fileInputState type="file" id="fileState" />
    
        <button class="secondary-button" mat-flat-button (click)="fileInputState.click()">
        Upload previous results
        </button>
    </div>
    
</div>
</div>

<div class="question-flow-container" *ngIf="currentQuestionIndex === -1">
    <div class="question-container" [formGroup]="responseForm" *ngIf="currentQuestionIndex < allQuestions.length">
        <h2>SNOMED Implementation Maturity assessment</h2>
        <h3>Stakeholder: {{ nameControl.value }} ({{ allQuestions[currentQuestionIndex + 1].stakeholderName }})</h3>
        <section class="example-section mt-10">
            <h4 *ngIf="!expoMode">Select Relevant Key Process Areas:</h4>
            <h4 *ngIf="expoMode">Key Process Areas (Expo 2025 Quick Assessment):</h4>
            
            <div *ngIf="expoMode" class="expo-kpa-info mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-yellow-800 text-sm">
                    <strong>Note:</strong> In Expo mode, only the primary KPA is enabled for assessment. 
                    Other KPAs are shown for reference but are disabled to keep the assessment brief.
                </p>
            </div>
            
            <div *ngFor="let kpa of currentKpas; let i = index" class="kpa-checkbox">
                <mat-checkbox 
                    *ngIf="getKpaControl(kpa.id)" 
                    [formControl]="getKpaControl(kpa.id)">
                    {{ kpa.name }}
                    <span *ngIf="expoMode && i === 0" class="expo-primary-kpa-label"> (Primary - Enabled)</span>
                    <span *ngIf="expoMode && i !== 0" class="expo-disabled-kpa-label"> (Disabled in Expo Mode)</span>
                    <br><span class="kpa-description">{{ kpa.description }}</span>
                </mat-checkbox>
            </div>
        </section>

        <div class="button-container">
            <button mat-flat-button color="primary" (click)="startOver()">
                Back
            </button>
            <button mat-flat-button color="primary" (click)="filterKpasAndGoNext()" [disabled]="currentControl.invalid" *ngIf="currentQuestionIndex < allQuestions.length - 1">
                Start assessment
            </button>
        </div>
    </div>
</div>

<div class="question-flow-container" *ngIf="currentQuestionIndex >= 0 && currentQuestionIndex < allQuestions.length">
    <div class="question-container" [formGroup]="responseForm" *ngIf="currentQuestionIndex < allQuestions.length">
        <h2>SNOMED Implementation Maturity assessment</h2>
        <h3>Stakeholder: {{ nameControl.value }} ({{ allQuestions[currentQuestionIndex].stakeholderName }})</h3>
        <mat-progress-bar mode="determinate" [value]="((currentQuestionIndex + 1) / (allQuestions.length + 1)) * 100" class="progress-bar"></mat-progress-bar>
        <div class="progress-message">Question {{ currentQuestionIndex + 1 }} of  {{ allQuestions.length }}</div>
        <h3>Key Process Area: {{ allQuestions[currentQuestionIndex].kpaName }}</h3>
        <p class="question-text" [@questionAnimation]="animationState" [innerHTML]="allQuestions[currentQuestionIndex].question.question"></p>
        <div class="flex flex-row gap-4 justify-end flex-wrap p-2">
            <div class="flex-1">
                <mat-radio-group [formControl]="currentControl" class="options-container" [@questionAnimation]="animationState">
                    <div class="radio-option" *ngFor="let option of allQuestions[currentQuestionIndex].question.options">
                        <mat-radio-button [value]="option.score">
                            <div class="option-text">
                                <b>{{ option.id }} - {{ option.text }}</b>
                            </div>
                        </mat-radio-button>
                        <div class="example-text" *ngIf="option.example">
                            {{ option.example }}
                        </div>
                    </div>
                </mat-radio-group>
            </div>
            <div class="flex-1 w-full">
                <div *ngIf="allQuestions[currentQuestionIndex].question.context">
                  <div class="question-context-heading">How to answer this question</div>
                  <div class="question-context" [innerHTML]="allQuestions[currentQuestionIndex].question.context"></div>
                </div>
                <hr class="context-separator" *ngIf="allQuestions[currentQuestionIndex].question.context">
                <div class="context-comment-spacing">
                <mat-form-field class="w-full">
                <mat-label><i>Optional comment</i></mat-label>
                <textarea matInput [formControl]="currentCommentControl" placeholder="Enter your comment" rows="5"></textarea>
                </mat-form-field>
                </div>
            </div>
        </div>
        <div class="error-message" *ngIf="currentControl?.invalid && currentControl?.touched">
        Please select an option for this question.
        </div>
        <div class="button-container">
            <!-- <button mat-flat-button color="primary" (click)="startOver()" *ngIf="currentQuestionIndex == 0">
                Restart
            </button> -->
            <button mat-flat-button color="primary" (click)="goToPreviousQuestion()" *ngIf="currentQuestionIndex > 0" [disabled]="currentQuestionIndex < 1">
                Back
            </button>
            <button mat-flat-button color="primary" (click)="goToNextQuestion()" [disabled]="currentControl.invalid" *ngIf="currentQuestionIndex < allQuestions.length - 1">
                Next
            </button>
            <button mat-flat-button color="accent" [disabled]="currentControl.invalid" *ngIf="currentQuestionIndex === allQuestions.length -1" (click)="submitStakeholderResponses()">
                See results
            </button>
        </div>
        <div class="button-container-first">
            <button class="secondary-button" mat-flat-button (click)="startOver()">
                Restart assessment
            </button>
        </div>
    </div>
</div>

<div class="question-flow-container" *ngIf="currentQuestionIndex == allQuestions.length">
    <div class="question-container" [@questionAnimation]="animationState">
        <div id="pdfReport">
            <h2 *ngIf="!expoMode">SNOMED Implementation Maturity assessment results</h2>
            <h2 *ngIf="expoMode">SNOMED Implementation Maturity assessment results - Expo 2025 Quick Assessment</h2>
            
            <div *ngIf="expoMode" class="expo-results-banner mb-4 p-4 bg-green-100 border border-green-300 rounded-lg">
                <h3 class="text-green-800 font-bold mb-2">ðŸŽ‰ Expo 2025 Quick Assessment Complete!</h3>
                <p class="text-green-700 text-sm">
                    Your assessment is ready! Click "Save to Expo 2025" to contribute your results to our collective analysis. 
                    This quick assessment focused on the primary KPA for your stakeholder type.
                </p>
            </div>
            
            <h3>Stakeholder: {{ nameControl.value }} ({{ allQuestions[currentQuestionIndex - 1].stakeholderName }}) 
                <span *ngIf="systemNameControl.value"> - System: {{ systemNameControl.value }}</span>
                <span *ngIf="expoMode"> - Expo 2025 Mode</span>
            </h3>
            <p class="text-center" *ngIf="locationControl.value">
                Location: {{ locationControl.value.label }}
            </p>
            <p class="text-center">Assessment conducted 
                <span *ngIf="authorControl.value">by {{ authorControl.value }}, </span>
                on {{ timestampControl.value | date: 'medium' }}
                <span *ngIf="expoMode"> (Expo 2025 Quick Assessment)</span>
            </p>
            <p class="text-center mt-10 text-lg">Based on your responses, the maturity level of the stakeholder is:</p>

            <app-maturity-results #results [maturityResponse]="responseForm.value" [allQuestions]="allQuestions" [expoMode]="expoMode"></app-maturity-results>
        </div>

        <!-- Expo Mode: Simplified buttons -->
        <div class="button-container" *ngIf="expoMode">
            <button mat-flat-button color="primary" (click)="goToPreviousQuestion()" [disabled]="currentQuestionIndex < 1">
                Back
            </button>
            <button mat-flat-button color="primary" (click)="startOver()">
                Start over
            </button>
        </div>
        
        <!-- Expo Mode: Send button on its own row -->
        <div class="button-container" *ngIf="expoMode">
            <button mat-flat-button color="accent" (click)="saveToFirebase()" class="expo-send-button">
                Send to Expo 2025 Floor Map!
            </button>
        </div>

        <!-- Regular Mode: Full button set -->
        <div class="button-container" *ngIf="!expoMode">
            <button mat-flat-button color="primary" (click)="goToPreviousQuestion()" [disabled]="currentQuestionIndex < 1">
                Back
            </button>
            <button mat-flat-button color="primary" (click)="startOver()">
                Start over
            </button>
        </div>
        <div class="button-container" *ngIf="!expoMode">
            <!-- Download Button -->
            <button mat-flat-button color="primary" (click)="saveState()">
                ðŸ“¥ Download results
            </button>
            
            <!-- PDF Download Button -->
            <button mat-flat-button color="primary" (click)="downloadPdf()">ðŸ“„ Download PDF</button>
        </div>
    </div>
</div>
  