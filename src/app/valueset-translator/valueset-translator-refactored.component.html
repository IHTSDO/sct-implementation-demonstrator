<div class="main-container">
  <h2>ValueSet Utility</h2>
  <p class="instructions">
    Load a file (Excel, CSV, TSV, or FHIR ValueSet JSON) or enter an ECL expression to start. 
  </p>
  
  <!-- Language indicators -->
  <div *ngIf="terminologyContext.language">
    <div class="floating-indicators" *ngIf="true">
      <div class="indicator edition-indicator">
        <div class="indicator-arrow">↑</div>
        <div class="indicator-text">Select Edition</div>
      </div>
      <div class="indicator language-indicator">
        <div class="indicator-arrow">↑</div>
        <div class="indicator-text">Select Language</div>
      </div>
    </div>

    <div class="terminology-context">
      <p>Target terminology context:</p>
      <ul>
        <li><strong>Edition:</strong> {{ terminologyContext.editionName }}</li>
        <li><strong>Version:</strong> {{ terminologyContext.fhirUrlParam }}</li>
        <li><strong>Language:</strong> {{ terminologyContext.language }}</li>
      </ul>
    </div>
  </div>

  <!-- Loading Indicator for File Preview -->
  <div *ngIf="isLoading$ | async" class="loading-container">
    <mat-progress-spinner
      mode="indeterminate"
      diameter="40"
    ></mat-progress-spinner>
    <p class="loading-text">Processing your file...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!(isLoading$ | async)">
    <!-- File Upload Section -->
    <app-file-upload-section
      [showEclInput]="showEclInput$ | async"
      [eclExpression]="eclExpression"
      [file]="file$ | async"
      [processingResult]="processingResult$ | async"
      [isFileLoading]="isLoading$ | async"
      (fileSelected)="onFileSelected($event)"
      (eclInputToggled)="onEclInputToggle()"
      (eclExpressionChanged)="onEclExpressionChange($event)"
      (eclExpanded)="onEclExpand()"
    ></app-file-upload-section>

    <!-- File Preview Section -->
    <app-file-preview-section
      [showPreview]="showPreview$ | async"
      [previewData]="(processingResult$ | async)?.data || []"
      [columns]="(processingResult$ | async)?.columns || []"
      [displayedColumns]="(processingResult$ | async)?.columns?.map((_, i) => i.toString()) || []"
      [importForm]="importForm"
      [processingResult]="processingResult$ | async"
      [isLoading]="isLoading$ | async"
      [isEclResult]="(processingResult$ | async)?.isEclResult || false"
      (formValueChanged)="onFormValueChange($event.field, $event.value)"
    ></app-file-preview-section>

    <!-- Action Selection Section -->
    <app-action-selection-section
      [showPreview]="showPreview$ | async"
      [previewData]="(processingResult$ | async)?.data || []"
      [selectedAction]="selectedAction$ | async"
      [processingResult]="processingResult$ | async"
      [canExecuteAction]="canExecuteAction"
      [isLoading]="isLoading$ | async"
      (actionSelected)="onActionSelect($event)"
    ></app-action-selection-section>

    <!-- Translation Section -->
    <app-translation-section
      [selectedAction]="selectedAction$ | async"
      [terminologyContext]="terminologyContext"
      [editionsDetails]="editionsDetails"
      [languages]="languages"
      [contexts]="contexts"
      [languageRefsets]="languageRefsets"
      [selectedContext]="selectedContext"
      [selectedLanguageDisplayLabel]="selectedLanguageDisplayLabel"
      [selectedLanRefsetConcept]="selectedLanRefsetConcept"
      [valueSetMetadata]="valueSetMetadata"
      [targetPreviewData]="targetPreviewData"
      [isTranslationLoading]="isTranslationLoading"
      [canExecuteAction]="canExecuteAction"
      [isLoading]="isLoading$ | async"
      (editionChanged)="onEditionChange($event)"
      (languageChanged)="onLanguageChange($event)"
      (contextChanged)="onContextChange($event)"
      (languageRefsetChanged)="onLanguageRefsetChange($event)"
      (metadataChanged)="onMetadataChange($event.field, $event.value)"
      (actionExecuted)="onExecuteAction()"
    ></app-translation-section>

    <!-- Download Section -->
    <app-download-section
      [targetValueSet]="targetValueSet"
      [sourceValueSet]="sourceValueSet"
      [generatedPackage]="generatedPackage"
      [selectedAction]="selectedAction$ | async"
      [isLoading]="isLoading$ | async"
      [fhirServerUrl]="fhirServerUrl"
      [isUploading]="isUploading"
      [showFhirServerUpload]="showFhirServerUpload"
      [instructionTab]="instructionTab"
      (downloadTargetValueSet)="onDownloadTargetValueSet()"
      (downloadTargetAsExcel)="onDownloadTargetAsExcel()"
      (downloadSourceValueSet)="onDownloadSourceValueSet()"
      (downloadTranslatedFile)="onDownloadTranslatedFile()"
      (generateFHIRPackage)="onGenerateFHIRPackage()"
      (fhirServerUrlChanged)="onFhirServerUrlChange($event)"
      (fhirServerUploadToggled)="onFhirServerUploadToggle()"
      (uploadToFhirServer)="onUploadToFhirServer()"
      (instructionTabChanged)="onInstructionTabChange($event)"
    ></app-download-section>
  </div>

  <!-- Error Display -->
  <div *ngIf="error$ | async" class="error-message">
    <mat-icon>error</mat-icon>
    <span>{{ error$ | async }}</span>
  </div>

  <!-- Success Message -->
  <div *ngIf="(stateService.selectProcessingState() | async)?.successMessage" class="success-message">
    <mat-icon>check_circle</mat-icon>
    <span>{{ (stateService.selectProcessingState() | async)?.successMessage }}</span>
  </div>

  <!-- Progress Bar -->
  <mat-progress-bar mode="indeterminate" *ngIf="(stateService.selectProcessingState() | async)?.isProcessing"></mat-progress-bar>
</div>
