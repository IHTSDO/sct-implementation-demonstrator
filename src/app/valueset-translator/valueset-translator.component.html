<div class="main-container">
  <h2>ValueSet Utility</h2>
  <div class="intro-section">
    <p class="description">
      This tool is specifically designed to help implementers bridge the gap between legacy or proprietary representations (such as spreadsheets or
      simple lists) and modern, standards-compliant FHIR ValueSet resources, streamlining the path to interoperable SNOMED CT implementations.
    </p>
    <p class="instructions">
      Load a file (Excel, CSV, TSV, or FHIR ValueSet JSON) or enter an ECL expression to start.
    </p>
  </div>

  <div class="workflow-progress">
    <div class="workflow-step" [class.active]="currentWorkflowStep === 1" [class.completed]="currentWorkflowStep > 1">
      <span class="step-number">1</span>
      <span class="step-label">Input</span>
    </div>
    <div class="workflow-step" [class.active]="currentWorkflowStep === 2" [class.completed]="currentWorkflowStep > 2">
      <span class="step-number">2</span>
      <span class="step-label">Configure</span>
    </div>
    <div class="workflow-step" [class.active]="currentWorkflowStep === 3" [class.completed]="currentWorkflowStep > 3">
      <span class="step-number">3</span>
      <span class="step-label">Action</span>
    </div>
    <div class="workflow-step" [class.active]="currentWorkflowStep === 4">
      <span class="step-number">4</span>
      <span class="step-label">Results</span>
    </div>
  </div>

  <!-- Language indicators -->
  @if (translationEnabled) {
    <div>
      @if (showIndicators) {
        <div class="floating-indicators">
          <div class="indicator edition-indicator">
            <div class="indicator-arrow">↑</div>
            <div class="indicator-text">Select Edition</div>
          </div>
          <div class="indicator language-indicator">
            <div class="indicator-arrow">↑</div>
            <div class="indicator-text">Select Language</div>
          </div>
        </div>
      }
      <div class="terminology-context">
        <p>Target terminology context:</p>
        <ul>
          <li><strong>Edition:</strong> {{ terminologyContext.editionName }}</li>
          <li><strong>Version:</strong> {{ terminologyContext.fhirUrlParam }}</li>
          <li><strong>Language:</strong> {{ terminologyContext.language }}</li>
        </ul>
      </div>
    </div>
  }

  <!-- Loading Indicator for File Preview -->
  @if (isFileLoading) {
    <div class="loading-container">
      <mat-progress-spinner
        mode="indeterminate"
        diameter="40"
      ></mat-progress-spinner>
      <p class="loading-text">Processing your file...</p>
    </div>
  }

  <!-- Import Controls -->
  @if (!isFileLoading) {
    <div>
      <!-- File Upload Section -->
      <div class="upload-section">
        <h3 class="upload-title">
          <mat-icon>cloud_upload</mat-icon>
          Upload Data
        </h3>
        <div class="input-method-buttons">
          @if (!showEclInput) {
            <button
              mat-raised-button
              color="primary"
              class="input-method-button"
              (click)="fileInput.click()"
              >
              <mat-icon>upload_file</mat-icon>
              <span>Choose File (Excel/CSV/TSV/TXT/JSON)</span>
            </button>
          }
          <button
            mat-raised-button
            [color]="showEclInput ? 'accent' : 'primary'"
            class="input-method-button"
            (click)="toggleEclInput()"
            >
            <mat-icon>code</mat-icon>
            <span>{{ showEclInput ? 'Cancel ECL' : 'Enter ECL Expression' }}</span>
          </button>
        </div>
        <input
          type="file"
          (change)="onFileSelected($event)"
          accept=".xlsx,.xls,.csv,.tsv,.txt,.json"
          #fileInput
          style="display: none"
          />
        @if (file) {
          <span class="file-name">{{ file.name }}</span>
        }
        @if (isMap) {
          <div class="map-notice">
            <mat-icon color="primary">info</mat-icon>
            <span>Snap2Snomed Map detected - Columns configured automatically</span>
          </div>
        }
        @if (isRf2Refset) {
          <div class="refset-notice">
            <mat-icon color="accent">description</mat-icon>
            <span>RF2 Refset detected</span>
          </div>
        }
        @if (isValueSetFile) {
          <div class="valueset-notice">
            <mat-icon color="primary">schema</mat-icon>
            <span>FHIR ValueSet JSON detected</span>
          </div>
        }
        @if (file && !isMap && !isRf2Refset && !isValueSetFile && showPreview) {
          <div class="spreadsheet-notice">
            <mat-icon color="primary">table_chart</mat-icon>
            <span>Simple spreadsheet detected</span>
          </div>
        }
      </div>
      <!-- ECL Input Section -->
      @if (showEclInput) {
        <div class="ecl-input-section">
          <h3 class="ecl-title">
            <mat-icon>code</mat-icon>
            ECL Expression
          </h3>
          <div class="ecl-content">
            <mat-form-field appearance="fill" class="ecl-textarea">
              <mat-label>Enter ECL Expression</mat-label>
              <textarea
                matInput
                [(ngModel)]="eclExpression"
                placeholder="Enter your ECL expression here..."
                rows="4"
              ></textarea>
            </mat-form-field>
            <button
              mat-raised-button
              color="primary"
              class="ecl-button"
              (click)="expandEcl()"
              [disabled]="!eclExpression.trim() || isLoading"
              >
              <mat-icon>expand_more</mat-icon>
              <span>Expand ECL</span>
            </button>
            <!-- Progress bar during ECL expansion -->
            @if (isLoading && showEclInput) {
              <div class="ecl-loading">
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                <p class="loading-text">Expanding ECL expression...</p>
              </div>
            }
            <!-- Error message display -->
            @if (error && showEclInput) {
              <div class="error-message">
                <mat-icon>error</mat-icon>
                <span>{{ error }}</span>
              </div>
            }
            <!-- Success message display -->
            @if (successMessage && showEclInput) {
              <div class="success-message">
                <mat-icon>check_circle</mat-icon>
                <span>{{ successMessage }}</span>
              </div>
            }
          </div>
        </div>
      }
      @if (hasInputReady) {
        <div class="step-divider">
          <h3>Step 2: Configure Input</h3>
        </div>
      }
      <!-- Preview Table -->
      @if (showPreview && previewData.length > 0 && !isLoading) {
        <div class="preview-table">
          <h3 class="preview-title">
            <mat-icon>table_view</mat-icon>
            Preview ({{ visiblePreviewRows.length }} of {{ totalPreviewRowCount }} rows)
          </h3>
          <div class="table-container">
            <table mat-table [dataSource]="visiblePreviewRows" class="preview-data-table">
              @for (col of columns; track col; let i = $index) {
                <ng-container [matColumnDef]="i.toString()">
                  <th mat-header-cell *matHeaderCellDef>{{ col.header }}</th>
                  <td mat-cell *matCellDef="let row">{{ row[i] }}</td>
                </ng-container>
              }
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </div>
          @if (canLoadMorePreviewRows) {
            <div class="preview-actions">
              <button mat-stroked-button color="primary" (click)="loadMorePreviewRows()">
                <mat-icon>expand_more</mat-icon>
                <span>Load more</span>
              </button>
            </div>
          }
        </div>
      }
      <!-- Column Selection Form -->
      @if (showPreview && !isValueSetFile && !isMap && !isRf2Refset && !isEclResult) {
        <form [formGroup]="importForm" class="column-form">
          <h3 class="column-form-title">
            <mat-icon>view_column</mat-icon>
            Select Columns
          </h3>
          <div class="column-selection-row">
            <mat-form-field appearance="fill">
              <mat-label>Code Column</mat-label>
              <mat-select formControlName="codeColumn" required>
                @for (col of columns; track col) {
                  <mat-option [value]="col.index">
                    {{ col.header }}
                  </mat-option>
                }
              </mat-select>
              @if (importForm.get('codeColumn')?.hasError('required')) {
                <mat-error>
                  Please select a code column
                </mat-error>
              }
            </mat-form-field>
            <mat-form-field appearance="fill">
              <mat-label>Display Column (Optional)</mat-label>
              <mat-select formControlName="displayColumn">
                @for (col of columns; track col) {
                  <mat-option [value]="col.index">
                    {{ col.header }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-checkbox formControlName="skipHeader" class="skip-header">
              Skip header row
            </mat-checkbox>
          </div>
        </form>
      }
      @if (hasInputReady) {
        <div class="step-divider">
          <h3>Step 3: Select and Execute Action</h3>
        </div>
      }
      <!-- Action Selection -->
      @if (showPreview && previewData.length > 0 && !isLoading && (isValueSetFile || isMap || isRf2Refset || importForm.get('codeColumn')?.valid)) {
        <div class="action-selection">
          <h3 class="action-title">
            <mat-icon>play_circle</mat-icon>
            What would you like to do?
          </h3>
          <div class="action-buttons">
            <button
              mat-raised-button
              color="primary"
              (click)="selectAction('translate')"
              class="action-button"
              >
              <mat-icon>translate</mat-icon>
              <span>Translate the set of concepts</span>
            </button>
            <button
              mat-raised-button
              color="accent"
              (click)="selectAction('source-valueset')"
              class="action-button"
              >
              <mat-icon>list_alt</mat-icon>
              <span>Generate FHIR ValueSet (identical to uploaded concepts)</span>
            </button>
            <button
              mat-raised-button
              color="accent"
              (click)="selectAction('target-valueset')"
              class="action-button"
              >
              <mat-icon>language</mat-icon>
              <span>Generate FHIR ValueSet (with translated display terms)</span>
            </button>
            @if (isMap) {
              <button
                mat-raised-button
                color="warn"
                (click)="selectAction('translate-target')"
                class="action-button"
                >
                <mat-icon>swap_horiz</mat-icon>
                <span>Translate target column (Snap2Snomed Map)</span>
              </button>
            }
            @if (isMap) {
              <button
                mat-raised-button
                color="warn"
                (click)="selectAction('fhir-package')"
                class="action-button"
                >
                <mat-icon>archive</mat-icon>
                <span>Create FHIR Package (Snap2Snomed Map)</span>
              </button>
            }
            @if (isEclResult) {
              <button
                mat-raised-button
                color="accent"
                (click)="selectAction('code-display-excel')"
                class="action-button"
                >
                <mat-icon>table_view</mat-icon>
                <span>Download code/display table (Excel)</span>
              </button>
            }
          </div>
        </div>
      }
      <!-- Edition and Language Selectors for Translation Actions -->
      @if (selectedAction === 'translate' || selectedAction === 'target-valueset' || selectedAction === 'translate-target' || selectedAction === 'fhir-package') {
        <div class="translation-selectors">
          <h3 class="translation-selectors-title">
            <mat-icon>language</mat-icon>
            Output Language
          </h3>
          <div class="translation-selectors-content">
            <!-- Edition Selector Button and Menu -->
            <button mat-raised-button color="primary" [matMenuTriggerFor]="editionMenu" class="translation-button edition-button">
              <mat-icon>book</mat-icon>
              <span>{{ terminologyContext.editionName }}</span>
            </button>
            <mat-menu #editionMenu="matMenu">
              @for (edition of editionsDetails; track edition) {
                <button mat-menu-item (click)="onEditionChange(edition.editionName)">{{ edition.editionName }}</button>
              }
            </mat-menu>
            <!-- Unified Language Selector Button and Menu -->
            <button mat-raised-button color="accent" [matMenuTriggerFor]="langMenu" class="translation-button language-button">
              <mat-icon>translate</mat-icon>
              <span>{{ selectedLanguageDisplayLabel }}</span>
            </button>
            <mat-menu #langMenu="matMenu">
              @if (selectedLanRefsetConcept && !selectedContext) {
                <p class="menu-text">Selected Language Refset</p>
              }
              @if (selectedLanRefsetConcept && !selectedContext) {
                <p class="menu-text">{{ selectedLanRefsetConcept.display }}</p>
              }
              @if (selectedLanRefsetConcept && !selectedContext) {
                <p class="menu-text">{{ selectedLanRefsetConcept.code }}</p>
              }
              @if (selectedContext) {
                <p class="menu-text">Selected Language Context</p>
              }
              @if (selectedContext) {
                <p class="menu-text">{{ selectedContext.name }}</p>
              }
              <button mat-menu-item [matMenuTriggerFor]="langCodesMenu">Language Codes</button>
              <button mat-menu-item [matMenuTriggerFor]="langRefsetsMenu">Language Refsets</button>
              <button mat-menu-item [matMenuTriggerFor]="langContextsMenu">Language Contexts</button>
            </mat-menu>
            <mat-menu #langCodesMenu="matMenu">
              @for (language of languages; track language) {
                <button mat-menu-item (click)="onLanguageChange(language)">{{language}}</button>
              }
            </mat-menu>
            <mat-menu #langRefsetsMenu="matMenu">
              @for (langRefset of languageRefsets; track langRefset) {
                <button mat-menu-item (click)="onLanguageRefsetChange(langRefset)">{{langRefset.display}}</button>
              }
            </mat-menu>
            <mat-menu #langContextsMenu="matMenu">
              @for (context of contexts; track context) {
                <button mat-menu-item (click)="onContextChange(context)">{{context.name}}</button>
              }
            </mat-menu>
          </div>
        </div>
      }
      <!-- ValueSet Metadata Form -->
      @if (selectedAction && (selectedAction === 'source-valueset' || selectedAction === 'target-valueset' || selectedAction === 'fhir-package')) {
        <div class="valueset-metadata">
          <h3 class="valueset-metadata-title">
            <mat-icon>info</mat-icon>
            ValueSet Metadata
          </h3>
          <div class="valueset-metadata-content">
            @if (isMap) {
              <mat-form-field>
                <mat-label>Source System URI</mat-label>
                <input matInput [(ngModel)]="sourceSystemUri" placeholder="http://example.org/fhir/CodeSystem/example" required>
                <mat-hint>URI for the source CodeSystem</mat-hint>
              </mat-form-field>
            }
            <mat-form-field>
              <mat-label>ValueSet URI</mat-label>
              <input matInput [(ngModel)]="valueSetUri" placeholder="http://example.org/fhir" required>
              <mat-hint>Base URI for ValueSets</mat-hint>
            </mat-form-field>
            <mat-form-field>
              <mat-label>ValueSet Name</mat-label>
              <input matInput [(ngModel)]="valueSetName" placeholder="ExampleValueSet" required>
            </mat-form-field>
            <mat-form-field>
              <mat-label>Version</mat-label>
              <input matInput [(ngModel)]="valueSetVersion" placeholder="1.0.0">
            </mat-form-field>
            @if (isMap) {
              <div class="mapping-mode-option">
                <mat-checkbox [(ngModel)]="mapBetweenValueSets">
                  Map between ValueSets (instead of CodeSystems)
                </mat-checkbox>
                <p class="option-hint">
                  When enabled, the ConceptMap will reference ValueSet URIs instead of CodeSystem URIs
                </p>
              </div>
            }
          </div>
        </div>
      }
      <!-- Execute Action Button -->
      @if (selectedAction && selectedAction !== 'code-display-excel') {
        <div class="execute-action">
          <button
            mat-raised-button
            color="primary"
            (click)="executeAction()"
            [disabled]="isLoading || !canExecuteAction()"
            class="execute-button"
            >
            <mat-icon>{{ getActionIcon() }}</mat-icon>
            <span>{{ getActionButtonText() }}</span>
          </button>
        </div>
      }
      @if (selectedAction || targetPreviewData.length > 0 || targetValueSet) {
        <div class="step-divider">
          <h3>Step 4: Review and Download</h3>
        </div>
      }
      <!-- Target Preview Table -->
      @if (targetPreviewData.length > 0 || isTranslationLoading) {
        <div class="target-preview-table">
          <h3 class="target-preview-title">
            <mat-icon>preview</mat-icon>
            Target Preview ({{ visibleTargetPreviewRows.length }} of {{ targetPreviewData.length }} rows)
          </h3>
          @if (!isTranslationLoading) {
            <div class="target-table-container">
              <table mat-table [dataSource]="visibleTargetPreviewRows" class="target-preview-data-table">
                <ng-container matColumnDef="code">
                  <th mat-header-cell *matHeaderCellDef>Code</th>
                  <td mat-cell *matCellDef="let row">{{ row.code }}</td>
                </ng-container>
                <ng-container matColumnDef="originalDisplay">
                  <th mat-header-cell *matHeaderCellDef>Original Display</th>
                  <td mat-cell *matCellDef="let row">{{ row.originalDisplay }}</td>
                </ng-container>
                <ng-container matColumnDef="translatedDisplay">
                  <th mat-header-cell *matHeaderCellDef>Translated Display</th>
                  <td mat-cell *matCellDef="let row">{{ row.translatedDisplay }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="targetPreviewColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: targetPreviewColumns"></tr>
              </table>
            </div>
            @if (canLoadMoreTargetPreviewRows) {
              <div class="preview-actions">
                <button mat-stroked-button color="primary" (click)="loadMoreTargetPreviewRows()">
                  <mat-icon>expand_more</mat-icon>
                  <span>Load more</span>
                </button>
              </div>
            }
          } @else {
            <div class="loading-container">
              <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
              <p class="loading-text">Generating translation preview...</p>
            </div>
          }
        </div>
      }
      <!-- Download Options -->
      @if (targetValueSet && selectedAction) {
        <div class="download-options">
          <h3 class="download-title">
            <mat-icon>get_app</mat-icon>
            Download Options
          </h3>
          <div class="download-buttons">
            @if (selectedAction === 'translate' || selectedAction === 'target-valueset') {
              <button
                mat-raised-button
                color="primary"
                class="download-button"
                (click)="downloadTargetValueSet()"
                [disabled]="isLoading"
                >
                <mat-icon>download</mat-icon>
                <span>Download Target ValueSet</span>
              </button>
            }
            @if (selectedAction === 'translate' || selectedAction === 'target-valueset') {
              <button
                mat-raised-button
                color="accent"
                class="download-button"
                (click)="downloadTargetAsExcel()"
                [disabled]="isLoading"
                >
                <mat-icon>table_view</mat-icon>
                <span>Download as Excel</span>
              </button>
            }
            @if (selectedAction === 'source-valueset') {
              <button
                mat-raised-button
                color="primary"
                class="download-button"
                (click)="downloadSourceValueSet()"
                [disabled]="isLoading"
                >
                <mat-icon>download</mat-icon>
                <span>Download Source ValueSet</span>
              </button>
            }
            @if (selectedAction === 'translate-target') {
              <button
                mat-raised-button
                color="primary"
                class="download-button"
                (click)="downloadTranslatedFile()"
                [disabled]="isLoading"
                >
                <mat-icon>download</mat-icon>
                <span>Download Translated Map File</span>
              </button>
            }
            @if (selectedAction === 'fhir-package') {
              <button
                mat-raised-button
                color="primary"
                class="download-button"
                (click)="generateFHIRPackage()"
                [disabled]="isLoading"
                >
                <mat-icon>archive</mat-icon>
                <span>Generate FHIR Package</span>
              </button>
            }
          </div>
        </div>
      }
      @if (codeDisplayExported) {
        <div class="export-confirmation">
          <h3>
            <mat-icon>check_circle</mat-icon>
            Export Completed
          </h3>
          <p>
            Code/display table exported successfully with {{ codeDisplayExportedCount }} concepts.
          </p>
        </div>
      }
    </div>
  }
</div>
