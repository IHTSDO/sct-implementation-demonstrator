<div class="main-container">
    <h2>ValueSet Utility</h2>
    <p class="instructions">
        Load a file (Excel, CSV, TSV, or FHIR ValueSet JSON) or enter an ECL expression to start. 
    </p>
    
    <!-- Language indicators -->
    <div *ngIf="translationEnabled">
        <div class="floating-indicators" *ngIf="showIndicators">
            <div class="indicator edition-indicator">
                <div class="indicator-arrow">↑</div>
                <div class="indicator-text">Select Edition</div>
            </div>
            <div class="indicator language-indicator">
                <div class="indicator-arrow">↑</div>
                <div class="indicator-text">Select Language</div>
            </div>
        </div>

        <div class="terminology-context">
            <p>Target terminology context:</p>
            <ul>
                <li><strong>Edition:</strong> {{ terminologyContext.editionName }}</li>
                <li><strong>Version:</strong> {{ terminologyContext.fhirUrlParam }}</li>
                <li><strong>Language:</strong> {{ terminologyContext.language }}</li>
            </ul>
        </div>
    </div>

    <!-- Loading Indicator for File Preview -->
    <div *ngIf="isFileLoading" class="loading-container">
        <mat-progress-spinner
            mode="indeterminate"
            diameter="40"
        ></mat-progress-spinner>
        <p class="loading-text">Processing your file...</p>
    </div>

    <!-- Import Controls -->
    <div *ngIf="!isFileLoading">
        <!-- File Upload Section -->
        <div class="upload-section">
            <h3 class="upload-title">
                <mat-icon>cloud_upload</mat-icon>
                Upload Data
            </h3>
            <div class="input-method-buttons">
                <button 
                    mat-raised-button 
                    color="primary" 
                    class="input-method-button"
                    (click)="fileInput.click()"
                    *ngIf="!showEclInput"
                >
                    <mat-icon>upload_file</mat-icon>
                    <span>Choose File (Excel/CSV/TSV/TXT/JSON)</span>
                </button>
                <button 
                    mat-raised-button 
                    [color]="showEclInput ? 'accent' : 'primary'"
                    class="input-method-button"
                    (click)="toggleEclInput()"
                >
                    <mat-icon>code</mat-icon>
                    <span>{{ showEclInput ? 'Cancel ECL' : 'Enter ECL Expression' }}</span>
                </button>
            </div>
            <input
                type="file"
                (change)="onFileSelected($event)"
                accept=".xlsx,.xls,.csv,.tsv,.txt,.json"
                #fileInput
                style="display: none"
            />
            <span *ngIf="file" class="file-name">{{ file.name }}</span>
            <div *ngIf="isMap" class="map-notice">
                <mat-icon color="primary">info</mat-icon>
                <span>Snap2Snomed Map detected - Columns configured automatically</span>
            </div>
            <div *ngIf="isRf2Refset" class="refset-notice">
                <mat-icon color="accent">description</mat-icon>
                <span>RF2 Refset detected</span>
            </div>
            <div *ngIf="isValueSetFile" class="valueset-notice">
                <mat-icon color="primary">schema</mat-icon>
                <span>FHIR ValueSet JSON detected</span>
            </div>
            <div *ngIf="file && !isMap && !isRf2Refset && !isValueSetFile && showPreview" class="spreadsheet-notice">
                <mat-icon color="primary">table_chart</mat-icon>
                <span>Simple spreadsheet detected</span>
            </div>
        </div>

        <!-- ECL Input Section -->
        <div *ngIf="showEclInput" class="ecl-input-section">
            <h3 class="ecl-title">
                <mat-icon>code</mat-icon>
                ECL Expression
            </h3>
            <div class="ecl-content">
                <mat-form-field appearance="fill" class="ecl-textarea">
                    <mat-label>Enter ECL Expression</mat-label>
                    <textarea 
                        matInput 
                        [(ngModel)]="eclExpression" 
                        placeholder="Enter your ECL expression here..."
                        rows="4"
                    ></textarea>
                </mat-form-field>
                <button
                    mat-raised-button
                    color="primary"
                    class="ecl-button"
                    (click)="expandEcl()"
                    [disabled]="!eclExpression.trim()"
                >
                    <mat-icon>expand_more</mat-icon>
                    <span>Expand ECL</span>
                </button>
            </div>
        </div>

        <!-- Preview Table -->
        <div *ngIf="showPreview && previewData.length > 0 && !isLoading" class="preview-table">
            <h3 class="preview-title">
                <mat-icon>table_view</mat-icon>
                Preview (First 5 rows)
            </h3>
            <div class="table-container">
                <table mat-table [dataSource]="previewData.slice(1, 6)" class="preview-data-table">
                    <ng-container *ngFor="let col of columns; let i = index">
                        <ng-container [matColumnDef]="i.toString()">
                            <th mat-header-cell *matHeaderCellDef>{{ col.header }}</th>
                            <td mat-cell *matCellDef="let row">{{ row[i] }}</td>
                        </ng-container>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
            </div>
        </div>

        <!-- Column Selection Form -->
        <form [formGroup]="importForm" *ngIf="showPreview && !isValueSetFile && !isMap && !isRf2Refset && !isEclResult" class="column-form">
            <h3 class="column-form-title">
                <mat-icon>view_column</mat-icon>
                Select Columns
            </h3>
            
            <div class="column-selection-row">
                <mat-form-field appearance="fill">
                    <mat-label>Code Column</mat-label>
                    <mat-select formControlName="codeColumn" required>
                        <mat-option *ngFor="let col of columns" [value]="col.index">
                            {{ col.header }}
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="importForm.get('codeColumn')?.hasError('required')">
                        Please select a code column
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                    <mat-label>Display Column (Optional)</mat-label>
                    <mat-select formControlName="displayColumn">
                        <mat-option *ngFor="let col of columns" [value]="col.index">
                            {{ col.header }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-checkbox formControlName="skipHeader" class="skip-header">
                    Skip header row
                </mat-checkbox>
            </div>
        </form>

        <!-- Action Selection -->
        <div *ngIf="showPreview && previewData.length > 0 && !selectedAction && !isLoading && (isValueSetFile || isMap || isRf2Refset || importForm.get('codeColumn')?.value !== null)" class="action-selection">
            <h3 class="action-title">
                <mat-icon>play_circle</mat-icon>
                What would you like to do?
            </h3>
            
            <div class="action-buttons">
                <button
                    mat-raised-button
                    color="primary"
                    (click)="selectAction('translate')"
                    class="action-button"
                >
                    <mat-icon>translate</mat-icon>
                    <span>Translate the set of concepts</span>
                </button>
                
                <button
                    mat-raised-button
                    color="accent"
                    (click)="selectAction('source-valueset')"
                    class="action-button"
                >
                    <mat-icon>list_alt</mat-icon>
                    <span>Generate FHIR ValueSet (identical to uploaded concepts)</span>
                </button>
                
                <button
                    mat-raised-button
                    color="accent"
                    (click)="selectAction('target-valueset')"
                    class="action-button"
                >
                    <mat-icon>language</mat-icon>
                    <span>Generate FHIR ValueSet (with translated display terms)</span>
                </button>
                
                <button
                    *ngIf="isMap"
                    mat-raised-button
                    color="warn"
                    (click)="selectAction('translate-target')"
                    class="action-button"
                >
                    <mat-icon>swap_horiz</mat-icon>
                    <span>Translate target column (Snap2Snomed Map)</span>
                </button>
                
                <button
                    *ngIf="isMap"
                    mat-raised-button
                    color="warn"
                    (click)="selectAction('fhir-package')"
                    class="action-button"
                >
                    <mat-icon>archive</mat-icon>
                    <span>Create FHIR Package (Snap2Snomed Map)</span>
                </button>
            </div>
        </div>

        <!-- Edition and Language Selectors for Translation Actions -->
        <div *ngIf="selectedAction === 'translate' || selectedAction === 'target-valueset' || selectedAction === 'translate-target' || selectedAction === 'fhir-package'" class="translation-selectors">
            <h3 class="translation-selectors-title">
                <mat-icon>language</mat-icon>
                Output Language
            </h3>
            <div class="translation-selectors-content">
                <!-- Edition Selector Button and Menu -->
                <button mat-raised-button color="primary" [matMenuTriggerFor]="editionMenu" class="translation-button edition-button">
                    <mat-icon>book</mat-icon>
                    <span>{{ terminologyContext.editionName }}</span>
                </button>
                <mat-menu #editionMenu="matMenu">
                    <button mat-menu-item *ngFor="let edition of editionsDetails" (click)="onEditionChange(edition.editionName)">{{ edition.editionName }}</button>
                </mat-menu>

                <!-- Unified Language Selector Button and Menu -->
                <button mat-raised-button color="accent" [matMenuTriggerFor]="langMenu" class="translation-button language-button">
                    <mat-icon>translate</mat-icon>
                    <span>{{ selectedLanguageDisplayLabel }}</span>
                </button>
                <mat-menu #langMenu="matMenu">
                    <p *ngIf="selectedLanRefsetConcept && !selectedContext" class="menu-text">Selected Language Refset</p>
                    <p *ngIf="selectedLanRefsetConcept && !selectedContext" class="menu-text">{{ selectedLanRefsetConcept.display }}</p>
                    <p *ngIf="selectedLanRefsetConcept && !selectedContext" class="menu-text">{{ selectedLanRefsetConcept.code }}</p>
                    <p *ngIf="selectedContext" class="menu-text">Selected Language Context</p>
                    <p *ngIf="selectedContext" class="menu-text">{{ selectedContext.name }}</p>
                    <button mat-menu-item [matMenuTriggerFor]="langCodesMenu">Language Codes</button>
                    <button mat-menu-item [matMenuTriggerFor]="langRefsetsMenu">Language Refsets</button>
                    <button mat-menu-item [matMenuTriggerFor]="langContextsMenu">Language Contexts</button>
                </mat-menu>

                <mat-menu #langCodesMenu="matMenu">
                    <button mat-menu-item *ngFor="let language of languages" (click)="onLanguageChange(language)">{{language}}</button>
                </mat-menu>

                <mat-menu #langRefsetsMenu="matMenu">
                    <button mat-menu-item *ngFor="let langRefset of languageRefsets" (click)="onLanguageRefsetChange(langRefset)">{{langRefset.display}}</button>
                </mat-menu>

                <mat-menu #langContextsMenu="matMenu">
                    <button mat-menu-item *ngFor="let context of contexts" (click)="onContextChange(context)">{{context.name}}</button>
                </mat-menu>
            </div>
        </div>

        <!-- ValueSet Metadata Form -->
        <div *ngIf="selectedAction && (selectedAction === 'source-valueset' || selectedAction === 'target-valueset' || selectedAction === 'fhir-package')" class="valueset-metadata">
            <h3 class="valueset-metadata-title">
                <mat-icon>info</mat-icon>
                ValueSet Metadata
            </h3>
            <div class="valueset-metadata-content">
                <mat-form-field>
                    <mat-label>ValueSet URI</mat-label>
                    <input matInput [(ngModel)]="valueSetUri" placeholder="http://example.org/fhir/ValueSet/example" required>
                </mat-form-field>

                <mat-form-field>
                    <mat-label>ValueSet Name</mat-label>
                    <input matInput [(ngModel)]="valueSetName" placeholder="ExampleValueSet" required>
                </mat-form-field>

                <mat-form-field>
                    <mat-label>Version</mat-label>
                    <input matInput [(ngModel)]="valueSetVersion" placeholder="1.0.0">
                </mat-form-field>
            </div>
        </div>

        <!-- Execute Action Button -->
        <div *ngIf="selectedAction" class="execute-action">
            <button
                mat-raised-button
                color="primary"
                (click)="executeAction()"
                [disabled]="isLoading || !canExecuteAction()"
                class="execute-button"
            >
                <mat-icon>{{ getActionIcon() }}</mat-icon>
                <span>{{ getActionButtonText() }}</span>
            </button>
        </div>

        <!-- Target Preview Table -->
        <div *ngIf="targetPreviewData.length > 0 || isTranslationLoading" class="target-preview-table">
            <h3 class="target-preview-title">
                <mat-icon>preview</mat-icon>
                Target Preview (First 10 rows)
            </h3>
            <ng-container *ngIf="!isTranslationLoading; else loadingPreview">
                <div class="target-table-container">
                    <table mat-table [dataSource]="targetPreviewData.slice(0, 10)" class="target-preview-data-table">
                        <ng-container matColumnDef="code">
                            <th mat-header-cell *matHeaderCellDef>Code</th>
                            <td mat-cell *matCellDef="let row">{{ row.code }}</td>
                        </ng-container>

                        <ng-container matColumnDef="originalDisplay">
                            <th mat-header-cell *matHeaderCellDef>Original Display</th>
                            <td mat-cell *matCellDef="let row">{{ row.originalDisplay }}</td>
                        </ng-container>

                        <ng-container matColumnDef="translatedDisplay">
                            <th mat-header-cell *matHeaderCellDef>Translated Display</th>
                            <td mat-cell *matCellDef="let row">{{ row.translatedDisplay }}</td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="targetPreviewColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: targetPreviewColumns"></tr>
                    </table>
                </div>
            </ng-container>
            <ng-template #loadingPreview>
                <div class="loading-container">
                    <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
                    <p class="loading-text">Generating translation preview...</p>
                </div>
            </ng-template>
        </div>

        <!-- Download Options -->
        <div *ngIf="targetValueSet && selectedAction" class="download-options">
            <h3 class="download-title">
                <mat-icon>get_app</mat-icon>
                Download Options
            </h3>
            <div class="download-buttons">
                <button
                    *ngIf="selectedAction === 'translate' || selectedAction === 'target-valueset'"
                    mat-raised-button
                    color="primary"
                    class="download-button"
                    (click)="downloadTargetValueSet()"
                    [disabled]="isLoading"
                >
                    <mat-icon>download</mat-icon>
                    <span>Download Target ValueSet</span>
                </button>
                <button
                    *ngIf="selectedAction === 'translate' || selectedAction === 'target-valueset'"
                    mat-raised-button
                    color="accent"
                    class="download-button"
                    (click)="downloadTargetAsExcel()"
                    [disabled]="isLoading"
                >
                    <mat-icon>table_view</mat-icon>
                    <span>Download as Excel</span>
                </button>
                <button
                    *ngIf="selectedAction === 'source-valueset'"
                    mat-raised-button
                    color="primary"
                    class="download-button"
                    (click)="downloadSourceValueSet()"
                    [disabled]="isLoading"
                >
                    <mat-icon>download</mat-icon>
                    <span>Download Source ValueSet</span>
                </button>
                <button
                    *ngIf="selectedAction === 'translate-target'"
                    mat-raised-button
                    color="primary"
                    class="download-button"
                    (click)="downloadTranslatedFile()"
                    [disabled]="isLoading"
                >
                    <mat-icon>download</mat-icon>
                    <span>Download Translated Map File</span>
                </button>
                <button
                    *ngIf="selectedAction === 'fhir-package'"
                    mat-raised-button
                    color="primary"
                    class="download-button"
                    (click)="generateFHIRPackage()"
                    [disabled]="isLoading"
                >
                    <mat-icon>archive</mat-icon>
                    <span>Generate FHIR Package</span>
                </button>
            </div>
        </div>
        <mat-progress-bar mode="indeterminate" *ngIf="isProcessing"></mat-progress-bar>
    </div>
</div>