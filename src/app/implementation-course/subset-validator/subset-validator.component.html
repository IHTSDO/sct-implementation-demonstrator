<!-- subset-validator.component.html -->
<div class="layout-container">
  <div class="left-column">
    <div class="upload-controls">
      <h3>Subset Members Validator</h3>
      <p class="mb-4">Validating against {{ terminologyService.getFhirUrlParam() }}</p>
      @if (studentSubsetDefinition) {
        <p class="terminal-style">{{studentSubsetDefinition}}</p>
      }
      <input type="file" #fileInput style="display: none" (change)="onSubsetmembersFileSelected($event)" />
      <input type="file" #fileInputDefinition style="display: none" (change)="onDefinitionFileSelected($event)" />
      <div class="buttons-panel">
        <button mat-flat-button color="primary" (click)="fileInputDefinition.click()" [disabled]="!selectedAssignment.referenceDefinition">
          Upload Definition File
        </button>
        <button mat-flat-button color="primary" (click)="fileInput.click()">Upload Members File</button>
        <button mat-flat-button color="primary" (click)="validateAssignment()"
        [disabled]="!studentSubsetMembersDataSource.data.length">Validate</button>
        @if (loading) {
          <mat-spinner class="spinner" diameter="30"></mat-spinner>
        }
      </div>
      @if (!loading && membersNotInRefrenceListResult) {
        <div class="blue-rounded-div">
          <h3 class="text-white mb-1">Validation Results</h3>
          @if (selectedAssignment.referenceDefinition) {
            <p class="validation-result">{{definitionVsMembersValidationResult}}</p>
          }
          @if (selectedAssignment.referenceDefinition) {
            <p class="validation-result">{{keyConceptValidationResult}}</p>
          }
          <p class="validation-result">{{membersNotInRefrenceListResult}}</p>
          <p class="validation-result">{{refrenceListVsStudentListResult}}</p>
        </div>
      }
    </div>
    <!-- Table to display the data -->
    @if (!loading && studentSubsetMembersDataSource.data.length) {
      <div class="table-container">
        <table mat-table [dataSource]="studentSubsetMembersDataSource">
          <!-- Referenced Component ID Column -->
          <ng-container matColumnDef="referencedComponentId">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let element">{{ element.referencedComponentId }}</td>
          </ng-container>
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let element">{{ element.name }}</td>
          </ng-container>
          <!-- Result Column -->
          <ng-container matColumnDef="result">
            <th mat-header-cell *matHeaderCellDef>Result</th>
            <td mat-cell *matCellDef="let element">
              @if (membersValidationResult) {
                <span>
                  @if (element?.inReferenceList?.value) {
                    <span>OK</span>
                  }
                  @if (!element?.inReferenceList?.value && element?.customMessage?.value) {
                    <span>
                      {{ element.customMessage.note }}
                    </span>
                  }
                  @if (!element?.inReferenceList?.value && !element?.customMessage?.value) {
                    <span>
                      Error
                    </span>
                  }
                </span>
              }
            </td>
          </ng-container>
          <!-- Result Column -->
          <!-- <ng-container matColumnDef="scope">
          <th mat-header-cell *matHeaderCellDef>Definition</th>
          <td mat-cell *matCellDef="let element">{{ element.scope.value }}</td>
        </ng-container> -->
        <!-- Header and Rows -->
        <tr mat-header-row *matHeaderRowDef="studentSubsetMembersDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: studentSubsetMembersDisplayedColumns;" [ngClass]="{'bg-pink': !row.inReferenceList?.value && membersValidationResult}"></tr>
      </table>
    </div>
  }
</div>
<div class="right-column">
  @if (!embeddedMode) {
    <div>
      <h3>Assignment</h3>
      <button mat-flat-button color="accent" [matMenuTriggerFor]="demosMenu">Selected assignment: {{ selectedAssignment?.name }}</button>
      <mat-menu #demosMenu="matMenu" class="wide-menu">
        @for (item of assignments; track item) {
          <button mat-menu-item (click)="setAssignment(item)">{{ item.name }}</button>
        }
      </mat-menu>
    </div>
  }
  @if (embeddedMode) {
    <h3>
      Assignment: {{ selectedAssignment?.name }}
    </h3>
  }
  <h3>Instructions</h3>
  <div class="instructions">
    @if (selectedAssignment.referenceDefinition) {
      <ol>
        <li>1- Upload definition file</li>
        <li>2- Upload members file</li>
        <li>3- Click validate</li>
      </ol>
    }
    @if (!selectedAssignment.referenceDefinition) {
      <ol>
        <li>1- Upload members file</li>
        <li>2- Click validate</li>
      </ol>
    }
  </div>
  @if (!embeddedMode) {
    <div>
      <div>
        <h3>Reference Data</h3>
        <mat-form-field appearance="fill">
          <mat-label>Textarea</mat-label>
          <textarea matInput [(ngModel)]="assignmentsString"></textarea>
        </mat-form-field>
        <button mat-flat-button color="primary" (click)="updateAssignments()">Update Assignments</button>
      </div>
    </div>
  }

  <!-- <div *ngIf="referenceDataDataSource.data.length" class="table-container">
  <table mat-table [dataSource]="referenceDataDataSource">
    <ng-container matColumnDef="referencedComponentId">
      <th mat-header-cell *matHeaderCellDef>ID</th>
      <td mat-cell *matCellDef="let element">{{ element.referencedComponentId }}</td>
    </ng-container>
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Name</th>
      <td mat-cell *matCellDef="let element">{{ element.name }}</td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="referenceDataDisplayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: referenceDataDisplayedColumns;"></tr>
  </table>
</div> -->
</div>
</div>
