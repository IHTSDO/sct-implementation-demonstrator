<div class="snoguess-game" *ngIf="(game | async) as gameState">
  <div *ngIf="gameState.state == 'playing' || gameState.state == 'loading'">

    <div class="flex justify-center items-center">
      <img src="assets/img/snoguess-logo.png" alt="Game Logo" class="w-1/4 mt-8 mb-8">
    </div>

    <div class="term-display" *ngIf="gameState.state == 'playing'">
        <span *ngFor="let char of gameState.displayTerm">{{ char }}</span>
    </div>
    
    <div *ngIf="gameState.state === 'loading'" class="loading-container">
      <div class="progress-bar-message">
        Choosing a random SNOMED CT concept using the FHIR API
      </div>
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    </div>
    
    <div class="hit-points">
      <span class="score">
        Score: {{ gameState.score }} &nbsp;&nbsp;&nbsp;&nbsp; Life:
      </span>
      <span *ngFor="let hp of [].constructor(gameState.hitPoints); let i = index">
          <mat-icon>favorite</mat-icon>
      </span>
      <span *ngFor="let hp of [].constructor(gameState.maxHitPoints - gameState.hitPoints); let i = index">
          <mat-icon>favorite_border</mat-icon>
      </span>
    </div>

    <p class="guess-message">Click the keys to guess the letters of the term!</p>
    <div [@shake]="shakeState">
      <app-keyboard #keyboard (letterGuessed)="guessLetter($event)"></app-keyboard>
    </div>  

    <div class="guess-field mt-8">
      <button mat-flat-button color="accent" (click)="revealHint()" (keydown.enter)="$event.preventDefault()" [disabled]="gameState.state !== 'playing' || !gameState.hintsAvailable || gameState.hitPoints <= 1">Reveal Hint</button>
      <button mat-flat-button color="accent" (click)="loadMenu()" (keydown.enter)="$event.preventDefault()" [disabled]="gameState.state !== 'playing'">Abandon game</button>
    </div>
    <div class="note">
      * Hints are generated from the definition of the SNOMED CT concept, retrieved from the FHIR API as an SCG grammar expression
    </div>
    
    <div *ngIf="gameState.hints.length > 0" class="hints-container">
      <div class="hints-callout text-center">
        <h2>Hints:</h2>
        <ul>
          <li *ngFor="let hint of gameState.hints" [innerHTML]="hint"></li>
        </ul>
      </div>
    </div>

    <div class="score-progression-panel">
      <h3>Score Progression</h3>
      <div class="progress-bar-container">
        <mat-progress-bar mode="determinate" [value]="calculateProgress(gameState.score)"></mat-progress-bar>
        <!-- Goal Indicators and Trophy icons generated dynamically -->
        <ng-container *ngFor="let goal of goals">
          <div class="goal-indicator" [class]="goal.name.toLowerCase()" [style.left.%]="calculateGoalPosition(goal.score)"></div>
          <mat-icon *ngIf="gameState.score >= goal.score" class="star-icon left-star" [ngClass]="[goal.name.toLowerCase()]" [style.left.%]="calculateGoalPosition(goal.score-5)">grade</mat-icon>
          <mat-icon class="trophy-icon" [ngClass]="[goal.name.toLowerCase(), (gameState.score >= goal.score) ? 'trophy-large' : '']" [style.left.%]="calculateGoalPosition(goal.score-3)">emoji_events</mat-icon>
          <mat-icon *ngIf="gameState.score >= goal.score" class="star-icon right-star" [ngClass]="[goal.name.toLowerCase()]" [style.left.%]="calculateGoalPosition(goal.score-1)">grade</mat-icon>
          <div *ngIf="gameState.score >= goal.score" class="goal-name" [style.left.%]="calculateGoalPosition(goal.score)" [ngClass]="[goal.name.toLowerCase()]">{{ goal.name }} trophy!</div>
        </ng-container>
      </div>
    </div>
  </div>
  

  <div *ngIf="gameState.state === 'menu'" class="flex flex-col items-center gap-4">
    <img src="assets/img/SI_CT_w_tagline.png" alt="SNOMED CT Logo" class="w-1/6">
    <img src="assets/img/snoguess-logo.png" alt="Game Logo" class="w-1/4 mt-8" [@popIn]>
    <p class="text-center">Welcome to SnoGuess!<br>A fun way to learn about SNOMED CT concepts and their definitions.</p>
    <div (click)="startGame()" [@scrollUp]
    class="bg-gradient-to-b from-blue-500 to-gray-500 hover:from-black hover:to-blue-500 border-solid border-4 border-black 
    rounded-3xl pl-12 pr-12 pt-4 pb-4 w-1/5 text-center cursor-pointer font-bold text-white mt-12 mb-24 text-3xl">
      New game
    </div>
  </div>

  <div *ngIf="termGuessed" class="overlay overlay-transparent">
    <img src="assets/img/correct.png" alt="Correct" class="w-1/5 mt-8" [@popIn]>
    <!-- <div class="text-xl shadow-local">{{ termGuessed }}</div> -->
  </div>

  <div *ngIf="gameState.state === 'gameOver'" class="flex flex-col items-center gap-4">
    <img src="assets/img/SI_CT_w_tagline.png" alt="SNOMED CT Logo" class="w-1/6">
    <img src="assets/img/game-over.png" alt="Game Logo" class="w-1/4 mt-8" [@popIn]>
    
    <div> The term was: </div>
    <div> {{ gameState.term }}</div>
    <div>Final Score: {{ gameState.score }}</div>
    <div *ngIf="getMaxTrophyObtained(gameState.score)">
      Trophy: {{ getMaxTrophyObtained(gameState.score) }}
    </div>
    <div *ngIf="getMaxTrophyObtained(gameState.score)">
      <mat-icon class="" [ngClass]="[getMaxTrophyObtained(gameState.score).toLocaleLowerCase(), 'shadow-local']">grade</mat-icon>
      &nbsp;&nbsp;
      <mat-icon class="" [ngClass]="[getMaxTrophyObtained(gameState.score).toLocaleLowerCase(), 'trophy-large', 'shadow-local']">emoji_events</mat-icon>
      &nbsp;
      <mat-icon class="" [ngClass]="[getMaxTrophyObtained(gameState.score).toLocaleLowerCase(), 'shadow-local']">grade</mat-icon>
    </div>

    <div (click)="startGame()" [@scrollUp]
    class="bg-gradient-to-b from-blue-500 to-gray-500 hover:from-black hover:to-blue-500 border-solid border-4 border-black 
    rounded-3xl pt-4 pb-4 w-1/6 text-center cursor-pointer font-bold text-white mt-12 text-2xl">
      New game
    </div>
    <div (click)="loadMenu()" [@scrollUp]
    class="bg-gradient-to-b from-blue-500 to-gray-500 hover:from-black hover:to-blue-500 border-solid border-4 border-black 
    rounded-3xl pt-4 pb-4 w-1/6 text-center cursor-pointer font-bold text-white mt-12 mb-24 text-2xl">
      Main menu
    </div>
  </div>

  <div *ngIf="gameState.state == 'won'" class="flex flex-col items-center gap-4">
    <img src="assets/img/SI_CT_w_tagline.png" alt="SNOMED CT Logo" class="w-1/6">
    <img src="assets/img/congratulations.png" alt="Game Logo" class="w-1/3 mt-8" [@popIn]>
    <div class="">
      <mat-icon class="large-icon diamond shadow-local">grade</mat-icon>
      <mat-icon class="large-icon diamond shadow-local">emoji_events</mat-icon>
      <mat-icon class="large-icon diamond shadow-local">grade</mat-icon>
    </div>
    <div class="reveal won">Final score: {{ gameState.score }}</div>

    <div (click)="startGame()" [@scrollUp]
    class="bg-gradient-to-b from-blue-500 to-gray-500 hover:from-black hover:to-blue-500 border-solid border-4 border-black 
    rounded-3xl pt-4 pb-4 w-1/6 text-center cursor-pointer font-bold text-white mt-12 text-2xl">
      New game
    </div>
    <div (click)="loadMenu()" [@scrollUp]
    class="bg-gradient-to-b from-blue-500 to-gray-500 hover:from-black hover:to-blue-500 border-solid border-4 border-black 
    rounded-3xl pt-4 pb-4 w-1/6 text-center cursor-pointer font-bold text-white mt-12 mb-24 text-2xl">
      Main menu
    </div>
  </div>

</div>
