<div class="observation-result-form-container">
  <h2 mat-dialog-title class="form-header-title">{{ isViewOnly ? 'View Observation Result Information' : 'Observation Result Information' }}</h2>
  <div mat-dialog-content class="observation-result-dialog-content">
    <p class="form-subtitle">
      EHDS Laboratory Observation Result - FHIR Observation Profile
      <button type="button" mat-button class="fhir-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu.html', 'Observation Profile', 'FHIR Resource')">
        FHIR
      </button>
    </p>

    <form [formGroup]="observationForm" (ngSubmit)="onSubmit()" class="observation-result-form">
      <!-- Basic Information -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>info</mat-icon>
          Basic Information
        </h3>
        <div class="form-grid">
          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="statusMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('https://hl7.org/fhir/valueset-observation-status.html', 'Status')">
                BINDING
              </button>
            </div>
            <mat-menu #statusMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.status</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.status" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The status of the result value.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">1..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from ObservationStatus (required to <a href="https://hl7.org/fhir/ValueSet/observation-status" target="_blank" rel="noopener noreferrer" class="valueset-link">https://hl7.org/fhir/ValueSet/observation-status|4.0.1</a>).</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Status *</mat-label>
              <mat-select formControlName="status" required>
                <mat-option [value]="null">Select status</mat-option>
                @for (status of statusOptions; track status) {
                  <mat-option [value]="status.code">
                    {{ status.display }}
                  </mat-option>
                }
              </mat-select>
              @if (observationForm.get('status')?.value) {
                <mat-hint>
                  {{ getStatusDefinition(observationForm.get('status')?.value) }}
                </mat-hint>
              }
            </mat-form-field>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="codeMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabCodeWithExceptions.html', 'Code')">
                BINDING
              </button>
              @if (loincCode) {
                <button type="button" mat-button class="fhir-badge loinc-badge" (click)="openSnomedLookup()" [title]="'View SNOMED CT concept details (LOINC: ' + loincCode + ')'">
                  LOINC: {{ loincCode }}
                </button>
              }
            </div>
            <mat-menu #codeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.code</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.code" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">Describes what was observed. Sometimes this is called the observation "name".</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">1..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from eHDSI Lab Code With Exceptions (required to <a href="https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabCodeWithExceptions.html" target="_blank" rel="noopener noreferrer" class="valueset-link">https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabCodeWithExceptions.html</a>).</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <app-autocomplete-binding
              [binding]="codeBinding"
              formControlName="code"
              [terminologyServer]="'https://browser.loincsnomed.org/fhir'"
              [editionUri]="'http://snomed.info/sct/11010000107'"
              [readonly]="isViewOnly"
              (selectionChange)="onCodeSelected($event)">
            </app-autocomplete-binding>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="effectiveDateTimeMenu">
                FHIR
              </button>
            </div>
            <mat-menu #effectiveDateTimeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.effectiveDateTime</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.effectiveDateTime" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The time or time-period the observed value is asserted as being true.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">dateTime</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Effective Date/Time</mat-label>
              <input matInput [matDatepicker]="effectivePicker" formControlName="effectiveDateTime" readonly>
              <mat-datepicker-toggle matSuffix [for]="effectivePicker"></mat-datepicker-toggle>
              <mat-datepicker #effectivePicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="specimenMenu">
                FHIR
              </button>
            </div>
            <mat-menu #specimenMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.specimen</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.specimen" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The specimen that was used when this observation was made.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Short:</span>
                    <span class="fhir-value">Specimen used for this observation</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Comments:</span>
                    <span class="fhir-value">When the specimen is applicable and known it shall be documented. Should only be used if not implicit in code found in Observation.code. Observations are not made on specimens themselves; they are made on a subject, but in many cases by the means of a specimen. Note that although specimens are often involved, they are not always tracked and reported explicitly. Also note that observation resources may be used in contexts that track the specimen explicitly (e.g. Diagnostic Report).</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">Reference(Specimen: Laboratory, Specimen)</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Is Modifier:</span>
                    <span class="fhir-value">false</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Obligations:</span>
                    <span class="fhir-value">SHALL:handle - LabReportHandler</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Summary:</span>
                    <span class="fhir-value">false</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Invariants:</span>
                    <span class="fhir-value">ele-1: All FHIR elements must have a &#64;value or children (hasValue() or (children().count() > id.count()))</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Specimen</mat-label>
              <mat-select formControlName="specimen" [disabled]="isViewOnly || availableSpecimens.length === 0">
                <mat-option [value]="null">No specimen selected</mat-option>
                @for (specimen of availableSpecimens; track specimen.reference) {
                  <mat-option [value]="specimen">
                    {{ specimen.display }}
                  </mat-option>
                }
              </mat-select>
              @if (availableSpecimens.length === 0) {
                <mat-hint>No specimens available. Add specimens to the Diagnostic Report first.</mat-hint>
              }
              @if (observationForm.get('specimen')?.hasError('required') && observationForm.get('specimen')?.touched) {
                <mat-error>Specimen is required</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Result Value -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>bar_chart</mat-icon>
          Result Value
        </h3>
        <div class="form-grid value-type-grid"
          [class.quantity-layout]="valueType === 'quantity'"
          [class.string-layout]="valueType === 'string'"
          [class.codeable-concept-layout]="valueType === 'codeableConcept'">
          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueTypeMenu">
                FHIR
              </button>
            </div>
            <mat-menu #valueTypeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.value[x]</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The information determined as a result of making the observation.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">Quantity | CodeableConcept | string | boolean | integer | Range | Ratio | SampledData | time | dateTime | Period</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Value Type</mat-label>
              <mat-select [(value)]="valueType" (selectionChange)="updateValueType()" [disabled]="isViewOnly">
                <mat-option value="quantity">Quantity</mat-option>
                <mat-option value="string">String</mat-option>
                <mat-option value="codeableConcept">Codeable Concept</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          @if (valueType === 'quantity') {
            <div class="fhir-field-wrapper">
              <div class="fhir-badges-container">
                <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueQuantityMenu">
                  FHIR
                </button>
              </div>
              <mat-menu #valueQuantityMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
                <div class="fhir-menu-content">
                  <div class="fhir-menu-header">
                    <h4>Observation.valueQuantity.value</h4>
                    <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                      <mat-icon>link</mat-icon>
                    </a>
                  </div>
                  <div class="fhir-menu-body">
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Definition:</span>
                      <span class="fhir-value">The numerical value (with implicit precision).</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Control:</span>
                      <span class="fhir-value">0..1</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Type:</span>
                      <span class="fhir-value">decimal</span>
                    </div>
                  </div>
                </div>
              </mat-menu>
              <mat-form-field>
                <mat-label>Value</mat-label>
                <input matInput type="number" [formControl]="valueQuantityValueControl" [readonly]="isViewOnly" placeholder="e.g., 12.5">
              </mat-form-field>
            </div>
          }

          @if (valueType === 'quantity') {
            <div class="fhir-field-wrapper">
              <div class="fhir-badges-container">
                <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueQuantityUnitMenu">
                  FHIR
                </button>
                <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('http://hl7.org/fhir/ValueSet/ucum-units', 'Unit', 'UCUM Units')">
                  BINDING
                </button>
              </div>
              <mat-menu #valueQuantityUnitMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
                <div class="fhir-menu-content">
                  <div class="fhir-menu-header">
                    <h4>Observation.valueQuantity.unit</h4>
                    <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                      <mat-icon>link</mat-icon>
                    </a>
                  </div>
                  <div class="fhir-menu-body">
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Definition:</span>
                      <span class="fhir-value">A human-readable form of the unit.</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Control:</span>
                      <span class="fhir-value">0..1</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Type:</span>
                      <span class="fhir-value">string</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Binding:</span>
                      <span class="fhir-value">The codes SHALL be taken from UCUM Codes (required to <a href="http://hl7.org/fhir/ValueSet/ucum-units" target="_blank" rel="noopener noreferrer" class="valueset-link">http://hl7.org/fhir/ValueSet/ucum-units</a>).</span>
                    </div>
                  </div>
                </div>
              </mat-menu>
              <mat-form-field>
                <mat-label>Unit</mat-label>
                @if (unitOptionsLoading) {
                  <mat-spinner matSuffix diameter="20"></mat-spinner>
                }
                <input
                  matInput
                  [formControl]="unitInputControl"
                  [matAutocomplete]="unitAuto"
                  [readonly]="isViewOnly"
                  placeholder="Search UCUM units...">
                <mat-autocomplete
                  #unitAuto="matAutocomplete"
                  [displayWith]="displayUnitFn"
                  (optionSelected)="onUnitSelected($event)"
                  (closed)="onUnitAutocompleteClosed()">
                  @if (unitOptionsLoading) {
                    <mat-option disabled>
                      <mat-spinner diameter="35"></mat-spinner>
                      Loading UCUM units...
                    </mat-option>
                  } @else {
                    @for (unit of unitFilteredOptions | async; track unit.code) {
                      <mat-option [value]="unit">
                        {{ unit.display }}@if (unit.display !== unit.code) {
                          <span class="unit-code-hint"> ({{ unit.code }})</span>
                        }
                      </mat-option>
                    }
                  }
                </mat-autocomplete>
              </mat-form-field>
            </div>
          }

          @if (valueType === 'string') {
            <div class="fhir-field-wrapper">
              <div class="fhir-badges-container">
                <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueStringMenu">
                  FHIR
                </button>
              </div>
              <mat-menu #valueStringMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
                <div class="fhir-menu-content">
                  <div class="fhir-menu-header">
                    <h4>Observation.valueString</h4>
                    <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                      <mat-icon>link</mat-icon>
                    </a>
                  </div>
                  <div class="fhir-menu-body">
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Definition:</span>
                      <span class="fhir-value">The information determined as a result of making the observation (when value is a string).</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Control:</span>
                      <span class="fhir-value">0..1</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Type:</span>
                      <span class="fhir-value">string</span>
                    </div>
                  </div>
                </div>
              </mat-menu>
              <mat-form-field>
                <mat-label>Value (String)</mat-label>
                <input matInput formControlName="valueString" [readonly]="isViewOnly" placeholder="Enter text value">
              </mat-form-field>
            </div>
          }

          @if (valueType === 'codeableConcept') {
            <div class="fhir-field-wrapper">
              <div class="fhir-badges-container">
                <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueCodeableConceptMenu">
                  FHIR
                </button>
                <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSIResultsCodedValueLaboratory.html', 'Value (Codeable Concept)', 'eHDSI Results Coded Value Laboratory')">
                  BINDING
                </button>
              </div>
              <mat-menu #valueCodeableConceptMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
                <div class="fhir-menu-content">
                  <div class="fhir-menu-header">
                    <h4>Observation.valueCodeableConcept</h4>
                    <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                      <mat-icon>link</mat-icon>
                    </a>
                  </div>
                  <div class="fhir-menu-body">
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Definition:</span>
                      <span class="fhir-value">The information determined as a result of making the observation (when value is a CodeableConcept).</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Control:</span>
                      <span class="fhir-value">0..1</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Type:</span>
                      <span class="fhir-value">CodeableConcept</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Binding:</span>
                      <span class="fhir-value">The codes SHALL be taken from eHDSI Results Coded Value Laboratory with exceptions (required to <a href="https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSIResultsCodedValueLaboratory.html" target="_blank" rel="noopener noreferrer" class="valueset-link">https://fhir.ehdsi.eu/laboratory/ValueSet/eHDSIResultsCodedValueLaboratory</a>).</span>
                    </div>
                  </div>
                </div>
              </mat-menu>
              <mat-form-field>
                <mat-label>Value (Codeable Concept)</mat-label>
                @if (valueCodeableConceptOptionsLoading) {
                  <mat-spinner matSuffix diameter="20"></mat-spinner>
                }
                <input
                  matInput
                  [formControl]="valueCodeableConceptInputControl"
                  [matAutocomplete]="valueCodeableConceptAuto"
                  [readonly]="isViewOnly"
                  placeholder="Search eHDSI Results Coded Value...">
                <mat-autocomplete
                  #valueCodeableConceptAuto="matAutocomplete"
                  [displayWith]="displayValueCodeableConceptFn"
                  (optionSelected)="onValueCodeableConceptSelected($event)">
                  @if (valueCodeableConceptOptionsLoading) {
                    <mat-option disabled>
                      <mat-spinner diameter="35"></mat-spinner>
                      Loading codes...
                    </mat-option>
                  } @else {
                    @for (option of valueCodeableConceptFilteredOptions | async; track option.code) {
                      <mat-option [value]="option">
                        {{ option.display }}@if (option.display !== option.code) {
                          <span class="unit-code-hint"> ({{ option.code }})</span>
                        }
                      </mat-option>
                    }
                  }
                </mat-autocomplete>
              </mat-form-field>
            </div>
          }
        </div>
      </div>

      <!-- Interpretation & Reference Range -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>assessment</mat-icon>
          Interpretation & Reference Range
        </h3>
        <div class="form-grid">
          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="interpretationMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSIObservationInterpretationWithExceptions.html', 'Interpretation')">
                BINDING
              </button>
            </div>
            <mat-menu #interpretationMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.interpretation</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.interpretation" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">A categorical assessment of an observation value.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..*</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from eHDSI Observation Interpretation with exceptions (required to <a href="https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSIObservationInterpretationWithExceptions.html" target="_blank" rel="noopener noreferrer" class="valueset-link">http://fhir.ehdsi.eu/laboratory/ValueSet/eHDSIObservationInterpretationWithExceptions</a>).</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Interpretation</mat-label>
              <mat-select formControlName="interpretation">
                <mat-option [value]="null">Select interpretation</mat-option>
                @for (interpretation of interpretationOptions; track interpretation) {
                  <mat-option [value]="interpretation">
                    {{ interpretation.display }} ({{ interpretation.code }})
                  </mat-option>
                }
              </mat-select>
              @if (observationForm.get('interpretation')?.value) {
                <mat-hint>
                  Code: {{ observationForm.get('interpretation')?.value?.code || '' }}
                </mat-hint>
              }
            </mat-form-field>
          </div>

          @if (valueType === 'quantity') {
            <div class="fhir-field-wrapper">
              <div class="fhir-badges-container">
                <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="referenceRangeMenu">
                  FHIR
                </button>
              </div>
              <mat-menu #referenceRangeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
                <div class="fhir-menu-content">
                  <div class="fhir-menu-header">
                    <h4>Observation.referenceRange</h4>
                    <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.referenceRange" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                      <mat-icon>link</mat-icon>
                    </a>
                  </div>
                  <div class="fhir-menu-body">
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Definition:</span>
                      <span class="fhir-value">Guidance on how to interpret the value by comparison to a normal or recommended range.</span>
                    </div>
                    <div class="fhir-menu-item">
                      <span class="fhir-label">Control:</span>
                      <span class="fhir-value">0..*</span>
                    </div>
                  </div>
                </div>
              </mat-menu>
              <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                <mat-form-field>
                  <mat-label>Range Low</mat-label>
                  <input matInput type="number" [formControl]="referenceRangeLowValueControl" [readonly]="isViewOnly" placeholder="e.g., 12.0">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Range Low Unit</mat-label>
                  <input matInput [formControl]="referenceRangeLowUnitControl" readonly placeholder="e.g., g/dL">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Range High</mat-label>
                  <input matInput type="number" [formControl]="referenceRangeHighValueControl" [readonly]="isViewOnly" placeholder="e.g., 15.0">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Range High Unit</mat-label>
                  <input matInput [formControl]="referenceRangeHighUnitControl" readonly placeholder="e.g., g/dL">
                </mat-form-field>
              </div>
            </div>
          }

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="methodMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabTechniqueWithExceptions.html', 'Method', 'eHDSI Laboratory Technique with exceptions')">
                BINDING
              </button>
            </div>
            <mat-menu #methodMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.method</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.method" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">Indicates the mechanism used to perform the observation.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">CodeableConcept</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from eHDSI Laboratory Technique with exceptions (required to <a href="https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabTechniqueWithExceptions.html" target="_blank" rel="noopener noreferrer" class="valueset-link">http://fhir.ehdsi.eu/laboratory/ValueSet/eHDSILabTechniqueWithExceptions</a>).</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Comments:</span>
                    <span class="fhir-value">Laboratory technique (method of measurement) are integral parts of the test specification. Only used if not implicit in code for Observation.code.</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Method</mat-label>
              @if (methodOptionsLoading) {
                <mat-spinner matSuffix diameter="20"></mat-spinner>
              }
              <input
                matInput
                [formControl]="methodInputControl"
                [matAutocomplete]="methodAuto"
                #methodAutoTrigger="matAutocompleteTrigger"
                [readonly]="isViewOnly"
                (focus)="onMethodInputFocus()"
                placeholder="Search laboratory technique...">
              <mat-autocomplete
                #methodAuto="matAutocomplete"
                [displayWith]="displayMethodFn"
                (optionSelected)="onMethodSelected($event)"
                (closed)="onMethodAutocompleteClosed()">
                @if (methodOptionsLoading) {
                  <mat-option disabled>
                    <mat-spinner diameter="35"></mat-spinner>
                    Loading techniques...
                  </mat-option>
                } @else {
                  @for (option of methodFilteredOptions | async; track option.code) {
                    <mat-option [value]="option">
                      {{ option.display }}@if (option.display !== option.code) {
                        <span class="unit-code-hint"> ({{ option.code }})</span>
                      }
                    </mat-option>
                  }
                }
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <div class="fhir-field-wrapper full-width">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="noteMenu">
                FHIR
              </button>
            </div>
            <mat-menu #noteMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.note</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.note" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">Comments about the observation or the results.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..*</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field class="full-width-field">
              <mat-label>Note</mat-label>
              <input matInput formControlName="note" [readonly]="isViewOnly" placeholder="Additional notes about the observation">
            </mat-form-field>
          </div>
        </div>
      </div>

    </form>
  </div>
  <div mat-dialog-actions class="form-actions">
    <button type="button" mat-button (click)="onCancel()" class="cancel-button">
      <mat-icon>{{ isViewOnly ? 'close' : 'cancel' }}</mat-icon>
      {{ isViewOnly ? 'Close' : 'Cancel' }}
    </button>
    @if (!isViewOnly) {
      <button type="button" mat-raised-button color="primary" (click)="onSubmit()" class="submit-button">
        <mat-icon>save</mat-icon>
        Save Observation Result
      </button>
    }
  </div>
</div>

