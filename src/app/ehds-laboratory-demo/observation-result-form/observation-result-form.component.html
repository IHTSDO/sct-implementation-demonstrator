<div class="observation-result-form-container">
  <h2 mat-dialog-title class="form-header-title">{{ isViewOnly ? 'View Observation Result Information' : 'Observation Result Information' }}</h2>
  <div mat-dialog-content class="observation-result-dialog-content">
    <p class="form-subtitle">
      EHDS Laboratory Observation Result - FHIR Observation Profile
      <button type="button" mat-button class="fhir-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu.html', 'Observation Profile', 'FHIR Resource')">
        FHIR
      </button>
    </p>

    <form [formGroup]="observationForm" (ngSubmit)="onSubmit()" class="observation-result-form">
      <!-- Basic Information -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>info</mat-icon>
          Basic Information
        </h3>
        <div class="form-grid">
          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="statusMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('http://hl7.org/fhir/ValueSet/observation-status', 'Status')">
                BINDING
              </button>
            </div>
            <mat-menu #statusMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.status</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.status" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The status of the result value.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">1..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from ObservationStatus (required to <a href="http://hl7.org/fhir/ValueSet/observation-status" target="_blank" rel="noopener noreferrer" class="valueset-link">http://hl7.org/fhir/ValueSet/observation-status|4.0.1</a>).</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Status *</mat-label>
              <mat-select formControlName="status" required>
                <mat-option [value]="null">Select status</mat-option>
                <mat-option *ngFor="let status of statusOptions" [value]="status.code">
                  {{ status.display }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="observationForm.get('status')?.value">
                {{ getStatusDefinition(observationForm.get('status')?.value) }}
              </mat-hint>
            </mat-form-field>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="codeMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabCodeWithExceptions.html', 'Code')">
                BINDING
              </button>
              <button *ngIf="loincCode" type="button" mat-button class="fhir-badge loinc-badge" disabled>
                LOINC: {{ loincCode }}
              </button>
            </div>
            <mat-menu #codeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.code</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.code" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">Describes what was observed. Sometimes this is called the observation "name".</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">1..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from eHDSI Lab Code With Exceptions (required to <a href="https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabCodeWithExceptions.html" target="_blank" rel="noopener noreferrer" class="valueset-link">https://fhir.ehdsi.eu/laboratory/ValueSet-eHDSILabCodeWithExceptions.html</a>).</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <app-autocomplete-binding 
              [binding]="codeBinding" 
              formControlName="code"
              [terminologyServer]="'https://browser.loincsnomed.org/fhir'"
              [editionUri]="'http://snomed.info/sct/11010000107'"
              [readonly]="isViewOnly"
              (selectionChange)="onCodeSelected($event)">
            </app-autocomplete-binding>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="effectiveDateTimeMenu">
                FHIR
              </button>
            </div>
            <mat-menu #effectiveDateTimeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.effectiveDateTime</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.effectiveDateTime" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The time or time-period the observed value is asserted as being true.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">dateTime</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Effective Date/Time</mat-label>
              <input matInput [matDatepicker]="effectivePicker" formControlName="effectiveDateTime" readonly>
              <mat-datepicker-toggle matSuffix [for]="effectivePicker"></mat-datepicker-toggle>
              <mat-datepicker #effectivePicker></mat-datepicker>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Result Value -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>bar_chart</mat-icon>
          Result Value
        </h3>
        <div class="form-grid value-type-grid" 
             [class.quantity-layout]="valueType === 'quantity'"
             [class.string-layout]="valueType === 'string'"
             [class.codeable-concept-layout]="valueType === 'codeableConcept'">
          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueTypeMenu">
                FHIR
              </button>
            </div>
            <mat-menu #valueTypeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.value[x]</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The information determined as a result of making the observation.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">Quantity | CodeableConcept | string | boolean | integer | Range | Ratio | SampledData | time | dateTime | Period</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Value Type</mat-label>
              <mat-select [(value)]="valueType" (selectionChange)="updateValueType()" [disabled]="isViewOnly">
                <mat-option value="quantity">Quantity</mat-option>
                <mat-option value="string">String</mat-option>
                <mat-option value="codeableConcept">Codeable Concept</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div *ngIf="valueType === 'quantity'" class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueQuantityMenu">
                FHIR
              </button>
            </div>
            <mat-menu #valueQuantityMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.valueQuantity.value</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The numerical value (with implicit precision).</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">decimal</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Value</mat-label>
              <input matInput type="number" [formControl]="valueQuantityValueControl" [readonly]="isViewOnly" placeholder="e.g., 12.5">
            </mat-form-field>
          </div>

          <div *ngIf="valueType === 'quantity'" class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueQuantityUnitMenu">
                FHIR
              </button>
            </div>
            <mat-menu #valueQuantityUnitMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.valueQuantity.unit</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">A human-readable form of the unit.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">string</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Unit</mat-label>
              <mat-select [formControl]="valueQuantityUnitControl" [disabled]="isViewOnly">
                <mat-option [value]="''">Select unit</mat-option>
                <mat-option *ngFor="let unit of unitOptions" [value]="unit.code">
                  {{ unit.display }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div *ngIf="valueType === 'string'" class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueStringMenu">
                FHIR
              </button>
            </div>
            <mat-menu #valueStringMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.valueString</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The information determined as a result of making the observation (when value is a string).</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">string</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Value (String)</mat-label>
              <input matInput formControlName="valueString" [readonly]="isViewOnly" placeholder="Enter text value">
            </mat-form-field>
          </div>

          <div *ngIf="valueType === 'codeableConcept'" class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="valueCodeableConceptMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge sct-badge" (click)="openValuesetDialog('http://snomed.info/sct', 'SNOMED CT')">
                BINDING (SCT)
              </button>
            </div>
            <mat-menu #valueCodeableConceptMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.valueCodeableConcept</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.value" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">The information determined as a result of making the observation (when value is a CodeableConcept).</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..1</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Type:</span>
                    <span class="fhir-value">CodeableConcept</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <app-autocomplete-binding 
              [binding]="valueCodeableConceptBinding" 
              formControlName="valueCodeableConcept"
              [readonly]="isViewOnly">
            </app-autocomplete-binding>
          </div>
        </div>
      </div>

      <!-- Interpretation & Reference Range -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>assessment</mat-icon>
          Interpretation & Reference Range
        </h3>
        <div class="form-grid">
          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="interpretationMenu">
                FHIR
              </button>
              <button type="button" mat-button class="fhir-badge valueset-badge" (click)="openValuesetDialog('http://hl7.org/fhir/ValueSet/observation-interpretation', 'Interpretation')">
                BINDING
              </button>
            </div>
            <mat-menu #interpretationMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.interpretation</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.interpretation" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">A categorical assessment of an observation value.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..*</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Binding:</span>
                    <span class="fhir-value">The codes SHALL be taken from Observation Interpretation Codes (required to <a href="http://hl7.org/fhir/ValueSet/observation-interpretation" target="_blank" rel="noopener noreferrer" class="valueset-link">http://hl7.org/fhir/ValueSet/observation-interpretation|4.0.1</a>).</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Interpretation</mat-label>
              <mat-select formControlName="interpretation">
                <mat-option [value]="null">Select interpretation</mat-option>
                <mat-option *ngFor="let interpretation of interpretationOptions" [value]="interpretation">
                  {{ interpretation.display }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="observationForm.get('interpretation')?.value">
                Code: {{ observationForm.get('interpretation')?.value?.code || '' }}
              </mat-hint>
            </mat-form-field>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="referenceRangeMenu">
                FHIR
              </button>
            </div>
            <mat-menu #referenceRangeMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.referenceRange</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.referenceRange" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">Guidance on how to interpret the value by comparison to a normal or recommended range.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..*</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Reference Range (Text)</mat-label>
              <input matInput [formControl]="referenceRangeTextControl" [readonly]="isViewOnly" placeholder="e.g., 12.0 - 15.0 g/dL">
            </mat-form-field>
          </div>

          <div class="fhir-field-wrapper">
            <div class="fhir-badges-container">
              <button type="button" mat-button class="fhir-badge" [matMenuTriggerFor]="noteMenu">
                FHIR
              </button>
            </div>
            <mat-menu #noteMenu="matMenu" class="fhir-info-menu" [overlapTrigger]="false" [panelClass]="'fhir-menu-panel'">
              <div class="fhir-menu-content">
                <div class="fhir-menu-header">
                  <h4>Observation.note</h4>
                  <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-Observation-resultslab-lab-myhealtheu-definitions.html#Observation.note" target="_blank" rel="noopener noreferrer" class="fhir-menu-link">
                    <mat-icon>link</mat-icon>
                  </a>
                </div>
                <div class="fhir-menu-body">
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Definition:</span>
                    <span class="fhir-value">Comments about the observation or the results.</span>
                  </div>
                  <div class="fhir-menu-item">
                    <span class="fhir-label">Control:</span>
                    <span class="fhir-value">0..*</span>
                  </div>
                </div>
              </div>
            </mat-menu>
            <mat-form-field>
              <mat-label>Note</mat-label>
              <input matInput formControlName="note" [readonly]="isViewOnly" placeholder="Additional notes about the observation">
            </mat-form-field>
          </div>
        </div>
      </div>

    </form>
  </div>
  <div mat-dialog-actions class="form-actions">
    <button type="button" mat-button (click)="onCancel()" class="cancel-button">
      <mat-icon>{{ isViewOnly ? 'close' : 'cancel' }}</mat-icon>
      {{ isViewOnly ? 'Close' : 'Cancel' }}
    </button>
    <button *ngIf="!isViewOnly" type="button" mat-raised-button color="primary" (click)="onSubmit()" class="submit-button">
      <mat-icon>save</mat-icon>
      Save Observation Result
    </button>
  </div>
</div>

