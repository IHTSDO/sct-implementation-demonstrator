<div class="flip-card-wrapper">
  <div class="flip-card" [class.flipped]="isFlipped">
      <!-- FRONT SIDE - Form -->
      <div class="flip-card-front">
        <div class="form-header">
          <div class="header-row">
            <div>
              <h2>EHDS Laboratory Diagnostic Report</h2>
              <p class="form-subtitle">MyHealth&#64;EU Laboratory Report - FHIR DiagnosticReport Profile</p>
            </div>
            <button type="button" mat-raised-button color="primary" (click)="flipCard()">
              <mat-icon>code</mat-icon>
              See FHIR Resource
            </button>
          </div>
        </div>

        <form [formGroup]="diagnosticReportForm" (ngSubmit)="onSubmit()" class="diagnostic-report-form">
    
    <!-- Identification & Status -->
    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>assignment</mat-icon>
        Identification & Status
      </h3>
      <div class="form-grid form-grid-4cols">
        <mat-form-field>
          <mat-label>Status *</mat-label>
          <mat-select formControlName="status" required>
            <mat-option *ngFor="let status of statusOptions" [value]="status">
              {{ status | titlecase }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="diagnosticReportForm.get('status')?.hasError('required')">
            Status is required
          </mat-error>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Date/Time *</mat-label>
          <input matInput [matDatepicker]="reportDatePicker" formControlName="reportDateTime" required>
          <mat-datepicker-toggle matSuffix [for]="reportDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #reportDatePicker></mat-datepicker>
          <mat-hint>Used for both effective and issued</mat-hint>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Language</mat-label>
          <mat-select formControlName="language">
            <mat-option value="">Select language</mat-option>
            <mat-option *ngFor="let lang of languageOptions" [value]="lang.code">
              {{ lang.display }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Identifier</mat-label>
          <input matInput formControlName="identifier" placeholder="Optional identifier">
        </mat-form-field>
      </div>
    </div>

    <!-- Categorization -->
    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>category</mat-icon>
        Categorization
      </h3>
      <div formGroupName="category" class="form-grid">
        <mat-form-field>
          <mat-label>Report Type</mat-label>
          <input matInput [value]="diagnosticReportForm.get('code')?.value?.display || 'Laboratory report'" readonly>
          <mat-hint>LOINC: {{ diagnosticReportForm.get('code')?.value?.code || '11502-2' }}</mat-hint>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Study Type</mat-label>
          <mat-select formControlName="studyType">
            <mat-option [value]="null">Select study type</mat-option>
            <mat-option *ngFor="let type of studyTypeOptions" [value]="type">
              {{ type.display }}
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="diagnosticReportForm.get('category.studyType')?.value">
            LOINC: {{ diagnosticReportForm.get('category.studyType')?.value?.code || '' }}
          </mat-hint>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Specialty</mat-label>
          <mat-select formControlName="specialty">
            <mat-option value="">Select specialty</mat-option>
            <mat-option *ngFor="let specialty of specialtyOptions" [value]="specialty">
              {{ specialty }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Subject & Personnel -->
    <div class="form-section">
      <div class="combined-section">
        <!-- Subject (1/3) -->
        <div class="subject-box">
          <h3 class="section-title">
            <mat-icon>person</mat-icon>
            Subject (Patient)
          </h3>
          <div class="reference-section">
            <div *ngIf="!hasSubject" class="reference-placeholder">
              <mat-icon>person_add</mat-icon>
              <p>No patient selected</p>
              <button type="button" mat-raised-button color="primary" (click)="onAddSubject()" [disabled]="true">
                <mat-icon>add</mat-icon>
                Add Patient
              </button>
            </div>
            <div *ngIf="hasSubject" class="reference-display">
              <div class="reference-info">
                <mat-icon>person</mat-icon>
                <span>Patient reference added</span>
                <button type="button" mat-icon-button (click)="diagnosticReportForm.patchValue({ subject: null })">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Personnel (2/3) -->
        <div class="personnel-box">
          <h3 class="section-title">
            <mat-icon>people</mat-icon>
            Personnel & Organization
          </h3>
          <div class="personnel-grid">
            <div class="reference-item">
              <div *ngIf="!hasPerformer" class="reference-placeholder">
                <mat-icon>person_add</mat-icon>
                <p>No performer selected</p>
                <button type="button" mat-raised-button color="primary" (click)="onAddPerformer()" [disabled]="true">
                  <mat-icon>add</mat-icon>
                  Add Performer
                </button>
              </div>
              <div *ngIf="hasPerformer" class="reference-display">
                <div class="reference-info">
                  <mat-icon>person</mat-icon>
                  <span>Performer reference added</span>
                  <button type="button" mat-icon-button (click)="diagnosticReportForm.patchValue({ performer: null })">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <div class="reference-item">
              <div *ngIf="!hasResultsInterpreter" class="reference-placeholder">
                <mat-icon>person_add</mat-icon>
                <p>No results interpreter selected</p>
                <button type="button" mat-raised-button color="primary" (click)="onAddResultsInterpreter()" [disabled]="true">
                  <mat-icon>add</mat-icon>
                  Add Results Interpreter
                </button>
              </div>
              <div *ngIf="hasResultsInterpreter" class="reference-display">
                <div class="reference-info">
                  <mat-icon>person</mat-icon>
                  <span>Results interpreter reference added</span>
                  <button type="button" mat-icon-button (click)="diagnosticReportForm.patchValue({ resultsInterpreter: null })">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order/Request -->
    <div class="form-section">
      <mat-expansion-panel #orderRequestPanel [expanded]="false" class="compact-expansion-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>assignment_turned_in</mat-icon>
            <span>Order/Request</span>
            <span *ngIf="hasBasedOn" class="status-badge">Linked</span>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="reference-section">
          <div *ngIf="!hasBasedOn" class="reference-placeholder">
            <mat-icon>add_task</mat-icon>
            <p>No service request linked</p>
            <button type="button" mat-raised-button color="primary" (click)="onAddBasedOn()" [disabled]="true">
              <mat-icon>add</mat-icon>
              Add Service Request
            </button>
          </div>
          <div *ngIf="hasBasedOn" class="reference-display">
            <div class="reference-info">
              <mat-icon>assignment</mat-icon>
              <span>ServiceRequest reference added</span>
              <button type="button" mat-icon-button (click)="diagnosticReportForm.patchValue({ basedOn: null })">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </div>

    <!-- Specimen -->
    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>science</mat-icon>
        Specimen
      </h3>
      <div class="reference-section">
        <div *ngIf="specimens.length === 0" class="reference-placeholder">
          <mat-icon>science</mat-icon>
          <p>No specimens added</p>
          <button type="button" mat-raised-button color="primary" (click)="onAddSpecimen()">
            <mat-icon>add</mat-icon>
            Add Specimen
          </button>
        </div>

        <div *ngIf="specimens.length > 0" class="reference-list">
          <div *ngFor="let specimen of specimens; let i = index" class="reference-item-display">
            <div class="reference-info">
              <mat-icon>science</mat-icon>
              <div class="specimen-details">
                <span class="specimen-title">Specimen {{ i + 1 }}</span>
                <div class="specimen-info" *ngIf="specimen.type">
                  <span class="specimen-type">{{ specimen.type.display }}</span>
                  <span class="specimen-status" *ngIf="specimen.status"> • {{ getStatusDisplay(specimen.status) }}</span>
                  <span class="specimen-container" *ngIf="specimen.containerType"> • {{ specimen.containerType.display }}</span>
                </div>
              </div>
              <div class="specimen-actions">
                <button type="button" mat-icon-button color="primary" (click)="editSpecimen(i)" title="Edit specimen">
                  <mat-icon>edit</mat-icon>
                </button>
                <button type="button" mat-icon-button color="warn" (click)="removeSpecimen(i)" title="Delete specimen">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
          <div class="add-more-button">
            <button type="button" mat-raised-button color="primary" (click)="onAddSpecimen()">
              <mat-icon>add</mat-icon>
              Add Specimen
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results (Observations) -->
    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>bar_chart</mat-icon>
        Results (Observations)
      </h3>
      <div class="reference-section">
        <div *ngIf="results.length === 0" class="reference-placeholder">
          <mat-icon>bar_chart</mat-icon>
          <p>No results added</p>
          <button type="button" mat-raised-button color="primary" (click)="onAddResult()" [disabled]="true">
            <mat-icon>add</mat-icon>
            Add Result
          </button>
        </div>

        <div *ngIf="results.length > 0" class="reference-list">
          <div *ngFor="let result of results; let i = index" class="reference-item-display">
            <div class="reference-info">
              <mat-icon>bar_chart</mat-icon>
              <span>Observation Result {{ i + 1 }}</span>
              <button type="button" mat-icon-button color="warn" (click)="removeResult(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div class="add-more-button">
            <button type="button" mat-raised-button color="primary" (click)="onAddResult()" [disabled]="true">
              <mat-icon>add</mat-icon>
              Add Result
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Conclusion -->
    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>summarize</mat-icon>
        Conclusion
      </h3>
      <div class="combined-section">
        <!-- Interpretation -->
        <div class="conclusion-interpretation-box">
          <mat-form-field class="full-width">
            <mat-label>Clinical Conclusion (Interpretation)</mat-label>
            <textarea matInput formControlName="conclusion" rows="3" 
                      placeholder="Concise and clinically contextualized summary conclusion of the diagnostic report"></textarea>
          </mat-form-field>
        </div>

        <!-- Conclusion Codes -->
        <div class="conclusion-codes-box">
          <div class="reference-section">
            <div *ngIf="conclusionCodes.length === 0" class="reference-placeholder">
              <mat-icon>code</mat-icon>
              <p>No conclusion codes added</p>
              <button type="button" mat-raised-button color="primary" (click)="onAddConclusionCode()" [disabled]="true">
                <mat-icon>add</mat-icon>
                Add Conclusion Code
              </button>
            </div>

            <div *ngIf="conclusionCodes.length > 0" class="reference-list">
              <div *ngFor="let code of conclusionCodes; let i = index" class="reference-item-display">
                <div class="reference-info">
                  <mat-icon>code</mat-icon>
                  <span>Conclusion Code {{ i + 1 }}</span>
                  <button type="button" mat-icon-button color="warn" (click)="removeConclusionCode(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              <div class="add-more-button">
                <button type="button" mat-raised-button color="primary" (click)="onAddConclusionCode()" [disabled]="true">
                  <mat-icon>add</mat-icon>
                  Add Conclusion Code
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Presented Form (PDF) -->
    <div class="form-section">
      <h3 class="section-title">
        <mat-icon>picture_as_pdf</mat-icon>
        Presented Form (PDF Document)
      </h3>
      <div class="reference-section">
        <div *ngIf="!diagnosticReportForm.get('presentedForm')?.value" class="reference-placeholder">
          <mat-icon>upload_file</mat-icon>
          <p>No PDF document uploaded</p>
          <button type="button" mat-raised-button color="primary" (click)="onUploadPresentedForm()" [disabled]="true">
            <mat-icon>upload</mat-icon>
            Upload PDF Document
          </button>
        </div>
        <div *ngIf="diagnosticReportForm.get('presentedForm')?.value" class="reference-display">
          <div class="reference-info">
            <mat-icon>picture_as_pdf</mat-icon>
            <span>PDF document uploaded</span>
            <button type="button" mat-icon-button (click)="diagnosticReportForm.patchValue({ presentedForm: null })">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" mat-button (click)="onCancel()" class="cancel-button">
        <mat-icon>cancel</mat-icon>
        Cancel
      </button>
      <button type="submit" mat-raised-button color="primary" class="submit-button">
        <mat-icon>save</mat-icon>
        Submit Diagnostic Report
      </button>
    </div>
        </form>
      </div>

      <!-- BACK SIDE - FHIR JSON -->
      <div class="flip-card-back">
        <div class="fhir-header">
          <div class="header-row">
            <div>
              <h2>FHIR DiagnosticReport Resource</h2>
              <p class="fhir-profile-link">
                <a href="https://fhir.ehdsi.eu/laboratory/StructureDefinition-DiagnosticReport-lab-myhealtheu.html" target="_blank" rel="noopener noreferrer">
                  <mat-icon>link</mat-icon>
                  EHDS Laboratory Profile
                </a>
              </p>
            </div>
            <button type="button" mat-raised-button color="primary" (click)="flipCard()">
              <mat-icon>arrow_back</mat-icon>
              Back to Form
            </button>
          </div>
        </div>
        <div class="fhir-output-container">
          <div class="fhir-actions">
            <button mat-icon-button (click)="downloadFhirResource()" matTooltip="Download FHIR Resource">
              <mat-icon>cloud_download</mat-icon>
            </button>
            <button mat-icon-button (click)="copyToClipboard()" matTooltip="Copy FHIR Resource">
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>
          <textarea highlight-js [options]="{}" [lang]="'json'" class="fhir-json-output" [innerHTML]="fhirJson || 'Fill out the form and flip to see the FHIR resource'" wrap="soft"></textarea>
        </div>
      </div>
  </div>
</div>
