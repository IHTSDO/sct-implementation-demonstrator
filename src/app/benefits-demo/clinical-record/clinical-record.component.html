<div class="clinical-record-container">
  <!-- Header with patient info and navigation -->
  <div class="record-header">
    <div class="header-left">
      <button mat-flat-button color="primary" (click)="goBack()">
        ‚Üê Back to Patient List
      </button>
    </div>
    <div class="header-center" *ngIf="patient">
      <h1>{{ getPatientDisplayName(patient) }}</h1>
      <div class="patient-meta">
        <span class="patient-id">ID: {{ getPatientIdentifier(patient) }}</span>
        <span class="patient-dob" *ngIf="patient.birthDate">DOB: {{ patient.birthDate | date:'MMM dd, yyyy' }}</span>
        <span class="patient-age" *ngIf="patient.birthDate">Age: {{ getPatientAge(patient.birthDate) }}</span>
        <span class="patient-gender" *ngIf="patient.gender">{{ patient.gender }}</span>
        <span class="patient-status" [class.active]="patient.active">
          {{ patient.active ? 'Active' : 'Inactive' }}
        </span>
      </div>
    </div>
    <div class="header-right">
      <div class="current-date">
        {{ currentDate | date:'longDate' }}
      </div>
      <button mat-stroked-button 
              color="warn" 
              (click)="deleteAllEvents()"
              [disabled]="isLoadingMapping"
              title="Delete all clinical events for this patient"
              class="delete-all-button">
        <mat-icon>delete_sweep</mat-icon>
        Delete All Events
      </button>
    </div>
  </div>

  <!-- Main content area -->
  <div class="record-content" *ngIf="patient">
    <!-- Patient Demographics Section -->
    <div class="record-section">
      <h2>Summary</h2>
      <div class="demographics-container">
        <div class="demographics-left">
          <div class="clinical-events-summary">
            <div class="clinical-summary-section">
              <h5>Conditions</h5>
              <div class="clinical-summary-list" *ngIf="conditions.length > 0; else noConditions">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let condition of getSortedConditions() | slice:0:6; let i = index"
                     (mouseenter)="onConditionHover(condition, $event)"
                     (mouseleave)="onConditionHoverEnd()">
                  <div class="item-name">{{ condition.code.text }}</div>
                </div>
                <div class="clinical-summary-item" *ngIf="conditions.length > 6" style="font-style: italic; color: #6c757d;">
                  +{{ conditions.length - 6 }} more conditions
                </div>
              </div>
              <ng-template #noConditions>
                <div class="no-clinical-data">No conditions recorded</div>
              </ng-template>
            </div>

            <div class="clinical-summary-section">
              <h5>Procedures</h5>
              <div class="clinical-summary-list" *ngIf="procedures.length > 0; else noProcedures">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let procedure of getSortedProcedures() | slice:0:4"
                     (mouseenter)="onProcedureHover(procedure, $event)"
                     (mouseleave)="onConditionHoverEnd()">
                  <div class="item-name">{{ procedure.code.text }}</div>
                </div>
                <div class="clinical-summary-item" *ngIf="procedures.length > 4" style="font-style: italic; color: #6c757d;">
                  +{{ procedures.length - 4 }} more procedures
                </div>
              </div>
              <ng-template #noProcedures>
                <div class="no-clinical-data">No procedures recorded</div>
              </ng-template>
            </div>
          </div>
        </div>
        <div class="demographics-middle">
          <div class="body-model-container">
            <div class="model-with-annotations">
              <img 
                [src]="getBodyModelImage(patient.gender)" 
                [alt]="'Human body model - ' + (patient.gender || 'unspecified')"
                class="body-model-image"
              />
              
              <!-- Loading Overlay -->
              <div *ngIf="isLoadingMapping" class="mapping-loader-overlay">
                <div class="mapping-spinner"></div>
                <div class="mapping-loader-text">Updating event mappings...</div>
              </div>
              
              <!-- Anchor Points (hidden during loading) -->
              <div 
                *ngFor="let anchorPoint of anchorPoints" 
                class="anchor-point"
                [class.active]="getEventCountForAnchorPoint(anchorPoint.id) > 0"
                [class.empty]="!hasAssociatedEvents(anchorPoint)"
                [class.systemic]="anchorPoint.type === 'systemic'"
                [style.left.%]="patient.gender === 'female' ? anchorPoint.x + 4 : anchorPoint.x"
                [style.top.%]="anchorPoint.y"
                [style.display]="isLoadingMapping ? 'none' : 'block'"
                [style.background-color]="anchorPoint.defaultColor"
                [attr.data-anchor-id]="anchorPoint.id"
                [attr.data-system]="anchorPoint.anatomicalSystem"
                (mouseenter)="onAnchorPointHover(anchorPoint, $event)"
                (mouseleave)="onAnchorPointHoverEnd()"
              >
                <div class="anchor-point-label" *ngIf="anchorPoint.type !== 'systemic'">{{ anchorPoint.name }}</div>
                <span *ngIf="anchorPoint.type === 'systemic'">Systemic</span>
                <!-- Event count badge hidden for cleaner design -->
                <!-- <div class="event-count" *ngIf="getEventCountForAnchorPoint(anchorPoint.id) > 0">
                  {{ getEventCountForAnchorPoint(anchorPoint.id) }}
                </div> -->
              </div>

              <!-- Connection lines are now handled dynamically via hover events -->
            </div>
          </div>
        </div>
        <div class="demographics-right">
          <div class="clinical-events-summary">
            <div class="clinical-summary-section">
              <h5>Medications</h5>
              <div class="clinical-summary-list" *ngIf="medications.length > 0; else noMedications">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let medication of getSortedMedications() | slice:0:6"
                     (mouseenter)="onMedicationHover(medication, $event)"
                     (mouseleave)="onConditionHoverEnd()">
                  <div class="item-name">{{ medication.medicationCodeableConcept?.text }}</div>
                </div>
                <div class="clinical-summary-item" *ngIf="medications.length > 6" style="font-style: italic; color: #6c757d;">
                  +{{ medications.length - 6 }} more medications
                </div>
              </div>
              <ng-template #noMedications>
                <div class="no-clinical-data">No medications recorded</div>
              </ng-template>
            </div>

            <div class="clinical-summary-section">
              <h5>Allergic to:</h5>
              <div class="clinical-summary-list" *ngIf="allergies.length > 0; else noAllergies">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let allergy of getSortedAllergies() | slice:0:4"
                     (mouseenter)="onAllergyHover(allergy, $event)"
                     (mouseleave)="onConditionHoverEnd()">
                  <div class="item-name">
                    {{ getAllergyDisplayName(allergy) }} -
                    <span class="allergy-meta" *ngIf="getAllergyCriticality(allergy)">Criticality: {{ getAllergyCriticality(allergy) }},</span>
                    <span class="allergy-meta" *ngIf="getAllergyVerificationStatus(allergy)">{{ getAllergyVerificationStatus(allergy) }}</span>
                  </div>
                  <div class="allergy-reactions" *ngIf="getAllergyReactions(allergy).length > 0">
                    <div class="reaction-item" *ngFor="let reaction of getAllergyReactions(allergy)">Reaction: {{ reaction }}</div>
                  </div>
                </div>
                <div class="clinical-summary-item" *ngIf="allergies.length > 4" style="font-style: italic; color: #6c757d;">
                  +{{ allergies.length - 4 }} more allergies
                </div>
              </div>
              <ng-template #noAllergies>
                <div class="no-clinical-data">No allergies recorded</div>
              </ng-template>
            </div>

            <!-- CDS Section -->
            <div class="clinical-summary-section">
              <h5>CDS</h5>
              <div class="cds-notice-section">
                <div class="cds-notice" 
                     [ngClass]="getCdsNoticeClass()"
                     [class.clickable]="cdsResponse && cdsResponse.cards && cdsResponse.cards.length > 0"
                     (click)="onCdsNoticeClick()">
                  <span class="cds-notice-text"><mat-icon class="cds-notice-icon">{{ getCdsNoticeIcon() }}</mat-icon> {{ getCdsNoticeText() }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabbed View for Clinical Data -->
    <div class="record-section">
      <mat-tab-group class="clinical-tabs" #tabGroup>
        <mat-tab label="Encounters">
          <div class="tab-content">
            <app-encounter-record 
              [patient]="patient"
              (conditionAdded)="onConditionAdded($event)"
              (procedureAdded)="onProcedureAdded($event)">
            </app-encounter-record>
          </div>
        </mat-tab>

        <!-- Timeline Tab -->
        <mat-tab label="Timeline">
          <div class="tab-content">
            <app-clinical-timeline 
              [conditions]="conditions"
              [procedures]="procedures" 
              [medications]="medications"
              [encounters]="encounters">
            </app-clinical-timeline>
          </div>
        </mat-tab>

        <!-- List View Tab -->
        <mat-tab label="List View">
          <div class="tab-content">
            <!-- Clinical Entry Section - Single Row Above -->
            <div class="record-section clinical-entry-section">
              <div class="clinical-entry-controls">
                <h3>Add Clinical Events</h3>
                <div class="entry-buttons">
                  <button mat-raised-button 
                          color="primary" 
                          (click)="toggleConditionEntry()"
                          [disabled]="isProcessingNewEvent"
                          class="entry-toggle-button"
                          [class.active]="conditionEntry?.showAddForm">
                    <mat-icon>medical_services</mat-icon>
                    Add Condition
                  </button>
                  <button mat-raised-button 
                          color="primary" 
                          (click)="toggleProcedureEntry()"
                          [disabled]="isProcessingNewEvent"
                          class="entry-toggle-button"
                          [class.active]="procedureEntry?.showAddForm">
                    <mat-icon>healing</mat-icon>
                    Add Procedure
                  </button>
                  <button mat-raised-button 
                          color="primary" 
                          (click)="toggleMedicationEntry()"
                          [disabled]="isProcessingNewEvent"
                          class="entry-toggle-button"
                          [class.active]="medicationEntry?.showAddForm">
                    <mat-icon>medication</mat-icon>
                    Add Medication
                  </button>
                </div>
                <div class="processing-indicator" *ngIf="isProcessingNewEvent">
                  <mat-spinner diameter="20"></mat-spinner>
                  <span>Processing...</span>
                </div>
              </div>
              
              <!-- Clinical Entry Forms -->
              <div class="clinical-entry-forms">
                <app-clinical-entry 
                  #conditionEntry
                  [patientId]="patient.id" 
                  entryType="condition"
                  [hideButton]="true"
                  (itemAdded)="onConditionAdded($event)">
                </app-clinical-entry>
                
                <app-clinical-entry 
                  #procedureEntry
                  [patientId]="patient.id" 
                  entryType="procedure"
                  [hideButton]="true"
                  (itemAdded)="onProcedureAdded($event)">
                </app-clinical-entry>
                
                <app-clinical-entry 
                  #medicationEntry
                  [patientId]="patient.id" 
                  entryType="medication"
                  [availableConditions]="conditions"
                  [availableProcedures]="procedures"
                  [hideButton]="true"
                  (itemAdded)="onMedicationAdded($event)">
                </app-clinical-entry>
              </div>
            </div>

            <!-- Three Column Layout for Clinical Data -->
            <div class="three-column-layout">
              <!-- Conditions Column -->
              <div class="clinical-column conditions-column">
                <div class="column-header">
                  <h4><mat-icon>medical_services</mat-icon> Conditions</h4>
                  <span class="item-count">{{ conditions.length }}</span>
                </div>
                <div class="clinical-list compact" *ngIf="conditions.length > 0; else noConditions">
                  <div class="clinical-item compact" 
                       *ngFor="let condition of getSortedConditions()">
                    <div class="item-header compact">
                      <span class="item-title compact">{{ condition.code.text }}</span>
                      <div class="item-header-actions compact">
                        <span class="anchor-category-indicator compact" 
                              [style.background-color]="findBestAnchorPointForConcept(getConceptId(condition))?.defaultColor"
                              title="Mapped to: {{ findBestAnchorPointForConcept(getConceptId(condition))?.name }}">
                          {{ findBestAnchorPointForConcept(getConceptId(condition))?.name }}
                        </span>
                        <button mat-icon-button 
                                class="delete-button compact" 
                                (click)="deleteCondition(condition.id)"
                                title="Delete condition">
                          <mat-icon>delete_outline</mat-icon>
                        </button>
                      </div>
                    </div>
                    <div class="item-details compact inline">
                      <span class="item-concept-id compact" *ngIf="getConceptId(condition)">
                        {{ getConceptId(condition) }}
                      </span>
                      <span class="item-status compact" [class]="getConditionStatus(condition).toLowerCase()">
                        {{ getConditionStatus(condition) }}
                      </span>
                    </div>
                  </div>
                </div>
                <ng-template #noConditions>
                  <div class="no-clinical-data compact">No conditions recorded</div>
                </ng-template>
              </div>

              <!-- Procedures Column -->
              <div class="clinical-column procedures-column">
                <div class="column-header">
                  <h4><mat-icon>healing</mat-icon> Procedures</h4>
                  <span class="item-count">{{ procedures.length }}</span>
                </div>
                <div class="clinical-list compact" *ngIf="procedures.length > 0; else noProcedures">
                  <div class="clinical-item compact" *ngFor="let procedure of getSortedProcedures()">
                    <div class="item-header compact">
                      <span class="item-title compact">{{ procedure.code.text }}</span>
                      <div class="item-header-actions compact">
                        <span class="anchor-category-indicator compact" 
                              [style.background-color]="findBestAnchorPointForConcept(getConceptId(procedure))?.defaultColor"
                              title="Mapped to: {{ findBestAnchorPointForConcept(getConceptId(procedure))?.name }}">
                          {{ findBestAnchorPointForConcept(getConceptId(procedure))?.name }}
                        </span>
                        <button mat-icon-button 
                                class="delete-button compact" 
                                (click)="deleteProcedure(procedure.id)"
                                title="Delete procedure">
                          <mat-icon>delete_outline</mat-icon>
                        </button>
                      </div>
                    </div>
                    <div class="item-details compact inline">
                      <span class="item-concept-id compact" *ngIf="getConceptId(procedure)">
                        {{ getConceptId(procedure) }}
                      </span>
                      <span class="item-status compact" [class]="getProcedureStatus(procedure).toLowerCase()">
                        {{ getProcedureStatus(procedure) }}
                      </span>
                    </div>
                  </div>
                </div>
                <ng-template #noProcedures>
                  <div class="no-clinical-data compact">No procedures recorded</div>
                </ng-template>
              </div>

              <!-- Medications Column -->
              <div class="clinical-column medications-column">
                <div class="column-header">
                  <h4><mat-icon>medication</mat-icon> Medications</h4>
                  <span class="item-count">{{ medications.length }}</span>
                </div>
                <div class="clinical-list compact" *ngIf="medications.length > 0; else noMedications">
                  <div class="clinical-item compact" *ngFor="let medication of getSortedMedications()">
                    <div class="item-header compact">
                      <span class="item-title compact">{{ medication.medicationCodeableConcept?.text }}</span>
                      <div class="item-header-actions compact">
                        <span class="anchor-category-indicator compact" 
                              [style.background-color]="findBestAnchorPointForConcept(getMappingConceptId(medication))?.defaultColor"
                              title="Mapped to: {{ findBestAnchorPointForConcept(getMappingConceptId(medication))?.name }}">
                          {{ findBestAnchorPointForConcept(getMappingConceptId(medication))?.name }}
                        </span>
                        <button mat-icon-button 
                                class="delete-button compact" 
                                (click)="deleteMedication(medication.id)"
                                title="Delete medication">
                          <mat-icon>delete_outline</mat-icon>
                        </button>
                      </div>
                    </div>
                    <div class="item-details compact inline">
                      <span class="item-concept-id compact" *ngIf="getConceptId(medication)">
                        {{ getConceptId(medication) }}
                      </span>
                      <span class="item-status compact" [class]="getMedicationStatus(medication).toLowerCase()">
                        {{ getMedicationStatus(medication) }}
                      </span>
                      <span class="item-association compact" *ngIf="getMedicationAssociation(medication)">
                        <mat-icon class="association-icon">link</mat-icon>
                        {{ getMedicationAssociation(medication) }}
                      </span>
                    </div>
                  </div>
                </div>
                <ng-template #noMedications>
                  <div class="no-clinical-data compact">No medications recorded</div>
                </ng-template>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- CDS Tab -->
        <mat-tab label="Decision Support" (selectChange)="onCdsTabSelected()">
          <div class="tab-content">
            <div class="cds-tab-container">
              <h3>Decision Support</h3>
              <p class="cds-description">
                Get medication order recommendations based on current patient conditions and medications using SNOMED CT Clinical Decision Support services.
              </p>
              
              <!-- CDS Status -->
              <div class="cds-status">
                <div *ngIf="!isCdsLoading && !cdsResponse && !cdsError" class="cds-initial">
                  <mat-icon color="primary">psychology</mat-icon>
                  <span>Click to request medication recommendations</span>
                  <button mat-raised-button color="primary" (click)="submitToCdsService()" [disabled]="isCdsLoading">
                    Request Recommendations
                  </button>
                </div>
                
                <div *ngIf="isCdsLoading" class="cds-loading">
                  <mat-spinner diameter="24"></mat-spinner>
                  <span>Requesting medication recommendations from CDS service...</span>
                </div>
                
                <div *ngIf="cdsError" class="cds-error">
                  <mat-icon color="warn">error</mat-icon>
                  <div class="error-content">
                    <strong>Error:</strong>
                    <span>{{ cdsError }}</span>
                    <button mat-stroked-button color="primary" (click)="submitToCdsService()" style="margin-top: 8px;">
                      Retry
                    </button>
                  </div>
                </div>
                
                <div *ngIf="cdsResponse && cdsResponse.cards && cdsResponse.cards.length > 0" class="cds-recommendations">
                  <div class="recommendations-header">
                    <mat-icon color="primary">lightbulb</mat-icon>
                    <span>{{ cdsResponse.cards.length }} recommendation(s) received</span>
                    <button mat-stroked-button color="primary" (click)="submitToCdsService()" [disabled]="isCdsLoading">
                      Refresh
                    </button>
                  </div>
                  <div class="cds-cards">
                    <mat-card *ngFor="let card of cdsResponse.cards; let i = index" class="cds-card" [ngClass]="'indicator-' + card.indicator">
                      <mat-card-header>
                        <mat-card-title>
                          <mat-icon [color]="getCardIconColor(card.indicator)">{{ getCardIcon(card.indicator) }}</mat-icon>
                          {{ card.summary }}
                        </mat-card-title>
                        <mat-card-subtitle>{{ card.source.label }}</mat-card-subtitle>
                      </mat-card-header>
                      <mat-card-content *ngIf="card.detail">
                        <p>{{ card.detail }}</p>
                      </mat-card-content>
                      <mat-card-actions>
                        <button mat-button *ngFor="let suggestion of card.suggestions" color="primary">
                          {{ suggestion.label }}
                        </button>
                        <button mat-button 
                                *ngIf="card.source.url" 
                                color="accent"
                                (click)="openSourceUrl(card.source.url)"
                                title="View source">
                          <mat-icon>open_in_new</mat-icon>
                          View Source
                        </button>
                      </mat-card-actions>
                    </mat-card>
                  </div>
                </div>
                
                <div *ngIf="cdsResponse && (!cdsResponse.cards || cdsResponse.cards.length === 0)" class="cds-no-recommendations">
                  <mat-icon color="accent">check_circle</mat-icon>
                  <div class="no-recommendations-content">
                    <strong>No specific recommendations</strong>
                    <span>No medication order recommendations at this time based on current conditions and medications.</span>
                    <button mat-stroked-button color="primary" (click)="submitToCdsService()" [disabled]="isCdsLoading" style="margin-top: 8px;">
                      Refresh
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Clinical Forms Tab -->
        <mat-tab label="Clinical Forms">
          <div class="tab-content">
            <app-clinical-forms 
              [patient]="patient"
              [conditions]="conditions"
              [procedures]="procedures"
              [medications]="medications">
            </app-clinical-forms>
          </div>
        </mat-tab>
        
      </mat-tab-group>
    </div>

    <!-- Empty State -->
    <div class="record-section" *ngIf="conditions.length === 0 && procedures.length === 0 && medications.length === 0">
      <div class="empty-state">
        <h3>No Clinical Data Available</h3>
        <p>This patient has no conditions, procedures, or medications recorded.</p>
        <p>Use the "Add" buttons above to add clinical information using SNOMED CT terminology.</p>
      </div>
    </div>
  </div>

  <!-- No patient selected message -->
  <div class="no-patient-message" *ngIf="!patient">
    <div class="message-content">
      <h2>No Patient Selected</h2>
      <p>Please select a patient from the patient list to view their clinical record.</p>
      <button mat-flat-button color="primary" (click)="goBack()">
        Return to Patient List
      </button>
    </div>
  </div>
</div>
