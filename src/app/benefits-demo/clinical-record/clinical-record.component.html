<div class="clinical-record-container">
  <!-- Header with patient info and navigation -->
  <div class="record-header">
    <div class="header-left">
      <button mat-flat-button color="primary" (click)="goBack()">
        ‚Üê Back to Patient List
      </button>
    </div>
    <div class="header-center" *ngIf="patient">
      <h1>{{ getPatientDisplayName(patient) }}</h1>
      <div class="patient-meta">
        <span class="patient-id">ID: {{ getPatientIdentifier(patient) }}</span>
        <span class="patient-age" *ngIf="patient.birthDate">{{ getPatientAge(patient.birthDate) }}</span>
        <span class="patient-gender" *ngIf="patient.gender">{{ patient.gender }}</span>
        <span class="patient-status" [class.active]="patient.active">
          {{ patient.active ? 'Active' : 'Inactive' }}
        </span>
      </div>
    </div>
    <div class="header-right">
      <div class="current-date">
        {{ currentDate | date:'longDate' }}
      </div>
      <button mat-stroked-button 
              color="warn" 
              (click)="deleteAllEvents()"
              [disabled]="isLoadingMapping"
              title="Delete all clinical events for this patient"
              style="margin-left: 8px;">
        <mat-icon>delete_sweep</mat-icon>
        Delete All Events
      </button>
    </div>
  </div>

  <!-- Main content area -->
  <div class="record-content" *ngIf="patient">
    <!-- Patient Demographics Section -->
    <div class="record-section">
      <h2>Summary</h2>
      <div class="demographics-container">
        <div class="demographics-left">
          <div class="demographics-grid">
            <div class="demographic-item">
              <label>Full Name:</label>
              <span>{{ getPatientDisplayName(patient) }}</span>
            </div>
            <div class="demographic-item">
              <label>Date of Birth:</label>
              <span>{{ patient.birthDate | date:'longDate' }}</span>
            </div>
            <div class="demographic-item">
              <label>Age:</label>
              <span>{{ getPatientAge(patient.birthDate) }}</span>
            </div>
            <div class="demographic-item">
              <label>Gender:</label>
              <span>{{ patient.gender || 'Not specified' }}</span>
            </div>
            <div class="demographic-item">
              <label>Medical Record Number:</label>
              <span>{{ getPatientIdentifier(patient) }}</span>
            </div>
          </div>
        </div>
        <div class="demographics-right">
          <div class="body-model-container">
            <div class="model-with-annotations">
              <img 
                [src]="getBodyModelImage(patient.gender)" 
                [alt]="'Human body model - ' + (patient.gender || 'unspecified')"
                class="body-model-image"
              />
              
              <!-- Loading Overlay -->
              <div *ngIf="isLoadingMapping" class="mapping-loader-overlay">
                <div class="mapping-spinner"></div>
                <div class="mapping-loader-text">Updating event mappings...</div>
              </div>
              
              <!-- Anchor Points (hidden during loading) -->
              <div 
                *ngFor="let anchorPoint of anchorPoints" 
                class="anchor-point"
                [class.active]="getEventCountForAnchorPoint(anchorPoint.id) > 0"
                [class.empty]="!hasAssociatedEvents(anchorPoint)"
                [style.left.%]="patient.gender === 'female' ? anchorPoint.x + 4 : anchorPoint.x"
                [style.top.%]="anchorPoint.y"
                [style.display]="isLoadingMapping ? 'none' : 'block'"
                [style.background-color]="anchorPoint.defaultColor"
                [attr.data-anchor-id]="anchorPoint.id"
                [attr.data-system]="anchorPoint.anatomicalSystem"
                (mouseenter)="onAnchorPointHover(anchorPoint, $event)"
                (mouseleave)="onAnchorPointHoverEnd()"
              >
                <div class="anchor-point-label">{{ anchorPoint.name }}</div>
                <!-- Event count badge hidden for cleaner design -->
                <!-- <div class="event-count" *ngIf="getEventCountForAnchorPoint(anchorPoint.id) > 0">
                  {{ getEventCountForAnchorPoint(anchorPoint.id) }}
                </div> -->
              </div>

              <!-- Connection lines are now handled dynamically via hover events -->
            </div>
          </div>
          <div class="clinical-events-summary">
            <div class="clinical-summary-section">
              <h5>Conditions</h5>
              <div class="clinical-summary-list" *ngIf="conditions.length > 0; else noConditions">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let condition of conditions | slice:0:6; let i = index"
                     (mouseenter)="onConditionHover(condition, $event)"
                     (mouseleave)="onConditionHoverEnd()">
                  <div class="item-name">{{ condition.code.text }}</div>
                </div>
                <div class="clinical-summary-item" *ngIf="conditions.length > 6" style="font-style: italic; color: #6c757d;">
                  +{{ conditions.length - 6 }} more conditions
                </div>
              </div>
              <ng-template #noConditions>
                <div class="no-clinical-data">No conditions recorded</div>
              </ng-template>
            </div>

            <div class="clinical-summary-section">
              <h5>Procedures</h5>
              <div class="clinical-summary-list" *ngIf="procedures.length > 0; else noProcedures">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let procedure of procedures | slice:0:4"
                     (mouseenter)="onProcedureHover(procedure, $event)"
                     (mouseleave)="onConditionHoverEnd()"
                     title="Hover to see connection line">
                  <div class="item-name">{{ procedure.code.text }}</div>
                </div>
                <div class="clinical-summary-item" *ngIf="procedures.length > 4" style="font-style: italic; color: #6c757d;">
                  +{{ procedures.length - 4 }} more procedures
                </div>
              </div>
              <ng-template #noProcedures>
                <div class="no-clinical-data">No procedures recorded</div>
              </ng-template>
            </div>

            <div class="clinical-summary-section">
              <h5>Medications</h5>
              <div class="clinical-summary-list" *ngIf="medications.length > 0; else noMedications">
                <div class="clinical-summary-item hoverable-summary-condition" 
                     *ngFor="let medication of medications | slice:0:4"
                     (mouseenter)="onMedicationHover(medication, $event)"
                     (mouseleave)="onConditionHoverEnd()"
                     title="Hover to see connection line">
                  <div class="item-name">{{ medication.medicationCodeableConcept?.text }}</div>
                </div>
                <div class="clinical-summary-item" *ngIf="medications.length > 4" style="font-style: italic; color: #6c757d;">
                  +{{ medications.length - 4 }} more medications
                </div>
              </div>
              <ng-template #noMedications>
                <div class="no-clinical-data">No medications recorded</div>
              </ng-template>
            </div>


          </div>
        </div>
      </div>
    </div>

    <!-- Conditions Section -->
    <div class="record-section">
      <div class="section-header">
        <h3>Conditions</h3>
        <div class="section-header-actions">
          <div class="processing-indicator" *ngIf="isProcessingNewEvent">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Processing...</span>
          </div>
          <button mat-icon-button 
                  color="primary" 
                  class="add-section-button" 
                  (click)="toggleConditionEntry()"
                  [disabled]="isProcessingNewEvent"
                  title="Add Condition">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
      
      <app-clinical-entry 
        #conditionEntry
        [patientId]="patient.id" 
        entryType="condition"
        [hideButton]="true"
        (itemAdded)="onConditionAdded($event)">
      </app-clinical-entry>
      <div class="clinical-list" *ngIf="conditions.length > 0">
        <div class="clinical-item" 
             *ngFor="let condition of conditions">
          <div class="item-header">
            <span class="item-title">{{ condition.code.text }}</span>
            <div class="item-header-actions">
              <span class="anchor-category-indicator" 
                    [style.background-color]="findBestAnchorPointForConcept(getConceptId(condition))?.defaultColor"
                    title="Mapped to: {{ findBestAnchorPointForConcept(getConceptId(condition))?.name }}">
                {{ findBestAnchorPointForConcept(getConceptId(condition))?.name }}
              </span>
              <span class="item-status" [class]="getConditionStatus(condition).toLowerCase()">
                {{ getConditionStatus(condition) }}
              </span>
              <button mat-icon-button 
                      class="delete-button" 
                      (click)="deleteCondition(condition.id)"
                      title="Delete condition">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-details">
            <span class="item-concept-id" *ngIf="getConceptId(condition)">
              SNOMED CT: {{ getConceptId(condition) }}
            </span>
            <span class="item-date" *ngIf="condition.onsetDateTime">
              Onset: {{ formatDate(condition.onsetDateTime) }}
            </span>
            <span class="item-date" *ngIf="condition.recordedDate">
              Recorded: {{ formatDate(condition.recordedDate) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Procedures Section -->
    <div class="record-section">
      <div class="section-header">
        <h3>Procedures</h3>
        <div class="section-header-actions">
          <div class="processing-indicator" *ngIf="isProcessingNewEvent">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Processing...</span>
          </div>
          <button mat-icon-button 
                  color="primary" 
                  class="add-section-button" 
                  (click)="toggleProcedureEntry()"
                  [disabled]="isProcessingNewEvent"
                  title="Add Procedure">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
      
      <app-clinical-entry 
        #procedureEntry
        [patientId]="patient.id" 
        entryType="procedure"
        [hideButton]="true"
        (itemAdded)="onProcedureAdded($event)">
      </app-clinical-entry>
      <div class="clinical-list" *ngIf="procedures.length > 0">
        <div class="clinical-item" *ngFor="let procedure of procedures">
          <div class="item-header">
            <span class="item-title">{{ procedure.code.text }}</span>
            <div class="item-header-actions">
              <span class="anchor-category-indicator" 
                    [style.background-color]="findBestAnchorPointForConcept(getConceptId(procedure))?.defaultColor"
                    title="Mapped to: {{ findBestAnchorPointForConcept(getConceptId(procedure))?.name }}">
                {{ findBestAnchorPointForConcept(getConceptId(procedure))?.name }}
              </span>
              <span class="item-status" [class]="getProcedureStatus(procedure).toLowerCase()">
                {{ getProcedureStatus(procedure) }}
              </span>
              <button mat-icon-button 
                      class="delete-button" 
                      (click)="deleteProcedure(procedure.id)"
                      title="Delete procedure">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-details">
            <span class="item-concept-id" *ngIf="getConceptId(procedure)">
              SNOMED CT: {{ getConceptId(procedure) }}
            </span>
            <span class="item-date" *ngIf="procedure.performedDateTime">
              Performed: {{ formatDate(procedure.performedDateTime) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Medications Section -->
    <div class="record-section">
      <div class="section-header">
        <h3>Medications</h3>
        <div class="section-header-actions">
          <div class="processing-indicator" *ngIf="isProcessingNewEvent">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Processing...</span>
          </div>
          <button mat-icon-button 
                  color="primary" 
                  class="add-section-button" 
                  (click)="toggleMedicationEntry()"
                  [disabled]="isProcessingNewEvent"
                  title="Add Medication">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
      
      <app-clinical-entry 
        #medicationEntry
        [patientId]="patient.id" 
        entryType="medication"
        [availableConditions]="conditions"
        [availableProcedures]="procedures"
        [hideButton]="true"
        (itemAdded)="onMedicationAdded($event)">
      </app-clinical-entry>
      <div class="clinical-list" *ngIf="medications.length > 0">
        <div class="clinical-item" *ngFor="let medication of medications">
          <div class="item-header">
            <span class="item-title">{{ medication.medicationCodeableConcept?.text }}</span>
            <div class="item-header-actions">
              <span class="anchor-category-indicator" 
                    [style.background-color]="findBestAnchorPointForConcept(getMappingConceptId(medication))?.defaultColor"
                    title="Mapped to: {{ findBestAnchorPointForConcept(getMappingConceptId(medication))?.name }}">
                {{ findBestAnchorPointForConcept(getMappingConceptId(medication))?.name }}
              </span>
              <span class="item-status" [class]="getMedicationStatus(medication).toLowerCase()">
                {{ getMedicationStatus(medication) }}
              </span>
              <button mat-icon-button 
                      class="delete-button" 
                      (click)="deleteMedication(medication.id)"
                      title="Delete medication">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-details">
            <span class="item-concept-id" *ngIf="getConceptId(medication)">
              SNOMED CT: {{ getConceptId(medication) }}
            </span>
            <span class="item-date" *ngIf="medication.effectiveDateTime">
              Effective: {{ formatDate(medication.effectiveDateTime) }}
            </span>
            <span class="item-dosage" *ngIf="medication.dosage && medication.dosage.length > 0">
              {{ medication.dosage[0].text }}
            </span>
            <span class="item-association" *ngIf="getMedicationAssociation(medication)">
              <mat-icon class="association-icon">link</mat-icon>
              For: {{ getMedicationAssociation(medication) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Clinical Timeline Section -->
    <app-clinical-timeline 
      [conditions]="conditions"
      [procedures]="procedures" 
      [medications]="medications">
    </app-clinical-timeline>

    <!-- Empty State -->
    <div class="record-section" *ngIf="conditions.length === 0 && procedures.length === 0 && medications.length === 0">
      <div class="empty-state">
        <h3>No Clinical Data Available</h3>
        <p>This patient has no conditions, procedures, or medications recorded.</p>
        <p>Use the "Add" buttons above to add clinical information using SNOMED CT terminology.</p>
      </div>
    </div>
  </div>

  <!-- No patient selected message -->
  <div class="no-patient-message" *ngIf="!patient">
    <div class="message-content">
      <h2>No Patient Selected</h2>
      <p>Please select a patient from the patient list to view their clinical record.</p>
      <button mat-flat-button color="primary" (click)="goBack()">
        Return to Patient List
      </button>
    </div>
  </div>
</div>
