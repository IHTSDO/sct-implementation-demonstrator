<div class="clinical-record-container">
  <!-- Header with patient info and navigation -->
  <div class="record-header">
    <div class="header-left">
      <button mat-flat-button color="primary" (click)="goBack()">
        ‚Üê Back to Patient List
      </button>
    </div>
    <div class="header-center" *ngIf="patient">
      <h1>{{ getPatientDisplayName(patient) }}</h1>
      <div class="patient-meta">
        <span class="patient-id">ID: {{ getPatientIdentifier(patient) }}</span>
        <span class="patient-age" *ngIf="patient.birthDate">{{ getPatientAge(patient.birthDate) }}</span>
        <span class="patient-gender" *ngIf="patient.gender">{{ patient.gender }}</span>
        <span class="patient-status" [class.active]="patient.active">
          {{ patient.active ? 'Active' : 'Inactive' }}
        </span>
      </div>
    </div>
    <div class="header-right">
      <div class="current-date">
        {{ currentDate | date:'longDate' }}
      </div>
    </div>
  </div>

  <!-- Main content area -->
  <div class="record-content" *ngIf="patient">
    <!-- Patient Demographics Section -->
    <div class="record-section">
      <h2>Demographics</h2>
      <div class="demographics-grid">
        <div class="demographic-item">
          <label>Full Name:</label>
          <span>{{ getPatientDisplayName(patient) }}</span>
        </div>
        <div class="demographic-item">
          <label>Date of Birth:</label>
          <span>{{ patient.birthDate | date:'longDate' }}</span>
        </div>
        <div class="demographic-item">
          <label>Age:</label>
          <span>{{ getPatientAge(patient.birthDate) }}</span>
        </div>
        <div class="demographic-item">
          <label>Gender:</label>
          <span>{{ patient.gender || 'Not specified' }}</span>
        </div>
        <div class="demographic-item">
          <label>Medical Record Number:</label>
          <span>{{ getPatientIdentifier(patient) }}</span>
        </div>
      </div>
    </div>



    <!-- Clinical Data Header -->
    <div class="record-section">
      <h2>Clinical Data</h2>
    </div>

    <!-- Conditions Section -->
    <div class="record-section">
      <h3>Conditions</h3>
      <app-clinical-entry 
        [patientId]="patient.id" 
        entryType="condition"
        (itemAdded)="onConditionAdded($event)">
      </app-clinical-entry>
      <div class="clinical-list" *ngIf="conditions.length > 0">
        <div class="clinical-item" *ngFor="let condition of conditions">
          <div class="item-header">
            <span class="item-title">{{ condition.code.text }}</span>
            <div class="item-header-actions">
              <span class="item-status" [class]="getConditionStatus(condition).toLowerCase()">
                {{ getConditionStatus(condition) }}
              </span>
              <button mat-icon-button 
                      class="delete-button" 
                      (click)="deleteCondition(condition.id)"
                      title="Delete condition">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-details">
            <span class="item-concept-id" *ngIf="getConceptId(condition)">
              SNOMED CT: {{ getConceptId(condition) }}
            </span>
            <span class="item-date" *ngIf="condition.onsetDateTime">
              Onset: {{ formatDate(condition.onsetDateTime) }}
            </span>
            <span class="item-date" *ngIf="condition.recordedDate">
              Recorded: {{ formatDate(condition.recordedDate) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Procedures Section -->
    <div class="record-section">
      <h3>Procedures</h3>
      <app-clinical-entry 
        [patientId]="patient.id" 
        entryType="procedure"
        (itemAdded)="onProcedureAdded($event)">
      </app-clinical-entry>
      <div class="clinical-list" *ngIf="procedures.length > 0">
        <div class="clinical-item" *ngFor="let procedure of procedures">
          <div class="item-header">
            <span class="item-title">{{ procedure.code.text }}</span>
            <div class="item-header-actions">
              <span class="item-status" [class]="getProcedureStatus(procedure).toLowerCase()">
                {{ getProcedureStatus(procedure) }}
              </span>
              <button mat-icon-button 
                      class="delete-button" 
                      (click)="deleteProcedure(procedure.id)"
                      title="Delete procedure">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-details">
            <span class="item-concept-id" *ngIf="getConceptId(procedure)">
              SNOMED CT: {{ getConceptId(procedure) }}
            </span>
            <span class="item-date" *ngIf="procedure.performedDateTime">
              Performed: {{ formatDate(procedure.performedDateTime) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Medications Section -->
    <div class="record-section">
      <h3>Medications</h3>
      <app-clinical-entry 
        [patientId]="patient.id" 
        entryType="medication"
        (itemAdded)="onMedicationAdded($event)">
      </app-clinical-entry>
      <div class="clinical-list" *ngIf="medications.length > 0">
        <div class="clinical-item" *ngFor="let medication of medications">
          <div class="item-header">
            <span class="item-title">{{ medication.medicationCodeableConcept?.text }}</span>
            <div class="item-header-actions">
              <span class="item-status" [class]="getMedicationStatus(medication).toLowerCase()">
                {{ getMedicationStatus(medication) }}
              </span>
              <button mat-icon-button 
                      class="delete-button" 
                      (click)="deleteMedication(medication.id)"
                      title="Delete medication">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-details">
            <span class="item-concept-id" *ngIf="getConceptId(medication)">
              SNOMED CT: {{ getConceptId(medication) }}
            </span>
            <span class="item-date" *ngIf="medication.authoredOn">
              Prescribed: {{ formatDate(medication.authoredOn) }}
            </span>
            <span class="item-dosage" *ngIf="medication.dosageInstruction && medication.dosageInstruction.length > 0">
              {{ medication.dosageInstruction[0].text }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="record-section" *ngIf="conditions.length === 0 && procedures.length === 0 && medications.length === 0">
      <div class="empty-state">
        <h3>No Clinical Data Available</h3>
        <p>This patient has no conditions, procedures, or medications recorded.</p>
        <p>Use the "Add" buttons above to add clinical information using SNOMED CT terminology.</p>
      </div>
    </div>
  </div>

  <!-- No patient selected message -->
  <div class="no-patient-message" *ngIf="!patient">
    <div class="message-content">
      <h2>No Patient Selected</h2>
      <p>Please select a patient from the patient list to view their clinical record.</p>
      <button mat-flat-button color="primary" (click)="goBack()">
        Return to Patient List
      </button>
    </div>
  </div>
</div>
