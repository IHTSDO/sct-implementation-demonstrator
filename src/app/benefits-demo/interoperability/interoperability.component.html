<div class="interoperability-container">
  <!-- Back button positioned at top left -->
  <div class="back-button-container">
    <button mat-flat-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to the SNOMED EHR Lab
    </button>
  </div>

  <div class="header">
    <h1>Interoperability Demo</h1>
    <p class="subtitle">Demonstrating SNOMED CT and FHIR IPS (International Patient Summary) interoperability in the clinical record</p>
    <div class="header-actions">
      <button mat-flat-button color="primary" (click)="triggerFileUpload()" [disabled]="isLoading">
        <mat-icon>upload_file</mat-icon>
        Upload IPS File
      </button>
      <button *ngIf="hasPatientData()" mat-flat-button (click)="loadExampleIPSBundle()" [disabled]="isLoading">
        <mat-icon>refresh</mat-icon>
        Reload Example
      </button>
      <input #fileInput type="file" accept=".json" (change)="onFileSelected($event)" style="display: none;">
    </div>
  </div>

  <div class="content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading IPS bundle...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !isLoading" class="error-container">
      <mat-icon class="error-icon">error</mat-icon>
      <h3>Error Loading IPS Bundle</h3>
      <p>{{ error }}</p>
      <p><strong>Note:</strong> Please check that the IPS bundle file is available and properly formatted.</p>
      <div class="error-actions">
        <button mat-flat-button color="primary" (click)="loadExampleIPSBundle()">
          <mat-icon>refresh</mat-icon>
          Retry
        </button>
      </div>
    </div>

    <!-- Patient Data Display -->
    <div *ngIf="!isLoading && !error && hasPatientData()" class="patient-data-container">
      
      <!-- Summary Row -->
      <div class="data-row">
        <div class="left-section">
          <!-- Summary -->
          <mat-card class="summary-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>summarize</mat-icon>
                IPS Bundle Summary
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="summary-stats">
                <div class="stat-item">
                  <mat-icon>medical_services</mat-icon>
                  <span>{{ patientData?.conditions?.length || 0 }} Conditions</span>
                </div>
                <div class="stat-item">
                  <mat-icon>local_hospital</mat-icon>
                  <span>{{ patientData?.procedures?.length || 0 }} Procedures</span>
                </div>
                <div class="stat-item">
                  <mat-icon>medication</mat-icon>
                  <span>{{ patientData?.medications?.length || 0 }} Medications</span>
                </div>
                <div class="stat-item">
                  <mat-icon>warning</mat-icon>
                  <span>{{ patientData?.allergies?.length || 0 }} Allergies</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="right-section">
          <!-- Patient Link Controls -->
          <mat-card class="merge-controls-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>link</mat-icon>
                Link IPS Patient to records
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <!-- Patient Suggestion -->
              <div *ngIf="suggestedPatient && !linkedPatient" class="patient-suggestion">
                <div class="suggestion-header">
                  <mat-icon class="suggestion-icon">lightbulb</mat-icon>
                  <span class="suggestion-title">Suggested Match</span>
                  <span class="match-type">{{ getMatchTypeLabel(suggestedPatient.matchType) }}</span>
                </div>
                <div class="suggestion-content">
                  <div class="suggested-patient">
                    <strong>{{ getPatientDisplayName(suggestedPatient) }}</strong> ({{ suggestedPatient.birthDate }})
                  </div>
                  <div class="suggestion-actions">
                    <button mat-raised-button color="primary" (click)="acceptSuggestion()" class="accept-button">
                      <mat-icon>check</mat-icon>
                      Accept Suggestion
                    </button>
                    <button mat-button (click)="dismissSuggestion()" class="dismiss-button">
                      <mat-icon>close</mat-icon>
                      Dismiss
                    </button>
                  </div>
                </div>
              </div>
              <div class="link-controls">
                <mat-form-field class="patient-selector">
                  <mat-label>Select existing patient (sorted by similarity)</mat-label>
                  <mat-select [(value)]="selectedPatientId" (selectionChange)="onPatientSelectionChange($event)">
                    <mat-option value="">No patient selected</mat-option>
                    <mat-option *ngFor="let item of sortedPatientsWithScores" [value]="item.patient.id">
                      <span class="patient-option">
                        <span class="patient-name">{{ getPatientDisplayName(item.patient) }}</span>
                        <span class="patient-details">({{ item.patient.birthDate }})</span>
                        <span class="similarity-score" [class.high-score]="item.score >= 0.8" 
                                                       [class.medium-score]="item.score >= 0.5 && item.score < 0.8"
                                                       [class.low-score]="item.score < 0.5">
                          {{ formatScoreAsPercentage(item.score) }} match
                        </span>
                      </span>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <div class="link-buttons">
                  <button 
                    mat-raised-button 
                    color="primary" 
                    [disabled]="!selectedPatientId"
                    (click)="linkPatient()"
                    class="link-button">
                    <mat-icon>link</mat-icon>
                    Link Patient
                  </button>
                  <button 
                    mat-raised-button 
                    color="accent" 
                    (click)="createNewPatient()"
                    class="create-button">
                    <mat-icon>person_add</mat-icon>
                    Create New Patient
                  </button>
                </div>
              </div>
              <div *ngIf="linkedPatient" class="linked-patient-info">
                <mat-icon class="success-icon">check_circle</mat-icon>
                <span>Linking IPS data to: {{ getPatientDisplayName(linkedPatient) }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Patient Information Row -->
      <div class="data-row">
        <div class="left-section">
          <!-- Patient Information Card -->
          <mat-card class="patient-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>person</mat-icon>
                Patient Information
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="patient-info">
                <div class="info-item">
                  <strong>Name:</strong> {{ getPatientName() }}
                </div>
                <div class="info-item">
                  <strong>Date of Birth:</strong> {{ patientData?.patient?.birthDate | date:'mediumDate' }}
                </div>
                <div class="info-item">
                  <strong>Gender:</strong> {{ getPatientGender() }}
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="right-section">
          <!-- Linked Patient Information Card -->
          <mat-card class="patient-card" *ngIf="linkedPatient">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>person_outline</mat-icon>
                Linked Patient Information
                <span class="similarity-badge" 
                      [class.high-similarity]="getPatientScore(linkedPatient.id) >= 0.8"
                      [class.medium-similarity]="getPatientScore(linkedPatient.id) >= 0.5 && getPatientScore(linkedPatient.id) < 0.8"
                      [class.low-similarity]="getPatientScore(linkedPatient.id) < 0.5 && getPatientScore(linkedPatient.id) > 0">
                  {{ formatScoreAsPercentage(getPatientScore(linkedPatient.id)) }} match
                </span>
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="patient-info">
                <div class="info-item">
                  <strong>Name:</strong> {{ getPatientDisplayName(linkedPatient) }}
                </div>
                <div class="info-item">
                  <strong>Date of Birth:</strong> {{ linkedPatient.birthDate | date:'mediumDate' }}
                </div>
                <div class="info-item">
                  <strong>Gender:</strong> {{ linkedPatient.gender | titlecase }}
                </div>
              </div>
            </mat-card-content>
          </mat-card>
          
          <!-- Placeholder when no patient is linked -->
          <div class="placeholder-section" *ngIf="!linkedPatient">
            <mat-icon class="placeholder-icon">info</mat-icon>
            <p>Link to a patient to see their information here</p>
          </div>
        </div>
      </div>

      <!-- Conditions Row -->
      <div class="data-row" *ngIf="hasConditions()">
        <div class="left-section">
          <!-- Conditions Section -->
          <mat-card class="data-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>medical_services</mat-icon>
                Conditions ({{ patientData?.conditions?.length || 0 }})
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="data-list">
                <div *ngFor="let condition of patientData?.conditions" 
                     class="data-item clickable-item"
                     [class.selected-item]="isConditionAdded(condition.id) && !isConditionAlreadyRecorded(condition)"
                     [class.disabled-item]="!linkedPatient"
                     [class.already-recorded-item]="linkedPatient && isConditionAlreadyRecorded(condition)"
                     (click)="linkedPatient && !isConditionAlreadyRecorded(condition) && addConditionFromIPS(condition.id)">
                  <div class="item-header">
                    <mat-icon class="add-icon" *ngIf="linkedPatient && !isConditionAlreadyRecorded(condition)">
                      {{ isConditionAdded(condition.id) ? 'check_circle' : 'add_circle_outline' }}
                    </mat-icon>
                    <mat-icon class="add-icon recorded-icon" *ngIf="linkedPatient && isConditionAlreadyRecorded(condition)">
                      verified
                    </mat-icon>
                    <span class="item-title">{{ ipsReaderService.getConditionDisplay(condition) }}</span>
                    <span class="item-status" *ngIf="!isConditionAlreadyRecorded(condition)">{{ ipsReaderService.getConditionStatus(condition) }}</span>
                    <span class="already-recorded-badge" *ngIf="linkedPatient && isConditionAlreadyRecorded(condition)">Already Recorded</span>
                  </div>
                  <div class="item-details">
                    <span *ngIf="condition.onsetDateTime" class="detail-item">
                      <mat-icon>schedule</mat-icon>
                      Onset: {{ condition.onsetDateTime | date:'short' }}
                    </span>
                    <span *ngIf="condition.recordedDate" class="detail-item">
                      <mat-icon>edit</mat-icon>
                      Recorded: {{ condition.recordedDate | date:'short' }}
                    </span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="right-section">
          <!-- Conditions Merge Controls -->
          <mat-card class="merge-controls-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>merge_type</mat-icon>
                Conditions Merge
                <span class="selection-count" *ngIf="linkedPatient">({{ selectedConditions.size }}/{{ patientData?.conditions?.length || 0 }} selected)</span>
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="!linkedPatient" class="link-required-message">
                <mat-icon>info</mat-icon>
                <span>Please link to a patient first to enable merge controls</span>
              </div>
              
              <div *ngIf="linkedPatient" class="merge-controls">
                <p class="merge-hint" *ngIf="hasAvailableConditions()">
                  <mat-icon>info</mat-icon>
                  Click on conditions in the left panel to add them here
                </p>

                <!-- All items already recorded message -->
                <p class="all-recorded-message" *ngIf="!hasAvailableConditions() && existingConditions.length > 0">
                  <mat-icon>check_circle</mat-icon>
                  All IPS conditions are already recorded
                </p>

                <!-- Selected IPS Conditions (New - shown first) -->
                <div class="conditions-section" *ngIf="getSelectedIPSConditions().length > 0">
                  <div class="section-header new-conditions-header">
                    <mat-icon>new_label</mat-icon>
                    <span>New from IPS ({{ getSelectedIPSConditions().length }})</span>
                  </div>
                  <div class="item-list">
                    <div *ngFor="let condition of getSelectedIPSConditions()" class="item-row new-item">
                      <mat-icon class="status-icon">add_circle</mat-icon>
                      <div class="item-content">
                        <div class="item-title">{{ ipsReaderService.getConditionDisplay(condition) }}</div>
                        <div class="item-details">
                          <span class="item-status">{{ condition.clinicalStatus?.coding?.[0]?.display || condition.clinicalStatus?.coding?.[0]?.code || 'Unknown status' }}</span>
                          <span *ngIf="condition.onsetDateTime" class="item-date">{{ condition.onsetDateTime | date:'short' }}</span>
                        </div>
                      </div>
                      <button mat-icon-button (click)="addConditionFromIPS(condition.id)" class="remove-btn">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Existing Patient Conditions -->
                <div class="conditions-section" *ngIf="existingConditions.length > 0">
                  <div class="section-header existing-conditions-header">
                    <mat-icon>article</mat-icon>
                    <span>Existing Conditions ({{ existingConditions.length }})</span>
                  </div>
                  <div class="item-list">
                    <div *ngFor="let condition of existingConditions" class="item-row existing-item">
                      <mat-icon class="status-icon">check</mat-icon>
                      <div class="item-content">
                        <div class="item-title">{{ ipsReaderService.getConditionDisplay(condition) }}</div>
                        <div class="item-details">
                          <span class="item-status">{{ ipsReaderService.getConditionStatus(condition) }}</span>
                          <span *ngIf="condition.onsetDateTime" class="item-date">{{ condition.onsetDateTime | date:'short' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Empty state -->
                <div class="empty-state" *ngIf="getSelectedIPSConditions().length === 0 && existingConditions.length === 0">
                  <mat-icon>inbox</mat-icon>
                  <p>No conditions yet. Click on conditions from the left to add them.</p>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Procedures Row -->
      <div class="data-row" *ngIf="hasProcedures()">
        <div class="left-section">
          <!-- Procedures Section -->
          <mat-card class="data-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>local_hospital</mat-icon>
                Procedures ({{ patientData?.procedures?.length || 0 }})
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="data-list">
                <div *ngFor="let procedure of patientData?.procedures" class="data-item">
                  <div class="item-header">
                    <span class="item-title">{{ ipsReaderService.getProcedureDisplay(procedure) }}</span>
                    <span class="item-status">{{ procedure.status | titlecase }}</span>
                  </div>
                  <div class="item-details">
                    <span class="detail-item">
                      <mat-icon>schedule</mat-icon>
                      Performed: {{ ipsReaderService.getProcedureDate(procedure) }}
                    </span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="right-section">
          <!-- Procedures Merge Controls -->
          <mat-card class="merge-controls-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>merge_type</mat-icon>
                Procedures Merge
                <span class="selection-count" *ngIf="linkedPatient">({{ selectedProcedures.size }}/{{ patientData?.procedures?.length || 0 }} selected)</span>
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="!linkedPatient" class="link-required-message">
                <mat-icon>info</mat-icon>
                <span>Please link to a patient first to enable merge controls</span>
              </div>
              
              <div *ngIf="linkedPatient" class="merge-controls">
                <!-- Category Actions -->
                <div class="category-actions">
                  <button mat-button (click)="selectAllProcedures()" class="select-all-btn">
                    <mat-icon>select_all</mat-icon>
                    Select All
                  </button>
                  <button mat-button (click)="deselectAllProcedures()" class="deselect-all-btn">
                    <mat-icon>deselect</mat-icon>
                    Deselect All
                  </button>
                </div>

                <!-- Procedures List -->
                <div class="item-list" *ngIf="patientData && patientData.procedures && patientData.procedures.length > 0">
                  <div *ngFor="let procedure of patientData?.procedures || []" class="item-row">
                    <mat-checkbox 
                      [checked]="selectedProcedures.has(procedure.id)"
                      (change)="toggleProcedureSelection(procedure.id)"
                      class="item-checkbox">
                    </mat-checkbox>
                    <div class="item-content">
                      <div class="item-title">{{ ipsReaderService.getProcedureDisplay(procedure) }}</div>
                      <div class="item-details">
                        <span class="item-status">{{ procedure.status }}</span>
                        <span *ngIf="procedure.performedDateTime" class="item-date">{{ procedure.performedDateTime | date:'short' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Medications Row -->
      <div class="data-row" *ngIf="hasMedications()">
        <div class="left-section">
          <!-- Medications Section -->
          <mat-card class="data-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>medication</mat-icon>
                Medications ({{ patientData?.medications?.length || 0 }})
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="data-list">
                <div *ngFor="let medication of patientData?.medications" 
                     class="data-item clickable-item"
                     [class.selected-item]="isMedicationAdded(medication.id) && !isMedicationAlreadyRecorded(medication)"
                     [class.disabled-item]="!linkedPatient"
                     [class.already-recorded-item]="linkedPatient && isMedicationAlreadyRecorded(medication)"
                     (click)="linkedPatient && !isMedicationAlreadyRecorded(medication) && addMedicationFromIPS(medication.id)">
                  <div class="item-header">
                    <mat-icon class="add-icon" *ngIf="linkedPatient && !isMedicationAlreadyRecorded(medication)">
                      {{ isMedicationAdded(medication.id) ? 'check_circle' : 'add_circle_outline' }}
                    </mat-icon>
                    <mat-icon class="add-icon recorded-icon" *ngIf="linkedPatient && isMedicationAlreadyRecorded(medication)">
                      verified
                    </mat-icon>
                    <span class="item-title">{{ ipsReaderService.getMedicationDisplay(medication) }}</span>
                    <span class="item-status" *ngIf="!isMedicationAlreadyRecorded(medication)">{{ ipsReaderService.getMedicationStatus(medication) }}</span>
                    <span class="already-recorded-badge" *ngIf="linkedPatient && isMedicationAlreadyRecorded(medication)">Already Recorded</span>
                  </div>
                  <div class="item-details">
                    <span class="detail-item">
                      <mat-icon>schedule</mat-icon>
                      Effective: {{ ipsReaderService.getMedicationEffectivePeriod(medication) }}
                    </span>
                    <span *ngIf="medication.dosage && medication.dosage.length > 0" class="detail-item">
                      <mat-icon>straighten</mat-icon>
                      Dosage: {{ medication.dosage[0].text || 'As prescribed' }}
                    </span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="right-section">
          <!-- Medications Merge Controls -->
          <mat-card class="merge-controls-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>merge_type</mat-icon>
                Medications Merge
                <span class="selection-count" *ngIf="linkedPatient">({{ selectedMedications.size }}/{{ patientData?.medications?.length || 0 }} selected)</span>
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="!linkedPatient" class="link-required-message">
                <mat-icon>info</mat-icon>
                <span>Please link to a patient first to enable merge controls</span>
              </div>
              
              <div *ngIf="linkedPatient" class="merge-controls">
                <p class="merge-hint" *ngIf="hasAvailableMedications()">
                  <mat-icon>info</mat-icon>
                  Click on medications in the left panel to add them here
                </p>

                <!-- All items already recorded message -->
                <p class="all-recorded-message" *ngIf="!hasAvailableMedications() && existingMedications.length > 0">
                  <mat-icon>check_circle</mat-icon>
                  All IPS medications are already recorded
                </p>

                <!-- Selected IPS Medications (New - shown first) -->
                <div class="conditions-section" *ngIf="getSelectedIPSMedications().length > 0">
                  <div class="section-header new-conditions-header">
                    <mat-icon>new_label</mat-icon>
                    <span>New from IPS ({{ getSelectedIPSMedications().length }})</span>
                  </div>
                  <div class="item-list">
                    <div *ngFor="let medication of getSelectedIPSMedications()" class="item-row new-item">
                      <mat-icon class="status-icon">add_circle</mat-icon>
                      <div class="item-content">
                        <div class="item-title">{{ ipsReaderService.getMedicationDisplay(medication) }}</div>
                        <div class="item-details">
                          <span class="item-status">{{ medication.status }}</span>
                          <span *ngIf="medication.effectiveDateTime" class="item-date">{{ medication.effectiveDateTime | date:'short' }}</span>
                        </div>
                      </div>
                      <button mat-icon-button (click)="addMedicationFromIPS(medication.id)" class="remove-btn">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Existing Patient Medications -->
                <div class="conditions-section" *ngIf="existingMedications.length > 0">
                  <div class="section-header existing-conditions-header">
                    <mat-icon>article</mat-icon>
                    <span>Existing Medications ({{ existingMedications.length }})</span>
                  </div>
                  <div class="item-list">
                    <div *ngFor="let medication of existingMedications" class="item-row existing-item">
                      <mat-icon class="status-icon">check</mat-icon>
                      <div class="item-content">
                        <div class="item-title">{{ ipsReaderService.getMedicationDisplay(medication) }}</div>
                        <div class="item-details">
                          <span class="item-status">{{ ipsReaderService.getMedicationStatus(medication) }}</span>
                          <span *ngIf="medication.effectiveDateTime" class="item-date">{{ medication.effectiveDateTime | date:'short' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Empty state -->
                <div class="empty-state" *ngIf="getSelectedIPSMedications().length === 0 && existingMedications.length === 0">
                  <mat-icon>inbox</mat-icon>
                  <p>No medications yet. Click on medications from the left to add them.</p>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Allergies Row -->
      <div class="data-row" *ngIf="hasAllergies()">
        <div class="left-section">
          <!-- Allergies Section -->
          <mat-card class="data-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>warning</mat-icon>
                Allergies ({{ patientData?.allergies?.length || 0 }})
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="data-list">
                <div *ngFor="let allergy of patientData?.allergies" 
                     class="data-item clickable-item"
                     [class.selected-item]="isAllergyAdded(allergy.id) && !isAllergyAlreadyRecorded(allergy)"
                     [class.disabled-item]="!linkedPatient"
                     [class.already-recorded-item]="linkedPatient && isAllergyAlreadyRecorded(allergy)"
                     (click)="linkedPatient && !isAllergyAlreadyRecorded(allergy) && addAllergyFromIPS(allergy.id)">
                  <div class="item-header">
                    <mat-icon class="add-icon" *ngIf="linkedPatient && !isAllergyAlreadyRecorded(allergy)">
                      {{ isAllergyAdded(allergy.id) ? 'check_circle' : 'add_circle_outline' }}
                    </mat-icon>
                    <mat-icon class="add-icon recorded-icon" *ngIf="linkedPatient && isAllergyAlreadyRecorded(allergy)">
                      verified
                    </mat-icon>
                    <span class="item-title">{{ ipsReaderService.getAllergyDisplay(allergy) }}</span>
                    <span class="item-status severity-{{ allergy.criticality || 'unknown' }}" *ngIf="!isAllergyAlreadyRecorded(allergy)">
                      {{ ipsReaderService.getAllergySeverity(allergy) }}
                    </span>
                    <span class="already-recorded-badge" *ngIf="linkedPatient && isAllergyAlreadyRecorded(allergy)">Already Recorded</span>
                  </div>
                  <div class="item-details">
                    <span *ngIf="allergy.onsetDateTime" class="detail-item">
                      <mat-icon>schedule</mat-icon>
                      Onset: {{ allergy.onsetDateTime | date:'short' }}
                    </span>
                    <span *ngIf="allergy.recordedDate" class="detail-item">
                      <mat-icon>edit</mat-icon>
                      Recorded: {{ allergy.recordedDate | date:'short' }}
                    </span>
                    <div *ngIf="ipsReaderService.getAllergyReactions(allergy).length > 0" class="reactions">
                      <strong>Reactions:</strong>
                      <span *ngFor="let reaction of ipsReaderService.getAllergyReactions(allergy)" class="reaction-tag">
                        {{ reaction }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div class="right-section">
          <!-- Allergies Merge Controls -->
          <mat-card class="merge-controls-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>merge_type</mat-icon>
                Allergies Merge
                <span class="selection-count" *ngIf="linkedPatient">({{ selectedAllergies.size }}/{{ patientData?.allergies?.length || 0 }} selected)</span>
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="!linkedPatient" class="link-required-message">
                <mat-icon>info</mat-icon>
                <span>Please link to a patient first to enable merge controls</span>
              </div>
              
              <div *ngIf="linkedPatient" class="merge-controls">
                <p class="merge-hint" *ngIf="hasAvailableAllergies()">
                  <mat-icon>info</mat-icon>
                  Click on allergies in the left panel to add them here
                </p>

                <!-- All items already recorded message -->
                <p class="all-recorded-message" *ngIf="!hasAvailableAllergies() && existingAllergies.length > 0">
                  <mat-icon>check_circle</mat-icon>
                  All IPS allergies are already recorded
                </p>

                <!-- Selected IPS Allergies (New - shown first) -->
                <div class="conditions-section" *ngIf="getSelectedIPSAllergies().length > 0">
                  <div class="section-header new-conditions-header">
                    <mat-icon>new_label</mat-icon>
                    <span>New from IPS ({{ getSelectedIPSAllergies().length }})</span>
                  </div>
                  <div class="item-list">
                    <div *ngFor="let allergy of getSelectedIPSAllergies()" class="item-row new-item">
                      <mat-icon class="status-icon">add_circle</mat-icon>
                      <div class="item-content">
                        <div class="item-title">{{ ipsReaderService.getAllergyDisplay(allergy) }}</div>
                        <div class="item-details">
                          <span class="item-status severity-{{ allergy.criticality || 'unknown' }}">
                            {{ ipsReaderService.getAllergySeverity(allergy) }}
                          </span>
                          <span *ngIf="allergy.recordedDate" class="item-date">{{ allergy.recordedDate | date:'short' }}</span>
                        </div>
                      </div>
                      <button mat-icon-button (click)="addAllergyFromIPS(allergy.id)" class="remove-btn">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Existing Patient Allergies -->
                <div class="conditions-section" *ngIf="existingAllergies.length > 0">
                  <div class="section-header existing-conditions-header">
                    <mat-icon>article</mat-icon>
                    <span>Existing Allergies ({{ existingAllergies.length }})</span>
                  </div>
                  <div class="item-list">
                    <div *ngFor="let allergy of existingAllergies" class="item-row existing-item">
                      <mat-icon class="status-icon">check</mat-icon>
                      <div class="item-content">
                        <div class="item-title">{{ ipsReaderService.getAllergyDisplay(allergy) }}</div>
                        <div class="item-details">
                          <span class="item-status severity-{{ allergy.criticality || 'unknown' }}">
                            {{ ipsReaderService.getAllergySeverity(allergy) }}
                          </span>
                          <span *ngIf="allergy.recordedDate" class="item-date">{{ allergy.recordedDate | date:'short' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Empty state -->
                <div class="empty-state" *ngIf="getSelectedIPSAllergies().length === 0 && existingAllergies.length === 0">
                  <mat-icon>inbox</mat-icon>
                  <p>No allergies yet. Click on allergies from the left to add them.</p>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>

    <!-- Single Save Button Section -->
    <div *ngIf="!isLoading && !error && hasPatientData() && linkedPatient" class="save-section">
      <div class="save-container">
        <div class="save-summary">
          <h3>Ready to Import</h3>
          <div class="save-stats">
            <div class="save-stat" *ngIf="selectedConditions.size > 0">
              <mat-icon>medical_services</mat-icon>
              <span>{{ selectedConditions.size }} Conditions</span>
            </div>
            <div class="save-stat" *ngIf="selectedProcedures.size > 0">
              <mat-icon>local_hospital</mat-icon>
              <span>{{ selectedProcedures.size }} Procedures</span>
            </div>
            <div class="save-stat" *ngIf="selectedMedications.size > 0">
              <mat-icon>medication</mat-icon>
              <span>{{ selectedMedications.size }} Medications</span>
            </div>
            <div class="save-stat" *ngIf="selectedAllergies.size > 0">
              <mat-icon>warning</mat-icon>
              <span>{{ selectedAllergies.size }} Allergies</span>
            </div>
          </div>
        </div>
        
        <div class="save-actions">
          <button 
            mat-raised-button 
            color="primary" 
            (click)="importAllSelectedItems()"
            [disabled]="!hasSelectedItems()"
            class="save-button">
            <mat-icon>save</mat-icon>
            Save All Selected Items ({{ getTotalSelectedCount() }})
          </button>
        </div>
      </div>
    </div>

    <!-- Welcome/Empty State -->
    <div *ngIf="!isLoading && !error && !hasPatientData()" class="welcome-container">
      <div class="welcome-content">
        <div class="welcome-icon">
          <mat-icon>integration_instructions</mat-icon>
        </div>
        <h2>Welcome to the Interoperability Demo</h2>
        <p class="welcome-description">
          This demo showcases how SNOMED CT and FHIR IPS (International Patient Summary) work together 
          to enable seamless healthcare data interoperability. Upload your own IPS file or try our example 
          to see how patient data can be imported and linked to existing records.
        </p>
        
        <div class="welcome-features">
          <div class="feature-item">
            <mat-icon>medical_services</mat-icon>
            <span>Import clinical conditions, procedures, and medications</span>
          </div>
          <div class="feature-item">
            <mat-icon>link</mat-icon>
            <span>Automatically link to existing patient records</span>
          </div>
          <div class="feature-item">
            <mat-icon>verified_user</mat-icon>
            <span>Detect and resolve potential data duplicates</span>
          </div>
          <div class="feature-item">
            <mat-icon>science</mat-icon>
            <span>Imported data will be available in the Demo EHR</span>
          </div>
        </div>
        
        <div class="welcome-actions">
          <button mat-raised-button color="primary" (click)="loadExampleIPSBundle()" class="primary-action">
            <mat-icon>play_arrow</mat-icon>
            Try Example IPS Bundle
          </button>
          <button mat-stroked-button color="accent" (click)="triggerFileUpload()" class="secondary-action">
            <mat-icon>upload_file</mat-icon>
            Upload Your Own IPS File
          </button>
        </div>
        
        <div class="welcome-info">
          <mat-icon>info</mat-icon>
          <span>The example demonstrates a complete patient summary with conditions, procedures, medications, and allergies.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Verification Dialog -->
  <div *ngIf="showDataVerification" class="verification-overlay">
    <div class="verification-dialog">
      <div class="verification-header">
        <h2>
          <mat-icon>verified_user</mat-icon>
          Data Import Verification
        </h2>
        <button mat-icon-button (click)="cancelImport()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="verification-content">
        <div class="patient-info-section">
          <h3>Importing to: {{ getPatientDisplayName(linkedPatient) }}</h3>
          <p>Review the data comparison below before proceeding with the import.</p>
        </div>

        <!-- Data Summary -->
        <div class="data-summary">
          <div class="summary-card">
            <h4>IPS Data Available</h4>
            <div class="summary-stats">
              <div class="stat-item">
                <mat-icon>medical_services</mat-icon>
                <span>{{ importSummary?.ipsData?.conditions || 0 }} Conditions</span>
              </div>
              <div class="stat-item">
                <mat-icon>local_hospital</mat-icon>
                <span>{{ importSummary?.ipsData?.procedures || 0 }} Procedures</span>
              </div>
              <div class="stat-item">
                <mat-icon>medication</mat-icon>
                <span>{{ importSummary?.ipsData?.medications || 0 }} Medications</span>
              </div>
              <div class="stat-item">
                <mat-icon>warning</mat-icon>
                <span>{{ importSummary?.ipsData?.allergies || 0 }} Allergies</span>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <h4>Existing Patient Data</h4>
            <div class="summary-stats">
              <div class="stat-item">
                <mat-icon>medical_services</mat-icon>
                <span>{{ importSummary?.existingData?.conditions || 0 }} Conditions</span>
              </div>
              <div class="stat-item">
                <mat-icon>local_hospital</mat-icon>
                <span>{{ importSummary?.existingData?.procedures || 0 }} Procedures</span>
              </div>
              <div class="stat-item">
                <mat-icon>medication</mat-icon>
                <span>{{ importSummary?.existingData?.medications || 0 }} Medications</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Individual Item Selection -->
        <div class="item-selection">
          <h4>
            <mat-icon>checklist</mat-icon>
            Select Items to Import
          </h4>
          <p>Choose which items you want to import to the patient record.</p>

          <!-- Conditions -->
          <div *ngIf="patientData && patientData.conditions && patientData.conditions.length > 0" class="category-section">
            <div class="category-header">
              <h5>
                <mat-icon>medical_services</mat-icon>
                Conditions ({{ selectedConditions.size }}/{{ patientData.conditions.length }} selected)
              </h5>
              <div class="category-actions">
                <button mat-button (click)="selectAllConditions()" class="select-all-btn">
                  <mat-icon>select_all</mat-icon>
                  Select All
                </button>
                <button mat-button (click)="deselectAllConditions()" class="deselect-all-btn">
                  <mat-icon>deselect</mat-icon>
                  Deselect All
                </button>
              </div>
            </div>
            <div class="item-list">
              <div *ngFor="let condition of patientData?.conditions || []" class="item-row">
                <mat-checkbox 
                  [checked]="selectedConditions.has(condition.id)"
                  (change)="toggleConditionSelection(condition.id)"
                  class="item-checkbox">
                </mat-checkbox>
                <div class="item-content">
                  <div class="item-title">{{ ipsReaderService.getConditionDisplay(condition) }}</div>
                  <div class="item-details">
                    <span class="item-status">{{ condition.clinicalStatus?.coding?.[0]?.display || condition.clinicalStatus?.coding?.[0]?.code || 'Unknown status' }}</span>
                    <span *ngIf="condition.onsetDateTime" class="item-date">{{ condition.onsetDateTime | date:'short' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Procedures -->
          <div *ngIf="patientData && patientData.procedures && patientData.procedures.length > 0" class="category-section">
            <div class="category-header">
              <h5>
                <mat-icon>local_hospital</mat-icon>
                Procedures ({{ selectedProcedures.size }}/{{ patientData.procedures.length }} selected)
              </h5>
              <div class="category-actions">
                <button mat-button (click)="selectAllProcedures()" class="select-all-btn">
                  <mat-icon>select_all</mat-icon>
                  Select All
                </button>
                <button mat-button (click)="deselectAllProcedures()" class="deselect-all-btn">
                  <mat-icon>deselect</mat-icon>
                  Deselect All
                </button>
              </div>
            </div>
            <div class="item-list">
              <div *ngFor="let procedure of patientData?.procedures || []" class="item-row">
                <mat-checkbox 
                  [checked]="selectedProcedures.has(procedure.id)"
                  (change)="toggleProcedureSelection(procedure.id)"
                  class="item-checkbox">
                </mat-checkbox>
                <div class="item-content">
                  <div class="item-title">{{ ipsReaderService.getProcedureDisplay(procedure) }}</div>
                  <div class="item-details">
                    <span class="item-status">{{ procedure.status }}</span>
                    <span *ngIf="procedure.performedDateTime" class="item-date">{{ procedure.performedDateTime | date:'short' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Medications -->
          <div *ngIf="patientData && patientData.medications && patientData.medications.length > 0" class="category-section">
            <div class="category-header">
              <h5>
                <mat-icon>medication</mat-icon>
                Medications ({{ selectedMedications.size }}/{{ patientData.medications.length }} selected)
              </h5>
              <div class="category-actions">
                <button mat-button (click)="selectAllMedications()" class="select-all-btn">
                  <mat-icon>select_all</mat-icon>
                  Select All
                </button>
                <button mat-button (click)="deselectAllMedications()" class="deselect-all-btn">
                  <mat-icon>deselect</mat-icon>
                  Deselect All
                </button>
              </div>
            </div>
            <div class="item-list">
              <div *ngFor="let medication of patientData?.medications || []" class="item-row">
                <mat-checkbox 
                  [checked]="selectedMedications.has(medication.id)"
                  (change)="toggleMedicationSelection(medication.id)"
                  class="item-checkbox">
                </mat-checkbox>
                <div class="item-content">
                  <div class="item-title">{{ ipsReaderService.getMedicationDisplay(medication) }}</div>
                  <div class="item-details">
                    <span class="item-status">{{ medication.status }}</span>
                    <span *ngIf="medication.effectiveDateTime" class="item-date">{{ medication.effectiveDateTime | date:'short' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Allergies -->
          <div *ngIf="patientData && patientData.allergies && patientData.allergies.length > 0" class="category-section">
            <div class="category-header">
              <h5>
                <mat-icon>warning</mat-icon>
                Allergies ({{ selectedAllergies.size }}/{{ patientData.allergies.length }} selected)
              </h5>
              <div class="category-actions">
                <button mat-button (click)="selectAllAllergies()" class="select-all-btn">
                  <mat-icon>select_all</mat-icon>
                  Select All
                </button>
                <button mat-button (click)="deselectAllAllergies()" class="deselect-all-btn">
                  <mat-icon>deselect</mat-icon>
                  Deselect All
                </button>
              </div>
            </div>
            <div class="item-list">
              <div *ngFor="let allergy of patientData?.allergies || []" class="item-row">
                <mat-checkbox 
                  [checked]="selectedAllergies.has(allergy.id)"
                  (change)="toggleAllergySelection(allergy.id)"
                  class="item-checkbox">
                </mat-checkbox>
                <div class="item-content">
                  <div class="item-title">{{ ipsReaderService.getAllergyDisplay(allergy) }}</div>
                  <div class="item-details">
                    <span class="item-status">{{ allergy.clinicalStatus?.coding?.[0]?.display || allergy.clinicalStatus?.coding?.[0]?.code || 'Unknown status' }}</span>
                    <span *ngIf="allergy.recordedDate" class="item-date">{{ allergy.recordedDate | date:'short' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Potential Duplicates -->
        <div *ngIf="importSummary?.potentialDuplicates" class="duplicates-section">
          <h4>
            <mat-icon>warning</mat-icon>
            Potential Duplicates Found
          </h4>
          
          <!-- Duplicate Conditions -->
          <div *ngIf="importSummary.potentialDuplicates.conditions.length > 0" class="duplicate-category">
            <h5>Conditions ({{ importSummary.potentialDuplicates.conditions.length }})</h5>
            <div class="duplicate-list">
              <div *ngFor="let duplicate of importSummary.potentialDuplicates.conditions" class="duplicate-item">
                <div class="duplicate-comparison">
                  <div class="ips-item">
                    <strong>IPS:</strong> {{ ipsReaderService.getConditionDisplay(duplicate.ips) }}
                  </div>
                  <div class="existing-item">
                    <strong>Existing:</strong> {{ ipsReaderService.getConditionDisplay(duplicate.existing) }}
                  </div>
                  <div class="similarity">
                    <mat-icon>compare_arrows</mat-icon>
                    {{ (duplicate.similarity * 100).toFixed(0) }}% similar
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Duplicate Procedures -->
          <div *ngIf="importSummary.potentialDuplicates.procedures.length > 0" class="duplicate-category">
            <h5>Procedures ({{ importSummary.potentialDuplicates.procedures.length }})</h5>
            <div class="duplicate-list">
              <div *ngFor="let duplicate of importSummary.potentialDuplicates.procedures" class="duplicate-item">
                <div class="duplicate-comparison">
                  <div class="ips-item">
                    <strong>IPS:</strong> {{ ipsReaderService.getProcedureDisplay(duplicate.ips) }}
                  </div>
                  <div class="existing-item">
                    <strong>Existing:</strong> {{ ipsReaderService.getProcedureDisplay(duplicate.existing) }}
                  </div>
                  <div class="similarity">
                    <mat-icon>compare_arrows</mat-icon>
                    {{ (duplicate.similarity * 100).toFixed(0) }}% similar
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Duplicate Medications -->
          <div *ngIf="importSummary.potentialDuplicates.medications.length > 0" class="duplicate-category">
            <h5>Medications ({{ importSummary.potentialDuplicates.medications.length }})</h5>
            <div class="duplicate-list">
              <div *ngFor="let duplicate of importSummary.potentialDuplicates.medications" class="duplicate-item">
                <div class="duplicate-comparison">
                  <div class="ips-item">
                    <strong>IPS:</strong> {{ ipsReaderService.getMedicationDisplay(duplicate.ips) }}
                  </div>
                  <div class="existing-item">
                    <strong>Existing:</strong> {{ ipsReaderService.getMedicationDisplay(duplicate.existing) }}
                  </div>
                  <div class="similarity">
                    <mat-icon>compare_arrows</mat-icon>
                    {{ (duplicate.similarity * 100).toFixed(0) }}% similar
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Duplicates Message -->
        <div *ngIf="!importSummary?.potentialDuplicates || 
                    (importSummary.potentialDuplicates.conditions.length === 0 && 
                     importSummary.potentialDuplicates.procedures.length === 0 && 
                     importSummary.potentialDuplicates.medications.length === 0)" 
             class="no-duplicates">
          <mat-icon class="success-icon">check_circle</mat-icon>
          <span>No potential duplicates found. Safe to proceed with import.</span>
        </div>
      </div>

      <div class="verification-actions">
        <button mat-flat-button (click)="cancelImport()">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>
        <button mat-flat-button color="primary" (click)="proceedWithImport()" [disabled]="!hasSelectedItems()">
          <mat-icon>file_download</mat-icon>
          Import Selected Items ({{ selectedConditions.size + selectedProcedures.size + selectedMedications.size + selectedAllergies.size }})
        </button>
      </div>
    </div>
  </div>
</div>
