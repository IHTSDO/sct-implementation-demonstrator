<div class="benefits-demo-container">
  <div class="header-section">
    <div class="header-content">
      <div class="header-text">
        <h1>SNOMED EHR Lab</h1>
        <p>A hands-on demo suite showing how to design clinical workflows that produce clean, connected, 
          computable data—ready for safety checks, analytics, and exchange. Powered by FHIR and SNOMED CT, 
          but framed around end-to-end information quality.</p>
      </div>
      <div class="header-actions">
        <button mat-button [matMenuTriggerFor]="dataMenu">
          <mat-icon>storage</mat-icon>
          <span>
            <span>Data</span>
            <mat-icon>arrow_drop_down</mat-icon>
          </span>
          
        </button>
        <mat-menu #dataMenu="matMenu">
          <button mat-menu-item (click)="downloadPatientsAsZip()">
            <mat-icon>download</mat-icon>
            <span>Download patient data</span>
          </button>
          <button mat-menu-item (click)="triggerFileUpload()">
            <mat-icon>upload</mat-icon>
            <span>Upload patient data</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="clearAllData()" class="danger-menu-item">
            <mat-icon>delete_sweep</mat-icon>
            <span>Clear all patient data</span>
          </button>
        </mat-menu>
        
        <!-- Hidden file input -->
        <input #fileInput type="file" accept=".zip" (change)="onFileSelected($event)" style="display: none;">
      </div>
    </div>
  </div>
  
  <div class="ehr-layout" *ngIf="!showAnalytics">
    <!-- Patient List Section -->
    <div class="patient-list-section">
      <div class="section-header">
        <h2>Patients</h2>
        <div class="patient-header-actions">
          <button 
            mat-flat-button
            color="accent"
            (click)="openAnalytics()"
            [disabled]="!hasAnalyticsData()"
          >
            <mat-icon>analytics</mat-icon>
            Analytics
          </button>
          <button 
            mat-flat-button
            color="primary"
            (click)="openInteroperability()"
          >
            <mat-icon>integration_instructions</mat-icon>
            Interoperability
          </button>
          <!-- <button 
            mat-flat-button
            color="warn"
            (click)="openIcd10Analytics()"
            [disabled]="!hasIcd10AnalyticsData()"
          >
            <mat-icon>medical_services</mat-icon>
            ICD-10 Analytics
          </button> -->
          <button mat-flat-button color="primary" [matMenuTriggerFor]="createPatientMenu">
            <mat-icon>person_add</mat-icon>
            <span>Create Patient</span>
            <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
          </button>
          <mat-menu #createPatientMenu="matMenu">
            <button mat-menu-item (click)="createNewPatient()">
              <mat-icon>edit</mat-icon>
              <span>Manual Entry</span>
            </button>
            <button mat-menu-item (click)="createRandomPatient()">
              <mat-icon>auto_awesome</mat-icon>
              <span>Generate Random</span>
            </button>
          </mat-menu>
        </div>
      </div>
      
      <div class="patient-list">
        <div 
          *ngFor="let patient of patients" 
          class="patient-card"
          [class.selected]="selectedPatient?.id === patient.id"
          (click)="selectPatient(patient)"
        >
          <div class="patient-info">
            <div class="patient-name">{{ getPatientDisplayName(patient) }}</div>
            <div class="patient-details">
              <span class="patient-id">ID: {{ getPatientIdentifier(patient) }}</span>
              <span class="patient-age" *ngIf="patient.birthDate">{{ getPatientAge(patient.birthDate) }}</span>
              <span class="patient-gender" *ngIf="patient.gender">{{ patient.gender }}</span>
            </div>
            <div class="patient-contact" *ngIf="patient.telecom && patient.telecom.length > 0">
              <span *ngFor="let contact of patient.telecom">
                {{ contact.system }}: {{ contact.value }}
              </span>
            </div>
          </div>
          <div class="patient-status">
            <span class="status-indicator" [class.active]="patient.active">●</span>
          </div>
        </div>
        
        <div *ngIf="patients.length === 0" class="no-patients">
          <p>No patients found. Create a new patient or upload patient data to get started.</p>
        </div>
      </div>
    </div>

    <!-- Selected Patient Details Section -->
    <div class="patient-details-section">
      <div class="section-header">
        <h2>Selected Patient</h2>
        <div class="header-actions" *ngIf="selectedPatient">
          <button 
            mat-flat-button
            color="accent"
            (click)="openClinicalRecord()"
          >
            Open Clinical Record
          </button>
        </div>
      </div>
      
      <div *ngIf="selectedPatient" class="selected-patient-details">
        <div class="patient-header">
          <h3>{{ getPatientDisplayName(selectedPatient) }}</h3>
          <div class="patient-meta">
            <span class="patient-id">ID: {{ getPatientIdentifier(selectedPatient) }}</span>
            <span class="patient-age" *ngIf="selectedPatient.birthDate">{{ getPatientAge(selectedPatient.birthDate) }}</span>
            <span class="patient-gender" *ngIf="selectedPatient.gender">{{ selectedPatient.gender }}</span>
          </div>
        </div>
        
        <div class="patient-details-grid">
          <div class="detail-group" *ngIf="selectedPatient.telecom && selectedPatient.telecom.length > 0">
            <h4>Contact Information</h4>
            <div class="contact-list">
              <div *ngFor="let contact of selectedPatient.telecom" class="contact-item">
                <span class="contact-type">{{ contact.system }}:</span>
                <span class="contact-value">{{ contact.value }}</span>
                <span class="contact-use" *ngIf="contact.use">({{ contact.use }})</span>
              </div>
            </div>
          </div>
          
          <div class="detail-group" *ngIf="selectedPatient.address && selectedPatient.address.length > 0">
            <h4>Address</h4>
            <div class="address-list">
              <div *ngFor="let address of selectedPatient.address" class="address-item">
                <div *ngFor="let line of address.line">{{ line }}</div>
                <div>{{ address.city }}, {{ address.state }} {{ address.postalCode }}</div>
                <div>{{ address.country }}</div>
              </div>
            </div>
          </div>
          
          <div class="detail-group" *ngIf="selectedPatient.birthDate">
            <h4>Demographics</h4>
            <div class="demographics">
              <div class="demographic-item">
                <span class="label">Birth Date:</span>
                <span class="value">{{ selectedPatient.birthDate | date:'longDate' }}</span>
              </div>
              <div class="demographic-item">
                <span class="label">Age:</span>
                <span class="value">{{ getPatientAge(selectedPatient.birthDate) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="!selectedPatient" class="no-selection">
        <p>Select a patient from the list to view details.</p>
      </div>
    </div>


  </div>

  <!-- Analytics Section - Full Width -->
  <div class="analytics-full-width" *ngIf="showAnalytics">
    <div class="analytics-section">
      <div class="section-header">
        <h2>{{ analyticsMode === 'icd10' ? 'ICD-10 Analytics' : 'Clinical Data Analytics' }}</h2>
        <div class="header-actions">
          <button 
            mat-flat-button 
            color="primary"
            (click)="closeAnalytics()">
            <mat-icon>arrow_back</mat-icon>
            Back to Patients
          </button>
        </div>
      </div>
      <div class="analytics-container">
        <app-plotly-treemap-chart 
          [useBrowserStorage]="true" 
          [useIcd10Filtering]="analyticsMode === 'icd10'">
        </app-plotly-treemap-chart>
      </div>
    </div>
  </div>
</div>
