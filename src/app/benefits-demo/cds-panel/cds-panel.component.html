<div class="cds-tab-container">
  <h3>Decision Support</h3>
  <p class="cds-description">
    Get medication order recommendations based on current patient conditions and medications using SNOMED CT Clinical Decision Support services.
  </p>
  
  <!-- CDS Status -->
  <div class="cds-status">
    <div *ngIf="!isCdsLoading && !cdsResponse && !cdsError && !cdsNoDataMessage" style="text-align: center; padding: 20px;">
      <button mat-raised-button color="primary" (click)="submitToCdsService()" [disabled]="isCdsLoading">
        Request Recommendations
      </button>
    </div>
    
    <div *ngIf="isCdsLoading" class="cds-loading">
      <mat-spinner diameter="24"></mat-spinner>
      <span>Requesting medication recommendations from CDS service...</span>
    </div>
    
    <div *ngIf="cdsNoDataMessage" style="text-align: center; padding: 30px; color: #666;">
      <mat-icon color="accent" style="font-size: 48px; width: 48px; height: 48px; margin-bottom: 16px;">info</mat-icon>
      <p style="margin: 0; font-size: 14px; line-height: 1.5;">{{ cdsNoDataMessage }}</p>
    </div>
    
    <div *ngIf="cdsError" class="cds-error">
      <mat-icon color="warn">error</mat-icon>
      <div class="error-content">
        <strong>Error:</strong>
        <span>{{ cdsError }}</span>
        <button mat-stroked-button color="primary" (click)="submitToCdsService()" style="margin-top: 8px;">
          Retry
        </button>
      </div>
    </div>
    
    <div *ngIf="cdsResponse && cdsResponse.cards && cdsResponse.cards.length > 0" class="cds-recommendations">
      <div class="recommendations-header">
        <mat-icon color="primary">lightbulb</mat-icon>
        <span>{{ cdsResponse.cards.length }} recommendation(s) received</span>
        <button mat-stroked-button color="primary" (click)="submitToCdsService()" [disabled]="isCdsLoading">
          Refresh
        </button>
      </div>
      <div class="cds-cards">
        <mat-card *ngFor="let card of cdsResponse.cards; let i = index" class="cds-card" [ngClass]="'indicator-' + card.indicator">
          <mat-card-header>
            <mat-card-title>
              <mat-icon [color]="getCardIconColor(card.indicator)">{{ getCardIcon(card.indicator) }}</mat-icon>
              {{ card.summary }}
            </mat-card-title>
            <mat-card-subtitle>{{ card.source.label }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content *ngIf="card.detail">
            <p>{{ card.detail }}</p>
          </mat-card-content>
          <mat-card-actions>
            <button mat-button *ngFor="let suggestion of card.suggestions" color="primary">
              {{ suggestion.label }}
            </button>
            <button mat-button 
                    *ngIf="card.source.url" 
                    color="accent"
                    (click)="openSourceUrl(card.source.url)"
                    title="View source">
              <mat-icon>open_in_new</mat-icon>
              View Source
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
    
    <div *ngIf="cdsResponse && (!cdsResponse.cards || cdsResponse.cards.length === 0)" class="cds-no-recommendations">
      <mat-icon color="accent">check_circle</mat-icon>
      <div class="no-recommendations-content">
        <strong>No specific recommendations</strong>
        <span>No medication order recommendations at this time based on current conditions and medications.</span>
        <button mat-stroked-button color="primary" (click)="submitToCdsService()" [disabled]="isCdsLoading" style="margin-top: 8px;">
          Refresh
        </button>
      </div>
    </div>
  </div>
</div>
