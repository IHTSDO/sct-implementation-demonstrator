<div class="clinical-entry-container">
  <button mat-flat-button color="primary" (click)="toggleAddForm()" class="add-button" *ngIf="!hideButton">
    <mat-icon>add</mat-icon>
    {{ sectionTitle }}
  </button>

  <div class="add-form" *ngIf="showAddForm">
    <div class="form-content">
      <div class="input-row">
        <div class="search-section">
          <app-autocomplete-binding 
            #autocompleteBinding
            [binding]="currentBinding" 
            [term]="term" 
            (selectionChange)="updateConcept($event)">
          </app-autocomplete-binding>
        </div>
        
        <!-- Association dropdown for medications -->
        <div class="association-section" *ngIf="entryType === 'medication' && (availableConditions.length > 0 || availableProcedures.length > 0)">
          <mat-form-field>
            <mat-label>Select the reason for the indication</mat-label>
            <mat-select [(value)]="selectedAssociation" [compareWith]="compareAssociations">
              <mat-option [value]="null">None - General medication</mat-option>
              <mat-optgroup label="Conditions" *ngIf="availableConditions.length > 0">
                <mat-option *ngFor="let condition of availableConditions" [value]="{type: 'condition', resource: condition}">
                  {{ condition.code.text }}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Procedures" *ngIf="availableProcedures.length > 0">
                <mat-option *ngFor="let procedure of availableProcedures" [value]="{type: 'procedure', resource: procedure}">
                  {{ procedure.code.text }}
                </mat-option>
              </mat-optgroup>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      
      <div class="action-section">
        <button mat-flat-button color="accent" (click)="addItem()" [disabled]="!selectedConcept || loading">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Add {{ entryType === 'medication' && selectedAssociation ? 'Associated ' : '' }}{{ sectionTitle.replace('Add ', '') }}</span>
        </button>
        <button mat-flat-button color="warn" (click)="toggleAddForm()" [disabled]="loading">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
