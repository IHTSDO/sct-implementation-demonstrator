<div class="clinical-entry-container">
  <button mat-flat-button color="primary" (click)="toggleAddForm()" class="add-button" *ngIf="!hideButton">
    <mat-icon>add</mat-icon>
    {{ sectionTitle }}
  </button>

  <div class="add-form" *ngIf="showAddForm">
    <div class="form-content">
      <div class="input-row">
        <div class="search-section">
          <div class="field-with-info">
            <app-autocomplete-binding 
              #autocompleteBinding
              [binding]="currentBinding" 
              [term]="term" 
              (selectionChange)="updateConcept($event)">
            </app-autocomplete-binding>
            <button mat-icon-button 
                    class="info-button"
                    [matMenuTriggerFor]="entryInfoMenu"
                    matTooltip="Click for more information about this field"
                    matTooltipPosition="above">
              <mat-icon>info_outline</mat-icon>
            </button>
          </div>
        </div>
        
        <!-- Association dropdown for medications -->
        <div class="association-section" *ngIf="entryType === 'medication' && (availableConditions.length > 0 || availableProcedures.length > 0)">
          <mat-form-field>
            <mat-label>Select the reason for the indication</mat-label>
            <mat-select [(value)]="selectedAssociation" [compareWith]="compareAssociations">
              <mat-option [value]="null">None - General medication</mat-option>
              <mat-optgroup label="Conditions" *ngIf="availableConditions.length > 0">
                <mat-option *ngFor="let condition of availableConditions" [value]="{type: 'condition', resource: condition}">
                  {{ condition.code.text }}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Procedures" *ngIf="availableProcedures.length > 0">
                <mat-option *ngFor="let procedure of availableProcedures" [value]="{type: 'procedure', resource: procedure}">
                  {{ procedure.code.text }}
                </mat-option>
              </mat-optgroup>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      
      <div class="action-section">
        <button mat-flat-button color="accent" (click)="addItem()" [disabled]="!selectedConcept || loading">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Add {{ entryType === 'medication' && selectedAssociation ? 'Associated ' : '' }}{{ sectionTitle.replace('Add ', '') }}</span>
        </button>
        <button mat-flat-button color="warn" (click)="toggleAddForm()" [disabled]="loading">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Info Menu for Clinical Entry -->
  <mat-menu #entryInfoMenu="matMenu" class="info-menu">
    <div class="info-popover" (click)="$event.stopPropagation()">
      <h3>{{ sectionTitle.replace('Add ', '') }} - Terminology Binding</h3>
      <p>
        This field uses SNOMED CT Expression Constraint Language (ECL) to retrieve options from a FHIR-based SNOMED CT terminology server.
      </p>
      <p>
        The ECL expression used for this binding is:
      </p>
      <p class="ecl-expression">
        <strong>{{ currentBinding.ecl }}</strong>
      </p>
      <p>
        Options are filtered based on user input and the field is implemented with an auto-complete component to limit user typing and improve the selection experience.
      </p>
      <p>
        If the terminology server supports it, returned results can be limited by using <strong>count=X</strong>. This may prevent the server from responding with a 'too costly' error and improve performance of the lookup and rendering.
      </p>
      <p *ngIf="entryType === 'medication' && (availableConditions.length > 0 || availableProcedures.length > 0)">
        <em>Note: You can associate this medication with an existing condition or procedure by selecting the reason for indication from the dropdown.</em>
      </p>
    </div>
  </mat-menu>
</div>
